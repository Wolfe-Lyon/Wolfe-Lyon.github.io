<!DOCTYPE html>
<html>
<head>
<title>Knight Tyme (48k): Routine at 27357</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../knight_tyme.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27352.html">27352</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27357">Map</a></td>
<td class="next">
Next: <a href="27508.html">27508</a>
</td>
</tr>
</table>
<div class="description">27357: Handle Magic Knight's falls</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="27136.html">27136</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27357"></span>27357</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27358"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="27352.html">27352</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27358"></span>27358</td>
<td class="instruction">LD (27393),A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27361"></span>27361</td>
<td class="instruction">LD HL,37087</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at end of table of y-velocities sequence for jumping and falling</td>
</tr>
<tr>
<td class="address-1"><span id="27364"></span>27364</td>
<td class="instruction">LD (37072),HL</td>
<td class="comment-1" rowspan="1">Store current position at <a href="37072.html">37072</a></td>
</tr>
<tr>
<td class="address-2"><span id="27367"></span>27367</td>
<td class="instruction">LD A,(23474)</td>
<td class="comment-1" rowspan="1">If Magic Knight's movement flags are reset...</td>
</tr>
<tr>
<td class="address-1"><span id="27370"></span>27370</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27371"></span>27371</td>
<td class="instruction">JR Z,27377</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27357.html#27377">27377</a></td>
</tr>
<tr>
<td class="address-1"><span id="27373"></span>27373</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27374"></span>27374</td>
<td class="instruction">LD (27393),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="27377"></span>27377</td>
<td class="instruction">LD HL,(37072)</td>
<td class="comment-1" rowspan="1">Load current position in y-velocities table into <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="27380"></span>27380</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load current y-velocity from table into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27381"></span>27381</td>
<td class="instruction">CP 7</td>
<td class="comment-1" rowspan="1">If velocity is 7...</td>
</tr>
<tr>
<td class="address-1"><span id="27383"></span>27383</td>
<td class="instruction">JR Z,27389</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27357.html#27389">27389</a></td>
</tr>
<tr>
<td class="address-1"><span id="27385"></span>27385</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Step pointer back one byte in y-velocities table</td>
</tr>
<tr>
<td class="address-1"><span id="27386"></span>27386</td>
<td class="instruction">LD (37072),HL</td>
<td class="comment-1" rowspan="1">Store pointer</td>
</tr>
<tr>
<td class="address-2"><span id="27389"></span>27389</td>
<td class="instruction">LD (25161),A</td>
<td class="comment-1" rowspan="1">Load last y-velocity read from table into Magic Knight's y-velocity</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27392"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="27357.html#27392">27392</a> represents the x-velocity value stored previously. This is modified by the instructions at <a href="27357.html#27358">27358</a>, <a href="27357.html#27374">27374</a> and <a href="27357.html#27502">27502</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27392"></span>27392</td>
<td class="instruction">LD A,0</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x-velocity...</td>
</tr>
<tr>
<td class="address-1"><span id="27394"></span>27394</td>
<td class="instruction">LD (25160),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27397"></span>27397</td>
<td class="instruction">LD A,(25156)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current x-coordinate (pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="27400"></span>27400</td>
<td class="instruction">ADD A,4</td>
<td class="comment-1" rowspan="1">Add 4 to x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="27402"></span>27402</td>
<td class="instruction">CALL <a href="28625.html">28625</a></td>
<td class="comment-1" rowspan="1">Divide x-coordinate by eight, rounding down to nearest integer</td>
</tr>
<tr>
<td class="address-1"><span id="27405"></span>27405</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Load result (Magic Knight's x-coordinate in characters) into <span class="register">C</span>, setting <span class="register">B</span> to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27406"></span>27406</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27408"></span>27408</td>
<td class="instruction">LD A,(25157)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current y-coordinate (pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="27411"></span>27411</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1">If y-coordinate is a multiple of eight...</td>
</tr>
<tr>
<td class="address-1"><span id="27413"></span>27413</td>
<td class="instruction">JR Z,27417</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27357.html#27417">27417</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27415"></span>
<div class="comments">
<div class="paragraph">
y-coordinate is not a multiple of eight
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27415"></span>27415</td>
<td class="instruction">LD B,8</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to 8, as we need to look one character block lower due to Magic Knight spanning five, rather than four, characters</td>
</tr>
<tr>
<td class="address-2"><span id="27417"></span>27417</td>
<td class="instruction">LD A,(25157)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current y-coordinate (pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="27420"></span>27420</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="1">Add <span class="register">B</span> to current y-coordinate (i.e. y-coordinate of highest full character block spanned by Magic Knight)</td>
</tr>
<tr>
<td class="address-1"><span id="27421"></span>27421</td>
<td class="instruction">ADD A,32</td>
<td class="comment-1" rowspan="1">Add 32 (as Magic Knight is 32 pixels high, so now y-coordinate of highest full character block not occupied by Magic Knight)</td>
</tr>
<tr>
<td class="address-1"><span id="27423"></span>27423</td>
<td class="instruction">CALL <a href="28625.html">28625</a></td>
<td class="comment-1" rowspan="1">Divide <span class="register">A</span> by eight, rounding down to nearest integer</td>
</tr>
<tr>
<td class="address-1"><span id="27426"></span>27426</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Load result (y-coordinate in characters) into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="27427"></span>27427</td>
<td class="instruction">CALL <a href="54162.html">54162</a></td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at terrain interaction data for character coordinates x=<span class="register">C</span>, y=<span class="register">B</span> (block that Magic Knight is "falling through")</td>
</tr>
<tr>
<td class="address-1"><span id="27430"></span>27430</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">If this block, or the one to the right of it cannot be passed vertically (downwards)...</td>
</tr>
<tr>
<td class="address-1"><span id="27431"></span>27431</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...(i.e. Magic Knight has landed)...</td>
</tr>
<tr>
<td class="address-1"><span id="27432"></span>27432</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27433"></span>27433</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27435"></span>27435</td>
<td class="instruction">JR NZ,27476</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27357.html#27476">27476</a></td>
</tr>
<tr>
<td class="address-1"><span id="27437"></span>27437</td>
<td class="instruction">CALL <a href="27508.html">27508</a></td>
<td class="comment-1" rowspan="1">Kill Magic Knight's x-velocity if he cannot horizontally pass through a block beside him</td>
</tr>
<tr>
<td class="address-1"><span id="27440"></span>27440</td>
<td class="instruction">LD A,(25160)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's x-velocity into <span class="register">B</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27443"></span>27443</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27444"></span>27444</td>
<td class="instruction">LD A,(23474)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's movement flags into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27447"></span>27447</td>
<td class="instruction">XOR B</td>
<td class="comment-1" rowspan="1">Check:</td>
</tr>
<tr>
<td class="address-1"><span id="27448"></span>27448</td>
<td class="instruction">CP 255</td>
<td class="comment-1" rowspan="1">If x-velocity is -2 (left), and Magic Knight can't move left...</td>
</tr>
<tr>
<td class="address-1"><span id="27450"></span>27450</td>
<td class="instruction">JP Z,27498</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27357.html#27498">27498</a></td>
</tr>
<tr>
<td class="address-1"><span id="27453"></span>27453</td>
<td class="instruction">CP 253</td>
<td class="comment-1" rowspan="1">If x-velocity is -2 (left), and Magic Knight can't move left or right...</td>
</tr>
<tr>
<td class="address-1"><span id="27455"></span>27455</td>
<td class="instruction">JP Z,27498</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27357.html#27498">27498</a></td>
</tr>
<tr>
<td class="address-1"><span id="27458"></span>27458</td>
<td class="instruction">CP 1</td>
<td class="comment-1" rowspan="1">If x-velocity is +2 (right), and Magic Knight can't move left or right...</td>
</tr>
<tr>
<td class="address-1"><span id="27460"></span>27460</td>
<td class="instruction">JP Z,27498</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27357.html#27498">27498</a></td>
</tr>
<tr>
<td class="address-1"><span id="27463"></span>27463</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If x-velocity is +2 (right), and Magic Knight can't move right...</td>
</tr>
<tr>
<td class="address-1"><span id="27464"></span>27464</td>
<td class="instruction">JP Z,27498</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27357.html#27498">27498</a></td>
</tr>
<tr>
<td class="address-2"><span id="27467"></span>27467</td>
<td class="instruction">CALL <a href="53115.html">53115</a></td>
<td class="comment-1" rowspan="1">Erase Magic Knight from display, advance his current position then redraw</td>
</tr>
<tr>
<td class="address-1"><span id="27470"></span>27470</td>
<td class="instruction">CALL <a href="28457.html">28457</a></td>
<td class="comment-1" rowspan="1">Set Magic Knight's velocity to zero, if appropriate move to new room, execute room-specific routine</td>
</tr>
<tr>
<td class="address-1"><span id="27473"></span>27473</td>
<td class="instruction">JP 27367</td>
<td class="comment-1" rowspan="1">Loop back to <a href="27357.html#27367">27367</a></td>
</tr>
<tr>
<td class="address-2"><span id="27476"></span>27476</td>
<td class="instruction">LD A,(25157)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current y-coordinate (pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="27479"></span>27479</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1">Retain only pixel-within-character component (e.g. 5 pixels down the pair of character blocks)</td>
</tr>
<tr>
<td class="address-1"><span id="27481"></span>27481</td>
<td class="instruction">NEG</td>
<td class="comment-1" rowspan="1">Negate (i.e. -5 pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="27483"></span>27483</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1">Retain only pixel-within-character component (e.g. 3 pixels up the pair of character blocks, or 3 pixels down to the ground)</td>
</tr>
<tr>
<td class="address-1"><span id="27485"></span>27485</td>
<td class="instruction">LD (25161),A</td>
<td class="comment-1" rowspan="1">Set Magic Knight's y-velocity so that it will take his feet to the ground</td>
</tr>
<tr>
<td class="address-1"><span id="27488"></span>27488</td>
<td class="instruction">CALL <a href="53115.html">53115</a></td>
<td class="comment-1" rowspan="1">Erase Magic Knight from display, advance his current position then redraw</td>
</tr>
<tr>
<td class="address-1"><span id="27491"></span>27491</td>
<td class="instruction">LD HL,0</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x- and y-velocities to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27494"></span>27494</td>
<td class="instruction">LD (25160),HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27497"></span>27497</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return (Magic Knight has landed)</td>
</tr>
<tr>
<td class="address-2"><span id="27498"></span>27498</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x-velocity to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27499"></span>27499</td>
<td class="instruction">LD (25160),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27502"></span>27502</td>
<td class="instruction">LD (27393),A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to zero</td>
</tr>
<tr>
<td class="address-1"><span id="27505"></span>27505</td>
<td class="instruction">JP 27467</td>
<td class="comment-1" rowspan="1">Loop back to <a href="27357.html#27467">27467</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27352.html">27352</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27357">Map</a></td>
<td class="next">
Next: <a href="27508.html">27508</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Knight Tyme (48k) RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1986 David Jones / Mastertronic (Knight Tyme). &#169; 2013-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>