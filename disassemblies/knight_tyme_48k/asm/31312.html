<!DOCTYPE html>
<html>
<head>
<title>Knight Tyme (48k): Routine at 31312</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../knight_tyme.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="31280.html">31280</a>
</td>
<td class="up">Up: <a href="../maps/all.html#31312">Map</a></td>
<td class="next">
Next: <a href="31468.html">31468</a>
</td>
</tr>
</table>
<div class="description">31312: Cast Lightning Bolt if possible, otherwise display failure message</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="55726.html">55726</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="31312"></span>31312</td>
<td class="instruction">LD A,(25024)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current magic level into <span class="register">A</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="31315"></span>31315</td>
<td class="instruction">AND 127</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31317"></span>31317</td>
<td class="instruction">CP 65</td>
<td class="comment-1" rowspan="1">If this is less than 65...</td>
</tr>
<tr>
<td class="address-1"><span id="31319"></span>31319</td>
<td class="instruction">JP C,<a href="55332.html">55332</a></td>
<td class="comment-1" rowspan="1">...then display "YOU CANNOT CAST THAT SPELL NOW..." window (10) and return to game</td>
</tr>
<tr>
<td class="address-1"><span id="31322"></span>31322</td>
<td class="instruction">SUB 65</td>
<td class="comment-1" rowspan="1">Subtract 65 from magic level...</td>
</tr>
<tr>
<td class="address-1"><span id="31324"></span>31324</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="31325"></span>31325</td>
<td class="instruction">LD A,(25024)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with unused bit...</td>
</tr>
<tr>
<td class="address-1"><span id="31328"></span>31328</td>
<td class="instruction">AND 128</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31330"></span>31330</td>
<td class="instruction">OR B</td>
<td class="comment-1" rowspan="1">...combine with remaining magic level value...</td>
</tr>
<tr>
<td class="address-1"><span id="31331"></span>31331</td>
<td class="instruction">LD (25024),A</td>
<td class="comment-1" rowspan="1">...and store</td>
</tr>
<tr>
<td class="address-1"><span id="31334"></span>31334</td>
<td class="instruction">CALL <a href="55651.html">55651</a></td>
<td class="comment-1" rowspan="1">Flash border and screen (as in cast a spell)</td>
</tr>
<tr>
<td class="address-1"><span id="31337"></span>31337</td>
<td class="instruction">LD HL,46894</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "YOUR LIGHTNING BOLT HAS ALERTED THE SECURITY SYSTEM..." text</td>
</tr>
<tr>
<td class="address-1"><span id="31340"></span>31340</td>
<td class="instruction">LD A,(23701)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current room</td>
</tr>
<tr>
<td class="address-1"><span id="31343"></span>31343</td>
<td class="instruction">CP 7</td>
<td class="comment-1" rowspan="1">If Magic Knight's current room is Retreat, 0, "Murphy's Moon" (07)...</td>
</tr>
<tr>
<td class="address-1"><span id="31345"></span>31345</td>
<td class="instruction">JP Z,<a href="55685.html">55685</a></td>
<td class="comment-1" rowspan="1">...then jump to "game over" window routine and return to control selection menu</td>
</tr>
<tr>
<td class="address-1"><span id="31348"></span>31348</td>
<td class="instruction">CP 8</td>
<td class="comment-1" rowspan="1">If Magic Knight's current room is Retreat, 1 (08)...</td>
</tr>
<tr>
<td class="address-1"><span id="31350"></span>31350</td>
<td class="instruction">JP Z,<a href="55685.html">55685</a></td>
<td class="comment-1" rowspan="1">...then jump to "game over" window routine and return to control selection menu</td>
</tr>
<tr>
<td class="address-1"><span id="31353"></span>31353</td>
<td class="instruction">CP 21</td>
<td class="comment-1" rowspan="1">If Magic Knight's current room is Monopole, 0, "Hooper's Emergency Exit" (21)...</td>
</tr>
<tr>
<td class="address-1"><span id="31355"></span>31355</td>
<td class="instruction">JP Z,<a href="55685.html">55685</a></td>
<td class="comment-1" rowspan="1">...then jump to "game over" window routine and return to control selection menu</td>
</tr>
<tr>
<td class="address-1"><span id="31358"></span>31358</td>
<td class="instruction">CP 22</td>
<td class="comment-1" rowspan="1">If Magic Knight's current room is Monopole, 1, "This Way to Hooper ==&gt;&gt;" (22)...</td>
</tr>
<tr>
<td class="address-1"><span id="31360"></span>31360</td>
<td class="instruction">JP Z,<a href="55685.html">55685</a></td>
<td class="comment-1" rowspan="1">...then jump to "game over" window routine and return to control selection menu</td>
</tr>
<tr>
<td class="address-1"><span id="31363"></span>31363</td>
<td class="instruction">CP 24</td>
<td class="comment-1" rowspan="1">If Magic Knight's current room is not USS Pisces, 6A, "The Control Column" (24)...</td>
</tr>
<tr>
<td class="address-1"><span id="31365"></span>31365</td>
<td class="instruction">JR NZ,31392</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="31312.html#31392">31392</a></td>
</tr>
<tr>
<td class="address-1"><span id="31367"></span>31367</td>
<td class="instruction">LD A,(23403)</td>
<td class="comment-1" rowspan="1">If tyme-machine-charged flag is set...</td>
</tr>
<tr>
<td class="address-1"><span id="31370"></span>31370</td>
<td class="instruction">AND 2</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31372"></span>31372</td>
<td class="instruction">JR NZ,31392</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="31312.html#31392">31392</a></td>
</tr>
<tr>
<td class="address-1"><span id="31374"></span>31374</td>
<td class="instruction">OR 3</td>
<td class="comment-1" rowspan="1">Set tyme-machine-charged and barriers-removed flags... (<a href="../reference/bugs.html#extra_flag_set">bug</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="31376"></span>31376</td>
<td class="instruction">LD (23403),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31379"></span>31379</td>
<td class="instruction">LD A,(23397)</td>
<td class="comment-1" rowspan="1">Increase bonus score by 10...</td>
</tr>
<tr>
<td class="address-1"><span id="31382"></span>31382</td>
<td class="instruction">ADD A,10</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31384"></span>31384</td>
<td class="instruction">LD (23397),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31387"></span>31387</td>
<td class="instruction">LD HL,46682</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "YOUR LIGHTNING BOLT HAS HIT THE ANCIENT TYME MACHINE..." text</td>
</tr>
<tr>
<td class="address-1"><span id="31390"></span>31390</td>
<td class="instruction">JR 31449</td>
<td class="comment-1" rowspan="1">Display text in message window and return to main game loop</td>
</tr>
<tr>
<td class="address-2"><span id="31392"></span>31392</td>
<td class="instruction">LD HL,46598</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "YOU HAVE THROWN A LIGHTNING BOLT BUT..." text</td>
</tr>
<tr>
<td class="address-1"><span id="31395"></span>31395</td>
<td class="instruction">LD A,(23701)</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="31398"></span>31398</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31399"></span>31399</td>
<td class="instruction">LD A,(25340)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with current room of Part of a Sundial (1)...</td>
</tr>
<tr>
<td class="address-1"><span id="31402"></span>31402</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">...and if this is not the same as Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="31403"></span>31403</td>
<td class="instruction">JR NZ,31449</td>
<td class="comment-1" rowspan="1">...then display text in message window and return to main game loop</td>
</tr>
<tr>
<td class="address-1"><span id="31405"></span>31405</td>
<td class="instruction">LD A,(25343)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with current room of Part of a Sundial (2)...</td>
</tr>
<tr>
<td class="address-1"><span id="31408"></span>31408</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">...and if this is not the same as Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="31409"></span>31409</td>
<td class="instruction">JR NZ,31449</td>
<td class="comment-1" rowspan="1">...then display text in message window and return to main game loop</td>
</tr>
<tr>
<td class="address-1"><span id="31411"></span>31411</td>
<td class="instruction">LD A,(25346)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with current room of Part of a Sundial (3)...</td>
</tr>
<tr>
<td class="address-1"><span id="31414"></span>31414</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">...and if this is not the same as Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="31415"></span>31415</td>
<td class="instruction">JR NZ,31449</td>
<td class="comment-1" rowspan="1">...then display text in message window and return to main game loop</td>
</tr>
<tr>
<td class="address-1"><span id="31417"></span>31417</td>
<td class="instruction">LD A,99</td>
<td class="comment-1" rowspan="1">Set current room of three sundial parts to 99 (i.e. out of game area)...</td>
</tr>
<tr>
<td class="address-1"><span id="31419"></span>31419</td>
<td class="instruction">LD (25340),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31422"></span>31422</td>
<td class="instruction">LD (25343),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31425"></span>31425</td>
<td class="instruction">LD (25346),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31428"></span>31428</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="31429"></span>31429</td>
<td class="instruction">LD (25325),A</td>
<td class="comment-1" rowspan="1">...and set this as the current room of the Golden Sundial of Alpha</td>
</tr>
<tr>
<td class="address-1"><span id="31432"></span>31432</td>
<td class="instruction">LD HL,(25344)</td>
<td class="comment-1" rowspan="1">Copy x- and y-coordinates of Part of a Sundial (2)...</td>
</tr>
<tr>
<td class="address-1"><span id="31435"></span>31435</td>
<td class="instruction">LD (25326),HL</td>
<td class="comment-1" rowspan="1">...to Golden Sundial of Alpha</td>
</tr>
<tr>
<td class="address-1"><span id="31438"></span>31438</td>
<td class="instruction">LD A,(23397)</td>
<td class="comment-1" rowspan="1">Increase bonus score by 10...</td>
</tr>
<tr>
<td class="address-1"><span id="31441"></span>31441</td>
<td class="instruction">ADD A,10</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31443"></span>31443</td>
<td class="instruction">LD (23397),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31446"></span>31446</td>
<td class="instruction">LD HL,46804</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "THE SEGMENTS OF THE GOLDEN SUNDIAL OF ALPHA..." text</td>
</tr>
<tr>
<td class="address-2"><span id="31449"></span>31449</td>
<td class="instruction">LD DE,37323</td>
<td class="comment-1" rowspan="1">Adjust height of window 29 to accommodate text...</td>
</tr>
<tr>
<td class="address-1"><span id="31452"></span>31452</td>
<td class="instruction">CALL <a href="33774.html">33774</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31455"></span>31455</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span> (pointer to start of text to print)</td>
</tr>
<tr>
<td class="address-1"><span id="31456"></span>31456</td>
<td class="instruction">LD A,29</td>
<td class="comment-1" rowspan="1">Draw window 29...</td>
</tr>
<tr>
<td class="address-1"><span id="31458"></span>31458</td>
<td class="instruction">CALL <a href="34990.html">34990</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="31461"></span>31461</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (pointer to start of text to print)...</td>
</tr>
<tr>
<td class="address-1"><span id="31462"></span>31462</td>
<td class="instruction">CALL <a href="34762.html">34762</a></td>
<td class="comment-1" rowspan="1">...and print</td>
</tr>
<tr>
<td class="address-1"><span id="31465"></span>31465</td>
<td class="instruction">JP <a href="29330.html#29479">29479</a></td>
<td class="comment-1" rowspan="1">Display "PRESS FIRE TO CONTINUE" window and wait for input and return to main game loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="31280.html">31280</a>
</td>
<td class="up">Up: <a href="../maps/all.html#31312">Map</a></td>
<td class="next">
Next: <a href="31468.html">31468</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Knight Tyme (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1986 David Jones / Mastertronic (Knight Tyme). &#169; 2013-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>