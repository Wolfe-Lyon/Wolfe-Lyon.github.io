<!DOCTYPE html>
<html>
<head>
<title>Knight Tyme (48k): Routine at 53278</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../knight_tyme.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="53185.html">53185</a>
</td>
<td class="up">Up: <a href="../maps/all.html#53278">Map</a></td>
<td class="next">
Next: <a href="53329.html">53329</a>
</td>
</tr>
</table>
<div class="description">53278: Restore background attribute data at Magic Knight's current location</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="53115.html">53115</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="53278"></span>53278</td>
<td class="instruction">LD DE,24037</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at table of background attribute data</td>
</tr>
<tr>
<td class="address-1"><span id="53281"></span>53281</td>
<td class="instruction">LD A,(25157)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current y-coordinate (pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="53284"></span>53284</td>
<td class="instruction">AND 248</td>
<td class="comment-1" rowspan="1">Clear lowest three bits to round down to nearest multiple of 8</td>
</tr>
<tr>
<td class="address-1"><span id="53286"></span>53286</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Load this value into <span class="register">HL</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="53287"></span>53287</td>
<td class="instruction">LD H,0</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="53289"></span>53289</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-1" rowspan="1">Multiply by four to obtain 32 &times; y-coordinate (characters)...</td>
</tr>
<tr>
<td class="address-1"><span id="53290"></span>53290</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="53291"></span>53291</td>
<td class="instruction">LD A,(25156)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current x-coordinate (pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="53294"></span>53294</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">Divide this by eight, rounding down to nearest integer...</td>
</tr>
<tr>
<td class="address-1"><span id="53295"></span>53295</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">...to convert from pixels to characters...</td>
</tr>
<tr>
<td class="address-1"><span id="53296"></span>53296</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="53297"></span>53297</td>
<td class="instruction">AND 31</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="53299"></span>53299</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Load x-coordinate (characters) into <span class="register">BC</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="53300"></span>53300</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="53302"></span>53302</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add x-coordinate to 32 &times; y-coordinate in <span class="register">HL</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="53303"></span>53303</td>
<td class="instruction">LD BC,22528</td>
<td class="comment-1" rowspan="1">...then add this to start address of attribute file...</td>
</tr>
<tr>
<td class="address-1"><span id="53306"></span>53306</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">...so that <span class="register">HL</span> points to required byte in attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="53307"></span>53307</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 4 as Magic Knight is four characters tall</td>
</tr>
<tr>
<td class="address-2"><span id="53309"></span>53309</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (<span class="register">B</span> = remaining number of character rows)</td>
</tr>
<tr>
<td class="address-1"><span id="53310"></span>53310</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Copy byte from table of background attribute data...</td>
</tr>
<tr>
<td class="address-1"><span id="53311"></span>53311</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...into attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="53312"></span>53312</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance current position in attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="53313"></span>53313</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Advance current position in table of background attribute data</td>
</tr>
<tr>
<td class="address-1"><span id="53314"></span>53314</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Copy byte from table of background attribute data...</td>
</tr>
<tr>
<td class="address-1"><span id="53315"></span>53315</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...into attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="53316"></span>53316</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance current position in attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="53317"></span>53317</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Advance current position in table of background attribute data</td>
</tr>
<tr>
<td class="address-1"><span id="53318"></span>53318</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1">Copy byte from table of background attribute data...</td>
</tr>
<tr>
<td class="address-1"><span id="53319"></span>53319</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...into attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="53320"></span>53320</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Advance current position in table of background attribute data</td>
</tr>
<tr>
<td class="address-1"><span id="53321"></span>53321</td>
<td class="instruction">LD BC,30</td>
<td class="comment-1" rowspan="1">Advance current position in attribute file by 30 bytes...</td>
</tr>
<tr>
<td class="address-1"><span id="53324"></span>53324</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">...i.e. down one character and left two characters</td>
</tr>
<tr>
<td class="address-1"><span id="53325"></span>53325</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (<span class="register">B</span> = remaining number of character rows)</td>
</tr>
<tr>
<td class="address-1"><span id="53326"></span>53326</td>
<td class="instruction">DJNZ 53309</td>
<td class="comment-1" rowspan="1">If character rows to be coloured remain then loop back to <a href="53278.html#53309">53309</a></td>
</tr>
<tr>
<td class="address-1"><span id="53328"></span>53328</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="53185.html">53185</a>
</td>
<td class="up">Up: <a href="../maps/all.html#53278">Map</a></td>
<td class="next">
Next: <a href="53329.html">53329</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Knight Tyme (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1986 David Jones / Mastertronic (Knight Tyme). &#169; 2013-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>