<!DOCTYPE html>
<html>
<head>
<title>Knight Tyme (48k): Routine at 28172</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../knight_tyme.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="28101.html">28101</a>
</td>
<td class="up">Up: <a href="../maps/all.html#28172">Map</a></td>
<td class="next">
Next: <a href="28264.html">28264</a>
</td>
</tr>
</table>
<div class="description">28172: Print Magic Knight's current room's name at top of screen</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The room name bar displayed on the 7th character row defaults to an attribute value of 71 as per the instruction at <a href="28172.html">28172</a>. However in cases where the current room has a name record defined in the table at <a href="42765.html">42765</a>, the attribute defined in that record will override this default attribute. Therefore, the default attribute is only visible in rooms without names.
</div>
<div class="paragraph">
Used by the routine at <a href="28101.html">28101</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="28172"></span>28172</td>
<td class="instruction">LD A,71</td>
<td class="comment-1" rowspan="1">Store 71 (white INK, black PAPER, BRIGHT) at <a href="23694.html#23695">23695</a>...</td>
</tr>
<tr>
<td class="address-1"><span id="28174"></span>28174</td>
<td class="instruction">LD (23695),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="28177"></span>28177</td>
<td class="instruction">LD HL,16576</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with display file address corresponding to (0, 6) (characters)...</td>
</tr>
<tr>
<td class="address-1"><span id="28180"></span>28180</td>
<td class="instruction">LD (54110),HL</td>
<td class="comment-1" rowspan="1">...and move bitmap virtual text cursor here</td>
</tr>
<tr>
<td class="address-1"><span id="28183"></span>28183</td>
<td class="instruction">LD HL,32</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> (repeat counter) with 32</td>
</tr>
<tr>
<td class="address-1"><span id="28186"></span>28186</td>
<td class="instruction">LD A,93</td>
<td class="comment-1" rowspan="1">Set character to be repeated to 93 (body of "room name bar")...</td>
</tr>
<tr>
<td class="address-1"><span id="28188"></span>28188</td>
<td class="instruction">LD (54235),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="28191"></span>28191</td>
<td class="instruction">CALL <a href="54231.html">54231</a></td>
<td class="comment-1" rowspan="1">Print the character 32 times across width of screen</td>
</tr>
<tr>
<td class="address-1"><span id="28194"></span>28194</td>
<td class="instruction">LD HL,42765</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of table of room names</td>
</tr>
<tr>
<td class="address-1"><span id="28197"></span>28197</td>
<td class="instruction">LD A,(23701)</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="28200"></span>28200</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="28201"></span>28201</td>
<td class="instruction">CALL <a href="54266.html#54269">54269</a></td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to name entry for Magic Knight's current room</td>
</tr>
<tr>
<td class="address-1"><span id="28204"></span>28204</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load first value (attribute) into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="28205"></span>28205</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If attribute value is zero (i.e. no room name defined)...</td>
</tr>
<tr>
<td class="address-1"><span id="28206"></span>28206</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-1"><span id="28207"></span>28207</td>
<td class="instruction">LD (23695),A</td>
<td class="comment-1" rowspan="1">Store required attribute value at <a href="23694.html#23695">23695</a></td>
</tr>
<tr>
<td class="address-1"><span id="28210"></span>28210</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to string length data...</td>
</tr>
<tr>
<td class="address-1"><span id="28211"></span>28211</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="28212"></span>28212</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to first byte of string</td>
</tr>
<tr>
<td class="address-1"><span id="28213"></span>28213</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span> (pointer to first byte of room name string)</td>
</tr>
<tr>
<td class="address-1"><span id="28214"></span>28214</td>
<td class="instruction">ADD A,4</td>
<td class="comment-1" rowspan="1">Add 4 to the string's length to accommodate space, and "bar cap" characters (chars. 35 and 36) before and after...</td>
</tr>
<tr>
<td class="address-1"><span id="28216"></span>28216</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...and load value into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="28217"></span>28217</td>
<td class="instruction">LD A,32</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with width of screen (characters) minus length of room name string, spaces and bar caps...</td>
</tr>
<tr>
<td class="address-1"><span id="28219"></span>28219</td>
<td class="instruction">SUB B</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="28220"></span>28220</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">Divide value by two...</td>
</tr>
<tr>
<td class="address-1"><span id="28221"></span>28221</td>
<td class="instruction">AND 31</td>
<td class="comment-1" rowspan="1">...and cap at 31</td>
</tr>
<tr>
<td class="address-1"><span id="28223"></span>28223</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Load this value (length of one half of room name bar) into <span class="register">BC</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="28224"></span>28224</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="28226"></span>28226</td>
<td class="instruction">LD HL,16576</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at top pixel row of character block at coordinates (0, 6)</td>
</tr>
<tr>
<td class="address-1"><span id="28229"></span>28229</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add value in <span class="register">BC</span> as offset...</td>
</tr>
<tr>
<td class="address-1"><span id="28230"></span>28230</td>
<td class="instruction">LD (54110),HL</td>
<td class="comment-1" rowspan="1">...and load this address into bitmap virtual text cursor</td>
</tr>
<tr>
<td class="address-1"><span id="28233"></span>28233</td>
<td class="instruction">LD HL,22720</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at attribute file address for character coordinates (0, 6)</td>
</tr>
<tr>
<td class="address-1"><span id="28236"></span>28236</td>
<td class="instruction">LD DE,22721</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at attribute file address for character coordinates (1, 6)</td>
</tr>
<tr>
<td class="address-1"><span id="28239"></span>28239</td>
<td class="instruction">LD BC,31</td>
<td class="comment-1" rowspan="1">Set repeat count to 31</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28242"></span>
<div class="comments">
<div class="paragraph">
The value at <a href="23694.html#23695">23695</a> is initially 71 (as set by instruction at <a href="28172.html#28174">28174</a>) and may have been changed to a new value as specified in room name entry in table at <a href="42765.html">42765</a>
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="28242"></span>28242</td>
<td class="instruction">LD A,(23695)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with attribute stored at <a href="23694.html#23695">23695</a></td>
</tr>
<tr>
<td class="address-1"><span id="28245"></span>28245</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Fill entire row in attribute file with this attribute value...</td>
</tr>
<tr>
<td class="address-1"><span id="28246"></span>28246</td>
<td class="instruction">LDIR</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="28248"></span>28248</td>
<td class="instruction">LD HL,42160</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at text code for SPACE followed by room name bar end cap (right)</td>
</tr>
<tr>
<td class="address-1"><span id="28251"></span>28251</td>
<td class="instruction">CALL <a href="34733.html">34733</a></td>
<td class="comment-1" rowspan="1">Print text at location <span class="register">HL</span> to screen using full screen width</td>
</tr>
<tr>
<td class="address-1"><span id="28254"></span>28254</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (pointer to first byte of room name string)</td>
</tr>
<tr>
<td class="address-1"><span id="28255"></span>28255</td>
<td class="instruction">CALL <a href="34733.html">34733</a></td>
<td class="comment-1" rowspan="1">Print text at location <span class="register">HL</span> to screen using full screen width</td>
</tr>
<tr>
<td class="address-1"><span id="28258"></span>28258</td>
<td class="instruction">LD HL,42163</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at text code for room name bar end cap (left) followed by SPACE</td>
</tr>
<tr>
<td class="address-1"><span id="28261"></span>28261</td>
<td class="instruction">JP <a href="34733.html">34733</a></td>
<td class="comment-1" rowspan="1">Print text at location <span class="register">HL</span> to screen using full screen width and return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="28101.html">28101</a>
</td>
<td class="up">Up: <a href="../maps/all.html#28172">Map</a></td>
<td class="next">
Next: <a href="28264.html">28264</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Knight Tyme (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1986 David Jones / Mastertronic (Knight Tyme). &#169; 2013-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>