<!DOCTYPE html>
<html>
<head>
<title>Knight Tyme (48k): Routine at 54647</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../knight_tyme.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54598.html">54598</a>
</td>
<td class="up">Up: <a href="../maps/all.html#54647">Map</a></td>
<td class="next">
Next: <a href="54876.html">54876</a>
</td>
</tr>
</table>
<div class="description">54647: Redefine keyboard controls</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="26745.html">26745</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54647"></span>54647</td>
<td class="instruction">CALL <a href="54598.html">54598</a></td>
<td class="comment-1" rowspan="1">Print current control keys to screen</td>
</tr>
<tr>
<td class="address-1"><span id="54650"></span>54650</td>
<td class="instruction">CALL <a href="54575.html">54575</a></td>
<td class="comment-1" rowspan="1">If key-press was enqueued then load <span class="register">A</span> with index of last key pressed, otherwise wait for key-press and load <span class="register">A</span> with index</td>
</tr>
<tr>
<td class="address-1"><span id="54653"></span>54653</td>
<td class="instruction">CP 13</td>
<td class="comment-1" rowspan="1">If key pressed was 13 (ENTER)...</td>
</tr>
<tr>
<td class="address-1"><span id="54655"></span>54655</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-1"><span id="54656"></span>54656</td>
<td class="instruction">LD (54576),A</td>
<td class="comment-1" rowspan="1">Set enqueued key index to index of key pressed</td>
</tr>
<tr>
<td class="address-1"><span id="54659"></span>54659</td>
<td class="instruction">LD B,5</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 5 (as there are five controls)</td>
</tr>
<tr>
<td class="address-1"><span id="54661"></span>54661</td>
<td class="instruction">LD HL,54894</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of list of current keyboard control characters</td>
</tr>
<tr>
<td class="address-2"><span id="54664"></span>54664</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-1" rowspan="1">Set current keyboard control character to zero</td>
</tr>
<tr>
<td class="address-1"><span id="54666"></span>54666</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance to next keyboard control character</td>
</tr>
<tr>
<td class="address-1"><span id="54667"></span>54667</td>
<td class="instruction">DJNZ 54664</td>
<td class="comment-1" rowspan="1">Decrease <span class="register">B</span> (remaining number of keyboard control characters to clear) and loop back to <a href="54647.html#54664">54664</a> if not zero</td>
</tr>
<tr>
<td class="address-1"><span id="54669"></span>54669</td>
<td class="instruction">LD BC,1280</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 5 and <span class="register">C</span> with zero</td>
</tr>
<tr>
<td class="address-1"><span id="54672"></span>54672</td>
<td class="instruction">LD HL,54894</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of list of current keyboard control characters</td>
</tr>
<tr>
<td class="address-2"><span id="54675"></span>54675</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (<span class="register">B</span> = remaining number of controls to define, <span class="register">C</span> = number of controls defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54676"></span>54676</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span> (current position in list of keyboard control characters)</td>
</tr>
<tr>
<td class="address-1"><span id="54677"></span>54677</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Load number of controls defined (0, 1, 2, 3 or 4) into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="54678"></span>54678</td>
<td class="instruction">AND 6</td>
<td class="comment-1" rowspan="1">Reset all but bits 1 and 2 (to give 0, 2 or 4)</td>
</tr>
<tr>
<td class="address-1"><span id="54680"></span>54680</td>
<td class="instruction">ADD A,6</td>
<td class="comment-1" rowspan="1">Add 6 (to give 6, 8 or 10, the y-coordinates in characters of displayed keyboard controls)...</td>
</tr>
<tr>
<td class="address-1"><span id="54682"></span>54682</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="54683"></span>54683</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with number of controls defined (0, 1, 2, 3 or 4)</td>
</tr>
<tr>
<td class="address-1"><span id="54684"></span>54684</td>
<td class="instruction">AND 1</td>
<td class="comment-1" rowspan="1">Reset all but bit 0 (to give 0 or 1)</td>
</tr>
<tr>
<td class="address-1"><span id="54686"></span>54686</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Store <span class="register">AF</span> (<span class="register">A</span> = bit 0 of number of controls defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54687"></span>54687</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">Double <span class="register">A</span> (to give 0 or 2)...</td>
</tr>
<tr>
<td class="address-1"><span id="54688"></span>54688</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="54689"></span>54689</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span> (<span class="register">A</span> = bit 0 of number of controls defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54690"></span>54690</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Store <span class="register">AF</span> (<span class="register">A</span> = bit 0 of number of controls defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54691"></span>54691</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1">Add <span class="register">C</span> to <span class="register">A</span> (to give 0 or 3)</td>
</tr>
<tr>
<td class="address-1"><span id="54692"></span>54692</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">Multiply <span class="register">A</span> by four...</td>
</tr>
<tr>
<td class="address-1"><span id="54693"></span>54693</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...to give 0 or 12...</td>
</tr>
<tr>
<td class="address-1"><span id="54694"></span>54694</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="54695"></span>54695</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span> (<span class="register">A</span> = bit 0 of number of controls defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54696"></span>54696</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1">Add value in <span class="register">C</span> to <span class="register">A</span> (to give 0 or 13)</td>
</tr>
<tr>
<td class="address-1"><span id="54697"></span>54697</td>
<td class="instruction">ADD A,5</td>
<td class="comment-1" rowspan="1">Add 5 (to give 5 or 18, the x-coordinates in characters of displayed keyboard controls)...</td>
</tr>
<tr>
<td class="address-1"><span id="54699"></span>54699</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="54700"></span>54700</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (coordinates in characters of current control being defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54701"></span>54701</td>
<td class="instruction">CALL <a href="54148.html">54148</a></td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with attribute file address for coordinates (<span class="register">C</span>, <span class="register">B</span>)...</td>
</tr>
<tr>
<td class="address-1"><span id="54704"></span>54704</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">...and set the FLASH flag for this address...</td>
</tr>
<tr>
<td class="address-1"><span id="54705"></span>54705</td>
<td class="instruction">OR 128</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54707"></span>54707</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="54708"></span>54708</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (coordinates in characters of current control being defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54709"></span>54709</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (coordinates in characters of current control being defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54710"></span>54710</td>
<td class="instruction">CALL <a href="54132.html">54132</a></td>
<td class="comment-1" rowspan="1">Move virtual cursor (bitmap) to display file address for coordinates x=<span class="register">C</span>, y=<span class="register">B</span> and load address into <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="54713"></span>54713</td>
<td class="instruction">CALL <a href="54575.html">54575</a></td>
<td class="comment-1" rowspan="1">If key-press was enqueued then load <span class="register">A</span> with index of last key pressed, otherwise wait for key-press and load <span class="register">A</span> with index</td>
</tr>
<tr>
<td class="address-1"><span id="54716"></span>54716</td>
<td class="instruction">CP 32</td>
<td class="comment-1" rowspan="1">If key pressed was SPACE...</td>
</tr>
<tr>
<td class="address-1"><span id="54718"></span>54718</td>
<td class="instruction">JP Z,54744</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="54647.html#54744">54744</a></td>
</tr>
<tr>
<td class="address-1"><span id="54721"></span>54721</td>
<td class="instruction">CP 48</td>
<td class="comment-1" rowspan="1">If index of key pressed is less than 48 (i.e. below "0")...</td>
</tr>
<tr>
<td class="address-1"><span id="54723"></span>54723</td>
<td class="instruction">JP M,54708</td>
<td class="comment-1" rowspan="1">...then jump back to <a href="54647.html#54708">54708</a> (i.e. wait for next key press and try again)</td>
</tr>
<tr>
<td class="address-1"><span id="54726"></span>54726</td>
<td class="instruction">CP 91</td>
<td class="comment-1" rowspan="1">If index of key pressed is 91 or higher (i.e. above "Z")...</td>
</tr>
<tr>
<td class="address-1"><span id="54728"></span>54728</td>
<td class="instruction">JP P,54708</td>
<td class="comment-1" rowspan="1">...then jump back to <a href="54647.html#54708">54708</a> (i.e. wait for next key press and try again)</td>
</tr>
<tr>
<td class="address-1"><span id="54731"></span>54731</td>
<td class="instruction">CP 58</td>
<td class="comment-1" rowspan="1">If index of key pressed is less than 58 (i.e. "9" or below)...</td>
</tr>
<tr>
<td class="address-1"><span id="54733"></span>54733</td>
<td class="instruction">JP M,54744</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="54647.html#54744">54744</a></td>
</tr>
<tr>
<td class="address-1"><span id="54736"></span>54736</td>
<td class="instruction">CP 65</td>
<td class="comment-1" rowspan="1">If index of key pressed is 65 or higher (i.e. "A" or above)...</td>
</tr>
<tr>
<td class="address-1"><span id="54738"></span>54738</td>
<td class="instruction">JP P,54744</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="54647.html#54744">54744</a></td>
</tr>
<tr>
<td class="address-1"><span id="54741"></span>54741</td>
<td class="instruction">JP 54708</td>
<td class="comment-1" rowspan="1">Jump back to <a href="54647.html#54708">54708</a> (i.e. wait for next key press and try again)</td>
</tr>
<tr>
<td class="address-2"><span id="54744"></span>54744</td>
<td class="instruction">CALL <a href="54876.html">54876</a></td>
<td class="comment-1" rowspan="1">Set zero flag if key pressed is already assigned to a control, otherwise reset</td>
</tr>
<tr>
<td class="address-1"><span id="54747"></span>54747</td>
<td class="instruction">JP Z,54708</td>
<td class="comment-1" rowspan="1">If key pressed is already assigned then jump back to <a href="54647.html#54708">54708</a> (i.e. wait for next key press and try again)</td>
</tr>
<tr>
<td class="address-1"><span id="54750"></span>54750</td>
<td class="instruction">LD (23398),A</td>
<td class="comment-1" rowspan="1">Store pressed key index at <a href="23397.html#23398">23398</a></td>
</tr>
<tr>
<td class="address-1"><span id="54753"></span>54753</td>
<td class="instruction">CP 32</td>
<td class="comment-1" rowspan="1">If key was not SPACE...</td>
</tr>
<tr>
<td class="address-1"><span id="54755"></span>54755</td>
<td class="instruction">JR NZ,54759</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="54647.html#54759">54759</a></td>
</tr>
<tr>
<td class="address-1"><span id="54757"></span>54757</td>
<td class="instruction">LD A,127</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with 127 (index in character set of "SP" UDG at <a href="64756.html#65516">65516</a>)</td>
</tr>
<tr>
<td class="address-2"><span id="54759"></span>54759</td>
<td class="instruction">CALL <a href="54097.html">54097</a></td>
<td class="comment-1" rowspan="1">Print text character in <span class="register">A</span> and advance bitmap virtual text cursor</td>
</tr>
<tr>
<td class="address-1"><span id="54762"></span>54762</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (coordinates in characters of current control being defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54763"></span>54763</td>
<td class="instruction">CALL <a href="54148.html">54148</a></td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with attribute file address for coordinates (<span class="register">C</span>, <span class="register">B</span>)...</td>
</tr>
<tr>
<td class="address-1"><span id="54766"></span>54766</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">...and reset the FLASH flag for this address...</td>
</tr>
<tr>
<td class="address-1"><span id="54767"></span>54767</td>
<td class="instruction">AND 127</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54769"></span>54769</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54770"></span>54770</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (current position in list of keyboard control characters)</td>
</tr>
<tr>
<td class="address-1"><span id="54771"></span>54771</td>
<td class="instruction">LD A,(23398)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with index of previously defined key...</td>
</tr>
<tr>
<td class="address-1"><span id="54774"></span>54774</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...and store in list of keyboard control characters</td>
</tr>
<tr>
<td class="address-1"><span id="54775"></span>54775</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to next entry in list of keyboard control characters</td>
</tr>
<tr>
<td class="address-1"><span id="54776"></span>54776</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (<span class="register">B</span> = remaining number of controls to define, <span class="register">C</span> = number of controls defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54777"></span>54777</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Increase <span class="register">C</span> (number of controls defined)</td>
</tr>
<tr>
<td class="address-1"><span id="54778"></span>54778</td>
<td class="instruction">DJNZ 54675</td>
<td class="comment-1" rowspan="1">Decrease <span class="register">B</span> (remaining number of controls to define) and loop back to <a href="54647.html#54675">54675</a> if not zero</td>
</tr>
<tr>
<td class="address-1"><span id="54780"></span>54780</td>
<td class="instruction">LD B,5</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 5 (as each keyboard half-row holds five keys)</td>
</tr>
<tr>
<td class="address-1"><span id="54782"></span>54782</td>
<td class="instruction">LD HL,54953</td>
<td class="comment-1" rowspan="1">Store address of operand of instruction at <a href="54950.html#54952">54953</a> (MSB of "input address" for keyboard half-row reading for LEFT)...</td>
</tr>
<tr>
<td class="address-1"><span id="54785"></span>54785</td>
<td class="instruction">LD (23398),HL</td>
<td class="comment-1" rowspan="1">...at <a href="23397.html#23398">23398</a></td>
</tr>
<tr>
<td class="address-1"><span id="54788"></span>54788</td>
<td class="instruction">LD HL,54894</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of list of current keyboard control characters</td>
</tr>
<tr>
<td class="address-2"><span id="54791"></span>54791</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (<span class="register">B</span> = remaining number of control keys to check)</td>
</tr>
<tr>
<td class="address-1"><span id="54792"></span>54792</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span> (pointer to current position in list of current keyboard control characters)</td>
</tr>
<tr>
<td class="address-1"><span id="54793"></span>54793</td>
<td class="instruction">LD IX,54902</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> at lists of characters on each keyboard half-row</td>
</tr>
<tr>
<td class="address-1"><span id="54797"></span>54797</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with current keyboard control character index</td>
</tr>
<tr>
<td class="address-1"><span id="54798"></span>54798</td>
<td class="instruction">LD C,0</td>
<td class="comment-1" rowspan="1">Set <span class="register">C</span> (index in list of half-rows) to zero</td>
</tr>
<tr>
<td class="address-2"><span id="54800"></span>54800</td>
<td class="instruction">CP (IX+0)</td>
<td class="comment-1" rowspan="1">If current keyboard control character index is the same as the current character in keyboard half-row groups...</td>
</tr>
<tr>
<td class="address-1"><span id="54803"></span>54803</td>
<td class="instruction">JR Z,54810</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="54647.html#54810">54810</a></td>
</tr>
<tr>
<td class="address-1"><span id="54805"></span>54805</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Increase <span class="register">C</span> (index in list of half-rows)</td>
</tr>
<tr>
<td class="address-1"><span id="54806"></span>54806</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Advance to next entry in list of half-rows</td>
</tr>
<tr>
<td class="address-1"><span id="54808"></span>54808</td>
<td class="instruction">JR 54800</td>
<td class="comment-1" rowspan="1">Loop back to <a href="54647.html#54800">54800</a></td>
</tr>
<tr>
<td class="address-2"><span id="54810"></span>54810</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with index of current control key in list of half-rows</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54811"></span>
<div class="comments">
<div class="paragraph">
At this point we know the index of the current key in the list of half-rows. We now need to identify which half row it belongs to.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="54811"></span>54811</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> (keyboard half-row index) to zero</td>
</tr>
<tr>
<td class="address-2"><span id="54813"></span>54813</td>
<td class="instruction">SUB 5</td>
<td class="comment-1" rowspan="1">If index of key in current half-row is less than 5 (i.e. key is in the current half-row)...</td>
</tr>
<tr>
<td class="address-1"><span id="54815"></span>54815</td>
<td class="instruction">JP M,54821</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="54647.html#54821">54821</a></td>
</tr>
<tr>
<td class="address-1"><span id="54818"></span>54818</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Increase <span class="register">B</span> (keyboard half-row index)</td>
</tr>
<tr>
<td class="address-1"><span id="54819"></span>54819</td>
<td class="instruction">JR 54813</td>
<td class="comment-1" rowspan="1">Loop back to <a href="54647.html#54813">54813</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54821"></span>
<div class="comments">
<div class="paragraph">
The MSB in the "input address" for the various keyboard half-rows obeys the progression (254, 253, 251, 247, 239, 223, 191, 127).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="54821"></span>54821</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with index of keyboard half-row containing current key</td>
</tr>
<tr>
<td class="address-1"><span id="54822"></span>54822</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (<span class="register">B</span> = index of keyboard half-row, <span class="register">C</span> = index of key in list of half-rows)</td>
</tr>
<tr>
<td class="address-1"><span id="54823"></span>54823</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Increase <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="54824"></span>54824</td>
<td class="instruction">LD HL,128</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with 128</td>
</tr>
<tr>
<td class="address-2"><span id="54827"></span>54827</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-1" rowspan="1">Double value in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="54828"></span>54828</td>
<td class="instruction">DJNZ 54827</td>
<td class="comment-1" rowspan="1">Decrease <span class="register">B</span> (index of keyboard half-row) and loop back to <a href="54647.html#54827">54827</a> if not zero</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54830"></span>
<div class="comments">
<div class="paragraph">
<span class="register">HL</span> now contains the value (128 &times; 2<sup>n</sup>) where n is the (1-based) index of the relevant half-row. <span class="register">H</span> contains (2<sup>m</sup>, where m is the (zero-based) index of the relevant half-row.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="54830"></span>54830</td>
<td class="instruction">LD A,255</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with 255</td>
</tr>
<tr>
<td class="address-1"><span id="54832"></span>54832</td>
<td class="instruction">SUB H</td>
<td class="comment-1" rowspan="1">Subtract <span class="register">H</span> (2<sup>m</sup>) to give MSB of input address for relevant half-row</td>
</tr>
<tr>
<td class="address-1"><span id="54833"></span>54833</td>
<td class="instruction">LD HL,(23398)</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with address of operand of instruction to modify (<a href="54950.html#54952">54953</a>)...</td>
</tr>
<tr>
<td class="address-1"><span id="54836"></span>54836</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...and set operand to value in <span class="register">A</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="54837"></span>
<div class="comments">
<div class="paragraph">
Next we need to modify the second part of the opcode for the instruction that checks the set bit in <span class="register">A</span> to determine which key in the half-row was pressed. The range of opcode values are:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Opcode Value</th>
<th colspan="1" rowspan="1">Instruction</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">71</td>
<td class="" colspan="1" rowspan="1"><span class="instruction">BIT 0,A</span></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">79</td>
<td class="" colspan="1" rowspan="1"><span class="instruction">BIT 1,A</span></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">87</td>
<td class="" colspan="1" rowspan="1"><span class="instruction">BIT 2,A</span></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">95</td>
<td class="" colspan="1" rowspan="1"><span class="instruction">BIT 3,A</span></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">103</td>
<td class="" colspan="1" rowspan="1"><span class="instruction">BIT 4,A</span></td>
</tr>
</table>
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="54837"></span>54837</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> by four bytes to operand of instruction at <a href="54950.html#54956">54956</a>...</td>
</tr>
<tr>
<td class="address-1"><span id="54838"></span>54838</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54839"></span>54839</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54840"></span>54840</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54841"></span>54841</td>
<td class="instruction">LD (23398),HL</td>
<td class="comment-1" rowspan="1">...and store at <a href="23397.html#23398">23398</a></td>
</tr>
<tr>
<td class="address-1"><span id="54844"></span>54844</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (<span class="register">B</span> = index of keyboard half-row, <span class="register">C</span> = index of key in list of half-rows)</td>
</tr>
<tr>
<td class="address-1"><span id="54845"></span>54845</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with five times index of keyboard half-row (value currently in <span class="register">B</span>)...</td>
</tr>
<tr>
<td class="address-1"><span id="54846"></span>54846</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54847"></span>54847</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54848"></span>54848</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54849"></span>54849</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">... (<span class="register">B</span> is now 0, 5, 10, 15, 20, 25, 30 or 35)</td>
</tr>
<tr>
<td class="address-1"><span id="54850"></span>54850</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with index of key in list of half-rows...</td>
</tr>
<tr>
<td class="address-1"><span id="54851"></span>54851</td>
<td class="instruction">SUB B</td>
<td class="comment-1" rowspan="1">...and subtract <span class="register">B</span> (5 times index of half-row) to give index of key within current half-row</td>
</tr>
<tr>
<td class="address-1"><span id="54852"></span>54852</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">Multiply this index by 8 (opcode interval between successive <span class="instruction">BIT n,A</span> and <span class="instruction">BIT n+1,A</span> instructions)...</td>
</tr>
<tr>
<td class="address-1"><span id="54853"></span>54853</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54854"></span>54854</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54855"></span>54855</td>
<td class="instruction">ADD A,71</td>
<td class="comment-1" rowspan="1">...and add 71 (opcode for <span class="instruction">BIT 0,A</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="54857"></span>54857</td>
<td class="instruction">LD HL,(23398)</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with address of operand / opcode for <span class="instruction">BIT n,A</span> instruction...</td>
</tr>
<tr>
<td class="address-1"><span id="54860"></span>54860</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...and set "n" accordingly</td>
</tr>
<tr>
<td class="address-1"><span id="54861"></span>54861</td>
<td class="instruction">LD BC,5</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> by five bytes to operand of next <span class="instruction">LD B,x</span> instruction (i.e. MSB of "input address" for next control)...</td>
</tr>
<tr>
<td class="address-1"><span id="54864"></span>54864</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="54865"></span>54865</td>
<td class="instruction">LD (23398),HL</td>
<td class="comment-1" rowspan="1">...and store at <a href="23397.html#23398">23398</a></td>
</tr>
<tr>
<td class="address-1"><span id="54868"></span>54868</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (pointer to current position in list of current keyboard control characters, PUSHed at <a href="54647.html#54792">54792</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="54869"></span>54869</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to next keyboard control character</td>
</tr>
<tr>
<td class="address-1"><span id="54870"></span>54870</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (<span class="register">B</span> = remaining number of control keys to check, PUSHed at <a href="54647.html#54791">54791</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="54871"></span>54871</td>
<td class="instruction">DJNZ 54791</td>
<td class="comment-1" rowspan="1">Decrease <span class="register">B</span> (remaining number of control keys to check) and loop back to <a href="54647.html#54791">54791</a> for next control key if not zero</td>
</tr>
<tr>
<td class="address-1"><span id="54873"></span>54873</td>
<td class="instruction">JP <a href="55138.html">55138</a></td>
<td class="comment-1" rowspan="1">Display "PRESS FIRE TO CONTINUE" window and wait for fire to be pressed and return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54598.html">54598</a>
</td>
<td class="up">Up: <a href="../maps/all.html#54647">Map</a></td>
<td class="next">
Next: <a href="54876.html">54876</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Knight Tyme (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1986 David Jones / Mastertronic (Knight Tyme). &#169; 2013-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>