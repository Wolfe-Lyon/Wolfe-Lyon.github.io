<!DOCTYPE html>
<html>
<head>
<title>Stormbringer (48k): Routine at 63040</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../stormbringer.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="63005.html">63005</a>
</td>
<td class="up">Up: <a href="../maps/all.html#63040">Map</a></td>
<td class="next">
Next: <a href="63134.html">63134</a>
</td>
</tr>
</table>
<div class="description">63040: Draw axe to screen</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="46560.html">46560</a> and <a href="46784.html">46784</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Frame number (32, 116, 117, 118 or 119)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="63040"></span>63040</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="63041"></span>63041</td>
<td class="instruction">LD DE,28248</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at 28248</td>
</tr>
<tr>
<td class="address-1"><span id="63044"></span>63044</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">Double <span class="register">A</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="63045"></span>63045</td>
<td class="instruction">LD H,0</td>
<td class="comment-1" rowspan="1">...load into <span class="register">HL</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="63047"></span>63047</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="63048"></span>63048</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-1" rowspan="1">...double again...</td>
</tr>
<tr>
<td class="address-1"><span id="63049"></span>63049</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-1" rowspan="1">...and again to get 8 times original <span class="register">A</span> value...</td>
</tr>
<tr>
<td class="address-1"><span id="63050"></span>63050</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1">...and add <span class="register">DE</span> to this</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63051"></span>
<div class="comments">
<div class="paragraph">
At this point, <span class="register">HL</span> points to one of the five sets of axe frame graphic data (<a href="28504.html">28504</a>, <a href="29176.html">29176</a>, <a href="29176.html#29184">29184</a>, <a href="29176.html#29192">29192</a> or <a href="29176.html#29200">29200</a>).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63051"></span>63051</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Copy <span class="register">HL</span> into <span class="register">IX</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="63052"></span>63052</td>
<td class="instruction">POP IX</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="63054"></span>63054</td>
<td class="instruction">LD BC,(23677)</td>
<td class="comment-1" rowspan="1">Load value in <a href="23677.html">coordinate storage</a> into <span class="register">BC</span> (holds x- and y-coordinates of axe)</td>
</tr>
<tr>
<td class="address-1"><span id="63058"></span>63058</td>
<td class="instruction">CALL <a href="63134.html">63134</a></td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with display file address for coordinates in <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="63061"></span>63061</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Load pixel-within-byte "address" into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="63062"></span>63062</td>
<td class="instruction">LD B,8</td>
<td class="comment-1" rowspan="1">Load 8 into <span class="register">B</span> (as axe graphic data comprises 8 pixel rows)</td>
</tr>
<tr>
<td class="address-2"><span id="63064"></span>63064</td>
<td class="instruction">LD D,(IX+0)</td>
<td class="comment-1" rowspan="1">Load a byte of axe graphic data into <span class="register">D</span></td>
</tr>
<tr>
<td class="address-1"><span id="63067"></span>63067</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Load pixel-within-byte "address" into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="63068"></span>63068</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Check if we're dealing with pixel zero...</td>
</tr>
<tr>
<td class="address-1"><span id="63069"></span>63069</td>
<td class="instruction">JR Z,63128</td>
<td class="comment-1" rowspan="1">...and if so, skip ahead to <a href="63040.html#63128">63128</a></td>
</tr>
<tr>
<td class="address-1"><span id="63071"></span>63071</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero</td>
</tr>
<tr>
<td class="address-1"><span id="63072"></span>63072</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Copy into <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="63073"></span>63073</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (<span class="register">B</span>=graphic row counter, <span class="register">C</span>=pixel-within-byte "address")</td>
</tr>
<tr>
<td class="address-1"><span id="63074"></span>63074</td>
<td class="instruction">LD B,C</td>
<td class="comment-1" rowspan="1">Copy pixel-within-byte "address" into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-2"><span id="63075"></span>63075</td>
<td class="instruction">SRL D</td>
<td class="comment-1" rowspan="1">Shift graphic data right one bit (rightmost bit goes into carry flag)</td>
</tr>
<tr>
<td class="address-1"><span id="63077"></span>63077</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Rotate carry flag into leftmost bit of <span class="register">A</span>, shifting other bits right</td>
</tr>
<tr>
<td class="address-1"><span id="63078"></span>63078</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Set carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="63079"></span>63079</td>
<td class="instruction">RR E</td>
<td class="comment-1" rowspan="1">Rotate (set) carry flag into leftmost bit of <span class="register">E</span>, shifting other bits right, and resetting carry flag</td>
</tr>
<tr>
<td class="address-1"><span id="63081"></span>63081</td>
<td class="instruction">DJNZ 63075</td>
<td class="comment-1" rowspan="1">Repeat loop to shift graphic right another pixel if necessary</td>
</tr>
<tr>
<td class="address-1"><span id="63083"></span>63083</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Switch <span class="register">AF</span> registers</td>
</tr>
<tr>
<td class="address-1"><span id="63084"></span>63084</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with value in <span class="register">E</span> (set bits represent number of pixels by which axe graphic has been shifted right)</td>
</tr>
<tr>
<td class="address-1"><span id="63085"></span>63085</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (<span class="register">B</span>=graphic row counter, <span class="register">C</span>=pixel-within-byte "address")</td>
</tr>
<tr>
<td class="address-2"><span id="63086"></span>63086</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1">Load left part of axe graphic data into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="63087"></span>63087</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="1">Load <span class="register">E</span> with graphic data currently at axe's position on screen</td>
</tr>
<tr>
<td class="address-1"><span id="63088"></span>63088</td>
<td class="instruction">XOR E</td>
<td class="comment-1" rowspan="1">Blend axe graphic data with what is already on screen at its position to make things look more natural...</td>
</tr>
<tr>
<td class="address-1"><span id="63089"></span>63089</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...and write new graphic data back to screen</td>
</tr>
<tr>
<td class="address-1"><span id="63090"></span>63090</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance right one byte in display file</td>
</tr>
<tr>
<td class="address-1"><span id="63091"></span>63091</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Switch registers to restore right part of axe graphic data to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="63092"></span>63092</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="1">Load <span class="register">E</span> with graphic data currently at axe's position on screen</td>
</tr>
<tr>
<td class="address-1"><span id="63093"></span>63093</td>
<td class="instruction">XOR E</td>
<td class="comment-1" rowspan="1">Blend axe graphic data with what is already on screen at its position to make things look more natural...</td>
</tr>
<tr>
<td class="address-1"><span id="63094"></span>63094</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...and write new graphic data back to screen</td>
</tr>
<tr>
<td class="address-1"><span id="63095"></span>63095</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Move left one byte in display file</td>
</tr>
<tr>
<td class="address-1"><span id="63096"></span>63096</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Advance <span class="register">IX</span> to next row of axe graphic data</td>
</tr>
<tr>
<td class="address-1"><span id="63098"></span>63098</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Increase <span class="register">H</span> by 1 (i.e. advance <span class="register">HL</span> by 256)</td>
</tr>
<tr>
<td class="address-1"><span id="63099"></span>63099</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="3">If at least one of the three rightmost bits of <span class="register">H</span> are set (i.e. we haven't crossed over from one third of the display to the next third) then skip ahead to <a href="63040.html#63124">63124</a> (as <span class="register">HL</span> now points to next pixel row down)</td>
</tr>
<tr>
<td class="address-1"><span id="63100"></span>63100</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="63102"></span>63102</td>
<td class="instruction">JR NZ,63124</td>
</tr>
<tr>
<td class="address-1"><span id="63104"></span>63104</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="3">Else we must have been in the bottom pixel row of a character row, so decrease <span class="register">H</span> by 8 (1 to go back up, then 7 pixel rows up to the top of that character row)</td>
</tr>
<tr>
<td class="address-1"><span id="63105"></span>63105</td>
<td class="instruction">SUB 8</td>
</tr>
<tr>
<td class="address-1"><span id="63107"></span>63107</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="63108"></span>63108</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="1">Advance <span class="register">L</span> by 32 bytes to move down one character row, so now the top of the next character row down...</td>
</tr>
<tr>
<td class="address-1"><span id="63109"></span>63109</td>
<td class="instruction">ADD A,32</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="63111"></span>63111</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="63112"></span>63112</td>
<td class="instruction">JR NC,63124</td>
<td class="comment-1" rowspan="4">If <span class="register">L</span> hasn't gone over 256 (i.e. we haven't moved 32 bytes on from the top pixel row of the bottom character row of the third) then skip ahead to <a href="63040.html#63124">63124</a> else move down by a third</td>
</tr>
<tr>
<td class="address-1"><span id="63114"></span>63114</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="63115"></span>63115</td>
<td class="instruction">ADD A,8</td>
</tr>
<tr>
<td class="address-1"><span id="63117"></span>63117</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="63118"></span>63118</td>
<td class="instruction">XOR 88</td>
<td class="comment-1" rowspan="1">If we have not reached the start of the attribute file...</td>
</tr>
<tr>
<td class="address-1"><span id="63120"></span>63120</td>
<td class="instruction">JR NZ,63124</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="63040.html#63124">63124</a></td>
</tr>
<tr>
<td class="address-1"><span id="63122"></span>63122</td>
<td class="instruction">LD H,64</td>
<td class="comment-1" rowspan="1">...else wrap back round to the start of display file again</td>
</tr>
<tr>
<td class="address-2"><span id="63124"></span>63124</td>
<td class="instruction">DJNZ 63064</td>
<td class="comment-1" rowspan="1">Decrease <span class="register">B</span> (remaining number of pixel rows to draw) and loop back to <a href="63040.html#63064">63064</a></td>
</tr>
<tr>
<td class="address-1"><span id="63126"></span>63126</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="63127"></span>63127</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="address-2"><span id="63128"></span>63128</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero</td>
</tr>
<tr>
<td class="address-1"><span id="63129"></span>63129</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Switch registers</td>
</tr>
<tr>
<td class="address-1"><span id="63130"></span>63130</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero</td>
</tr>
<tr>
<td class="address-1"><span id="63131"></span>63131</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Set <span class="register">E</span> to zero as axe graphic hasn't been shifted</td>
</tr>
<tr>
<td class="address-1"><span id="63132"></span>63132</td>
<td class="instruction">JR 63086</td>
<td class="comment-1" rowspan="1">Jump back to <a href="63040.html#63086">63086</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="63005.html">63005</a>
</td>
<td class="up">Up: <a href="../maps/all.html#63040">Map</a></td>
<td class="next">
Next: <a href="63134.html">63134</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Stormbringer (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1987 David Jones / Mastertronic (Stormbringer). &#169; 2014-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>