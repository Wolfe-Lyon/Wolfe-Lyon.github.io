<!DOCTYPE html>
<html>
<head>
<title>Stormbringer (48k): Routine at 44861</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../stormbringer.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="44635.html">44635</a>
</td>
<td class="up">Up: <a href="../maps/all.html#44861">Map</a></td>
<td class="next">
Next: <a href="44933.html">44933</a>
</td>
</tr>
</table>
<div class="description">44861: Process command to teleport</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="64623.html">64623</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="44861"></span>44861</td>
<td class="instruction">LD B,2</td>
<td class="comment-1" rowspan="1">Print or update command summary window at top of screen...</td>
</tr>
<tr>
<td class="address-1"><span id="44863"></span>44863</td>
<td class="instruction">CALL <a href="45206.html">45206</a></td>
<td class="comment-1" rowspan="1">...with "TELEPORT" text</td>
</tr>
<tr>
<td class="address-1"><span id="44866"></span>44866</td>
<td class="instruction">CALL <a href="64207.html">64207</a></td>
<td class="comment-1" rowspan="1">Display execute / reject command window and return here if execute chosen, else exit to main game loop</td>
</tr>
<tr>
<td class="address-1"><span id="44869"></span>44869</td>
<td class="instruction">LD A,(25018)</td>
<td class="comment-1" rowspan="1">If the Teleport Pad's current room is not 99...</td>
</tr>
<tr>
<td class="address-1"><span id="44872"></span>44872</td>
<td class="instruction">CP 99</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44874"></span>44874</td>
<td class="instruction">JR NZ,44900</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="44861.html#44900">44900</a></td>
</tr>
<tr>
<td class="address-1"><span id="44876"></span>44876</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="44877"></span>44877</td>
<td class="instruction">LD (23702),A</td>
<td class="comment-1" rowspan="1">...to be zero (Limbo)</td>
</tr>
<tr>
<td class="address-1"><span id="44880"></span>44880</td>
<td class="instruction">LD A,120</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x- and y-coordinates to be 120...</td>
</tr>
<tr>
<td class="address-1"><span id="44882"></span>44882</td>
<td class="instruction">LD (24840),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44885"></span>44885</td>
<td class="instruction">LD (24841),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44888"></span>44888</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="1">Set animate-puff-of-smoke flag...</td>
</tr>
<tr>
<td class="address-1"><span id="44890"></span>44890</td>
<td class="instruction">LD (23480),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44893"></span>44893</td>
<td class="instruction">LD HL,56462</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "IT WAS NOT SAFE TO TELEPORT SO YOU HAVE WOUND UP IN LIMBO" text</td>
</tr>
<tr>
<td class="address-1"><span id="44896"></span>44896</td>
<td class="instruction">CALL <a href="64317.html">64317</a></td>
<td class="comment-1" rowspan="1">Display "IT WAS NOT SAFE TO TELEPORT..." window (17) and return to game...</td>
</tr>
<tr>
<td class="address-1"><span id="44899"></span>44899</td>
<td class="instruction">DEFB 17</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="44900"></span>
<div class="comments">
<div class="paragraph">
Teleport Pad's room is not 99
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="44900"></span>44900</td>
<td class="instruction">LD HL,25018</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> to current position data of Teleport Pad</td>
</tr>
<tr>
<td class="address-1"><span id="44903"></span>44903</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with current room of Teleport Pad...</td>
</tr>
<tr>
<td class="address-1"><span id="44904"></span>44904</td>
<td class="instruction">LD (23702),A</td>
<td class="comment-1" rowspan="1">...and update Magic Knight's current room to match</td>
</tr>
<tr>
<td class="address-1"><span id="44907"></span>44907</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to x-coordinate of Teleport Pad...</td>
</tr>
<tr>
<td class="address-1"><span id="44908"></span>44908</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">...and load this into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="44909"></span>44909</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">Multiply x-coordinate by eight...</td>
</tr>
<tr>
<td class="address-1"><span id="44910"></span>44910</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44911"></span>44911</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44912"></span>44912</td>
<td class="instruction">LD (24840),A</td>
<td class="comment-1" rowspan="1">...and update Magic Knight's current x-coordinate to match</td>
</tr>
<tr>
<td class="address-1"><span id="44915"></span>44915</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to y-coordinate of Teleport Pad...</td>
</tr>
<tr>
<td class="address-1"><span id="44916"></span>44916</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">...and load this into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="44917"></span>44917</td>
<td class="instruction">SUB 3</td>
<td class="comment-1" rowspan="1">Subtract three (because Magic Knight is four character blocks tall)...</td>
</tr>
<tr>
<td class="address-1"><span id="44919"></span>44919</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...multiply by eight...</td>
</tr>
<tr>
<td class="address-1"><span id="44920"></span>44920</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44921"></span>44921</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44922"></span>44922</td>
<td class="instruction">LD (24841),A</td>
<td class="comment-1" rowspan="1">...and update Magic Knight's current y-coordinate to match</td>
</tr>
<tr>
<td class="address-1"><span id="44925"></span>44925</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="1">Set animate-puff-of-smoke flag...</td>
</tr>
<tr>
<td class="address-1"><span id="44927"></span>44927</td>
<td class="instruction">LD (23480),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="44930"></span>44930</td>
<td class="instruction">JP <a href="41578.html#41742">41742</a></td>
<td class="comment-1" rowspan="1">Set Magic Knight's available action flags and jump to start of main game loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="44635.html">44635</a>
</td>
<td class="up">Up: <a href="../maps/all.html#44861">Map</a></td>
<td class="next">
Next: <a href="44933.html">44933</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Stormbringer (48k) RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1987 David Jones / Mastertronic (Stormbringer). &#169; 2014-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>