<!DOCTYPE html>
<html>
<head>
<title>Stormbringer (48k): Routine at 63740</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../stormbringer.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="63691.html">63691</a></span></td>
<td class="up">Up: <a href="../maps/all.html#63740">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="63969.html">63969</a></span></td>
</tr>
</table>
<div class="description">63740: Redefine Keyboard Controls</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="37764.html">37764</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63740"></span>63740</td>
<td class="instruction">CALL <a href="63691.html">63691</a></td>
<td class="comment-11" rowspan="1">Print current control keys to Screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63743"></span>63743</td>
<td class="instruction">CALL <a href="63668.html">63668</a></td>
<td class="comment-11" rowspan="1">If keypress was enqueued then load A with index of last key pressed, otherwise wait for keypress and load A with index</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63746"></span>63746</td>
<td class="instruction">CP 13</td>
<td class="comment-11" rowspan="1">If key pressed was 13 (ENTER)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63748"></span>63748</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">...then return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63749"></span>63749</td>
<td class="instruction">LD (63669),A</td>
<td class="comment-11" rowspan="1">Set enqueued key index to index of key pressed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63752"></span>63752</td>
<td class="instruction">LD B,5</td>
<td class="comment-11" rowspan="1">Load B with 5 (as there are five controls)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63754"></span>63754</td>
<td class="instruction">LD HL,63986</td>
<td class="comment-11" rowspan="1">Point HL at start of list of current keyboard control characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63757"></span>63757</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-11" rowspan="1">Set current keyboard control character to zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63759"></span>63759</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance to next keyboard control character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63760"></span>63760</td>
<td class="instruction">DJNZ 63757</td>
<td class="comment-11" rowspan="1">Decrease B (remaining number of keyboard control characters to clear) and loop back to <a href="63740.html#63757">63757</a> if not zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63762"></span>63762</td>
<td class="instruction">LD BC,1280</td>
<td class="comment-11" rowspan="1">Load B with 5 and C with zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63765"></span>63765</td>
<td class="instruction">LD HL,63986</td>
<td class="comment-11" rowspan="1">Point HL at start of list of current keyboard control characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63768"></span>63768</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store BC (B = remaining number of controls to define, C = number of controls defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63769"></span>63769</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Store HL (current position in List of Keyboard Control Characters)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63770"></span>63770</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">Load number of controls defined (0, 1, 2, 3 or 4) into A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63771"></span>63771</td>
<td class="instruction">AND 6</td>
<td class="comment-11" rowspan="1">Reset all but bits 1 and 2 (to give 0, 2 or 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63773"></span>63773</td>
<td class="instruction">ADD A,14</td>
<td class="comment-11" rowspan="1">Add 14 (to give 14, 16 or 18, the y-coordinates in characters of displayed keyboard controls)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63775"></span>63775</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">...and load into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63776"></span>63776</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">Load A with number of controls defined (0, 1, 2, 3 or 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63777"></span>63777</td>
<td class="instruction">AND 1</td>
<td class="comment-11" rowspan="1">Reset all but bit 0 (to give 0 or 1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63779"></span>63779</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Store AF (A = bit 0 of number of controls defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63780"></span>63780</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">Double A (to give 0 or 2)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63781"></span>63781</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">...and load into C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63782"></span>63782</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore AF (A = bit 0 of number of controls defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63783"></span>63783</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Store AF (A = bit 0 of number of controls defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63784"></span>63784</td>
<td class="instruction">ADD A,C</td>
<td class="comment-11" rowspan="1">Add C to A (to give 0 or 3)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63785"></span>63785</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">Multiply A by four...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63786"></span>63786</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...to give 0 or 12...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63787"></span>63787</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">...and load into C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63788"></span>63788</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore AF (A = bit 0 of number of controls defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63789"></span>63789</td>
<td class="instruction">ADD A,C</td>
<td class="comment-11" rowspan="1">Add value in C to A (to give 0 or 13)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63790"></span>63790</td>
<td class="instruction">ADD A,5</td>
<td class="comment-11" rowspan="1">Add 5 (to give 5 or 18, the x-coordinates in characters of displayed keyboard controls)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63792"></span>63792</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">...and load into C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63793"></span>63793</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store BC (coordinates in characters of current control being defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63794"></span>63794</td>
<td class="instruction">CALL <a href="63219.html">63219</a></td>
<td class="comment-11" rowspan="1">Load HL with Attribute File address for coordinates (C, B)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63797"></span>63797</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">...and set the FLASH Flag for this address...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63798"></span>63798</td>
<td class="instruction">OR 128</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63800"></span>63800</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63801"></span>63801</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore BC (coordinates in characters of current control being defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63802"></span>63802</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store BC (coordinates in characters of current control being defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63803"></span>63803</td>
<td class="instruction">CALL <a href="63203.html">63203</a></td>
<td class="comment-11" rowspan="1">Move Virtual Cursor (Bitmap) to Display File address for Coordinates x=C, y=B and load address into HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63806"></span>63806</td>
<td class="instruction">CALL <a href="63668.html">63668</a></td>
<td class="comment-11" rowspan="1">If keypress was enqueued then load A with index of last key pressed, otherwise wait for keypress and load A with index</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63809"></span>63809</td>
<td class="instruction">CP 32</td>
<td class="comment-11" rowspan="1">If key pressed was SPACE...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63811"></span>63811</td>
<td class="instruction">JP Z,63837</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="63740.html#63837">63837</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63814"></span>63814</td>
<td class="instruction">CP 48</td>
<td class="comment-11" rowspan="1">If index of key pressed is less than 48 (i.e. below "0")...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63816"></span>63816</td>
<td class="instruction">JP M,63801</td>
<td class="comment-11" rowspan="1">...then jump back to <a href="63740.html#63801">63801</a> (i.e. wait for next key press and try again)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63819"></span>63819</td>
<td class="instruction">CP 91</td>
<td class="comment-11" rowspan="1">If index of key pressed is 91 or higher (i.e. above "Z")...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63821"></span>63821</td>
<td class="instruction">JP P,63801</td>
<td class="comment-11" rowspan="1">...then jump back to <a href="63740.html#63801">63801</a> (i.e. wait for next key press and try again)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63824"></span>63824</td>
<td class="instruction">CP 58</td>
<td class="comment-11" rowspan="1">If index of key pressed is less than 58 (i.e. "9" or below)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63826"></span>63826</td>
<td class="instruction">JP M,63837</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="63740.html#63837">63837</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63829"></span>63829</td>
<td class="instruction">CP 65</td>
<td class="comment-11" rowspan="1">If index of key pressed is 65 or higher (i.e. "A" or above)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63831"></span>63831</td>
<td class="instruction">JP P,63837</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="63740.html#63837">63837</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63834"></span>63834</td>
<td class="instruction">JP 63801</td>
<td class="comment-11" rowspan="1">Jump back to <a href="63740.html#63801">63801</a> (i.e. wait for next key press and try again)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63837"></span>63837</td>
<td class="instruction">CALL <a href="63969.html">63969</a></td>
<td class="comment-11" rowspan="1">Set Zero Flag if key pressed is already assigned to a control, otherwise reset</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63840"></span>63840</td>
<td class="instruction">JP Z,63801</td>
<td class="comment-11" rowspan="1">If key pressed is already assigned then jump back to <a href="63740.html#63801">63801</a> (i.e. wait for next key press and try again)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63843"></span>63843</td>
<td class="instruction">LD (23711),A</td>
<td class="comment-11" rowspan="1">Store pressed key index at <a href="23709.html#23711">23711</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63846"></span>63846</td>
<td class="instruction">CP 32</td>
<td class="comment-11" rowspan="1">If key was not SPACE...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63848"></span>63848</td>
<td class="instruction">JR NZ,63852</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="63740.html#63852">63852</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63850"></span>63850</td>
<td class="instruction">LD A,127</td>
<td class="comment-11" rowspan="1">Load A with 127 (index in character set of COPYRIGHT UDG at <a href="28248.html#28496">28496</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63852"></span>63852</td>
<td class="instruction">CALL <a href="63005.html">63005</a></td>
<td class="comment-11" rowspan="1">Print text character in A and advance Bitmap Virtual Text Cursor</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63855"></span>63855</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore BC (coordinates in characters of current control being defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63856"></span>63856</td>
<td class="instruction">CALL <a href="63219.html">63219</a></td>
<td class="comment-11" rowspan="1">Load HL with Attribute File address for coordinates (C, B)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63859"></span>63859</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">...and reset the FLASH Flag for this address...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63860"></span>63860</td>
<td class="instruction">AND 127</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63862"></span>63862</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63863"></span>63863</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore HL (current position in List of Keyboard Control Characters)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63864"></span>63864</td>
<td class="instruction">LD A,(23711)</td>
<td class="comment-11" rowspan="1">Load A with index of previously defined key...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63867"></span>63867</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">...and store in List of Keyboard Control Characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63868"></span>63868</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance HL to next entry in List of Keyboard Control Characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63869"></span>63869</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore BC (B = remaining number of controls to define, C = number of controls defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63870"></span>63870</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">Increase C (number of controls defined)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63871"></span>63871</td>
<td class="instruction">DJNZ 63768</td>
<td class="comment-11" rowspan="1">Decrease B (remaining number of controls to define) and loop back to <a href="63740.html#63768">63768</a> if not zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63873"></span>63873</td>
<td class="instruction">LD B,5</td>
<td class="comment-11" rowspan="1">Load B with 5 (as each keyboard half-row holds five keys)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63875"></span>63875</td>
<td class="instruction">LD HL,64045</td>
<td class="comment-11" rowspan="1">Load HL with address of operand of instruction at <a href="64042.html#64044">64045</a> (MSB of "input address" for keyboard half-row reading for LEFT)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63878"></span>63878</td>
<td class="instruction">LD (23711),HL</td>
<td class="comment-11" rowspan="1">...and store at <a href="23709.html#23711">23711</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63881"></span>63881</td>
<td class="instruction">LD HL,63986</td>
<td class="comment-11" rowspan="1">Point HL at start of list of current keyboard control characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63884"></span>63884</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store BC (B = remaining number of control keys to check)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63885"></span>63885</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Store HL (pointer to current position in list of current keyboard control characters)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63886"></span>63886</td>
<td class="instruction">LD IX,63994</td>
<td class="comment-11" rowspan="1">Point IX at Lists of Characters on Each Keyboard Half-Row</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63890"></span>63890</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Load A with current keyboard control character index</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63891"></span>63891</td>
<td class="instruction">LD C,0</td>
<td class="comment-11" rowspan="1">Set C (index in list of half-rows) to zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63893"></span>63893</td>
<td class="instruction">CP (IX+0)</td>
<td class="comment-11" rowspan="1">If current keyboard control character index is the same as the current character in keyboard half-row groups...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63896"></span>63896</td>
<td class="instruction">JR Z,63903</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="63740.html#63903">63903</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63898"></span>63898</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">Increase C (index in list of half-rows)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63899"></span>63899</td>
<td class="instruction">INC IX</td>
<td class="comment-11" rowspan="1">Advance to next entry in list of half-rows</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63901"></span>63901</td>
<td class="instruction">JR 63893</td>
<td class="comment-11" rowspan="1">Loop back to <a href="63740.html#63893">63893</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63903"></span>63903</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">Load A with index of current control key in list of half-rows</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="63904"></span>
<div class="comments">
<div class="paragraph">
At this point we know the index of the current key in the list of half-rows. We now need to identify which half row it belongs to.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63904"></span>63904</td>
<td class="instruction">LD B,0</td>
<td class="comment-11" rowspan="1">Set B (keyboard half-row index) to zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63906"></span>63906</td>
<td class="instruction">SUB 5</td>
<td class="comment-11" rowspan="1">If index of key in current half-row is less than 5 (i.e. key is in the current half-row)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63908"></span>63908</td>
<td class="instruction">JP M,63914</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="63740.html#63914">63914</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63911"></span>63911</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">Increase B (keyboard half-row index)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63912"></span>63912</td>
<td class="instruction">JR 63906</td>
<td class="comment-11" rowspan="1">Loop back to <a href="63740.html#63906">63906</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="63914"></span>
<div class="comments">
<div class="paragraph">
The MSB in the "input address" for the various keyboard half-rows obeys the progression (254, 253, 251, 247, 239, 223, 191, 127).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63914"></span>63914</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">Load A with index of keyboard half-row containing current key</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63915"></span>63915</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store BC (B = index of keyboard half-row, C = index of key in list of half-rows)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63916"></span>63916</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">Increase B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63917"></span>63917</td>
<td class="instruction">LD HL,128</td>
<td class="comment-11" rowspan="1">Load HL with 128</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63920"></span>63920</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-11" rowspan="1">Double value in HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63921"></span>63921</td>
<td class="instruction">DJNZ 63920</td>
<td class="comment-11" rowspan="1">Decrease B (index of keyboard half-row) and loop back to <a href="63740.html#63920">63920</a> if not zero</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="63923"></span>
<div class="comments">
<div class="paragraph">
HL now contains the value (128 * 2^n) where n is the (1-based) index of the relevant half-row. H contains (2^m), where m is the (zero-based) index of the relevant half-row.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63923"></span>63923</td>
<td class="instruction">LD A,255</td>
<td class="comment-11" rowspan="1">Load A with 255</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63925"></span>63925</td>
<td class="instruction">SUB H</td>
<td class="comment-11" rowspan="1">Subtract H (2^m) to give MSB of input address for relevant half-row</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63926"></span>63926</td>
<td class="instruction">LD HL,(23711)</td>
<td class="comment-11" rowspan="1">Load HL with address of operand of instruction to modify (<a href="64042.html#64044">64045</a>)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63929"></span>63929</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">...and set operand to value in A</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="63930"></span>
<div class="comments">
<div class="paragraph">
Next we need to modify the second part of the opcode for the instruction that checks the set bit in A to determine which key in the half-row was pressed. The range of opcode values are:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Opcode Value</th>
<th colspan="1" rowspan="1">Instruction</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">71</td>
<td class="" colspan="1" rowspan="1">BIT 0,A</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">79</td>
<td class="" colspan="1" rowspan="1">BIT 1,A</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">87</td>
<td class="" colspan="1" rowspan="1">BIT 2,A</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">95</td>
<td class="" colspan="1" rowspan="1">BIT 3,A</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">103</td>
<td class="" colspan="1" rowspan="1">BIT 4,A</td>
</tr>
</table>
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63930"></span>63930</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance HL by four bytes to operand of instruction at <a href="64042.html#64048">64048</a>...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63931"></span>63931</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63932"></span>63932</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63933"></span>63933</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63934"></span>63934</td>
<td class="instruction">LD (23711),HL</td>
<td class="comment-11" rowspan="1">...and store at <a href="23709.html#23711">23711</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63937"></span>63937</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore BC (B = index of keyboard half-row, C = index of key in list of half-rows)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63938"></span>63938</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">Load B with five times index of keyboard half-row (value currently in B)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63939"></span>63939</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63940"></span>63940</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63941"></span>63941</td>
<td class="instruction">ADD A,B</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63942"></span>63942</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">... (B is now 0, 5, 10, 15, 20, 25, 30 or 35)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63943"></span>63943</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">Load A with index of key in list of half-rows...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63944"></span>63944</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1">...and subtract B (5 times index of half-row) to give index of key within current half-row</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63945"></span>63945</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">Multiply this index by 8 (opcode interval between successive "BIT n,A" and "BIT n+1,A" instructions)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63946"></span>63946</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63947"></span>63947</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63948"></span>63948</td>
<td class="instruction">ADD A,71</td>
<td class="comment-11" rowspan="1">...and add 71 (opcode for "BIT 0,A")</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63950"></span>63950</td>
<td class="instruction">LD HL,(23711)</td>
<td class="comment-11" rowspan="1">Load HL with address of operand / opcode for "BIT n,A" instruction...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63953"></span>63953</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">...and set "n" accordingly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63954"></span>63954</td>
<td class="instruction">LD BC,5</td>
<td class="comment-11" rowspan="1">Advance HL by five bytes to operand of next "LD B,x" instruction (i.e. MSB of "input address" for next control)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63957"></span>63957</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63958"></span>63958</td>
<td class="instruction">LD (23711),HL</td>
<td class="comment-11" rowspan="1">...and store at <a href="23709.html#23711">23711</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63961"></span>63961</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore HL (pointer to current position in list of current keyboard control characters, PUSHed at <a href="63740.html#63885">63885</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63962"></span>63962</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance HL to next keyboard control character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63963"></span>63963</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Store BC (B = remaining number of control keys to check, PUSHed at <a href="63740.html#63884">63884</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63964"></span>63964</td>
<td class="instruction">DJNZ 63884</td>
<td class="comment-11" rowspan="1">Decrease B (remaining number of control keys to check) and loop back to <a href="63740.html#63884">63884</a> for next control key if not zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63966"></span>63966</td>
<td class="instruction">JP <a href="64230.html">64230</a></td>
<td class="comment-11" rowspan="1">Wait for interrupt then display "PRESS FIRE TO CONTINUE" Window and wait for Fire to be pressed and return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="63691.html">63691</a></span></td>
<td class="up">Up: <a href="../maps/all.html#63740">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="63969.html">63969</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Stormbringer (48k) RAM Disassembly 02/06/2018</div>
<div class="copyright">&#169; 1987 David Jones / Mastertronic (Stormbringer). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.4.</div>
</footer>
</body>
</html>