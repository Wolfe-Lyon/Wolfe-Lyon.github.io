<!DOCTYPE html>
<html>
<head>
<title>Stormbringer (48k): Routine at 61638</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../stormbringer.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="61625.html">61625</a></span></td>
<td class="up">Up: <a href="../maps/all.html#61638">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="61720.html">61720</a></span></td>
</tr>
</table>
<div class="description">61638: Store Background Bitmap Data at Magic Knight's Current Location</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="61860.html">61860</a>.
</div>
<div class="paragraph">
See also analogous routine at <a href="61913.html">61913</a>
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="61638"></span>61638</td>
<td class="instruction">LD DE,24576</td>
<td class="comment-11" rowspan="1">Point DE at Table of Bitmap Data for Magic Knight at his Current Location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61641"></span>61641</td>
<td class="instruction">LD A,(24841)</td>
<td class="comment-11" rowspan="1">Load HL with double Magic Knight's current y-coordinate (pixels)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61644"></span>61644</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61645"></span>61645</td>
<td class="instruction">LD H,0</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61647"></span>61647</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61648"></span>61648</td>
<td class="instruction">LD BC,65140</td>
<td class="comment-11" rowspan="1">Point BC at Table of Display File Addresses of Start of Each Pixel Row</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61651"></span>61651</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">Add double y-coordinate as offset in HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61652"></span>61652</td>
<td class="instruction">LD (23412),HL</td>
<td class="comment-11" rowspan="1">Store pointer to entry for pixel row at Magic Knight's current y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61655"></span>61655</td>
<td class="instruction">LD A,(24840)</td>
<td class="comment-11" rowspan="1">Load A with Magic Knight's current x-coordinate (pixels)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61658"></span>61658</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="1">Divide by two</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61659"></span>61659</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Store AF (A = Magic Knight's current x-coordinate in pixels, divided by two)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61660"></span>61660</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="1">Clear all but the lowest three bits...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61662"></span>61662</td>
<td class="instruction">LD (24843),A</td>
<td class="comment-11" rowspan="1">...and store the remaining value as Magic Knight's current frame index</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61665"></span>61665</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore AF (A = Magic Knight's current x-coordinate in pixels, divided by two)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61666"></span>61666</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="1">Divide Magic Knight's current x-coordinate in pixels by eight and remove remainder...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61667"></span>61667</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61668"></span>61668</td>
<td class="instruction">AND 31</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61670"></span>61670</td>
<td class="instruction">LD (23414),A</td>
<td class="comment-11" rowspan="1">Store value (Magic Knight's current x-coordinate in characters) at <a href="23404.html#23414">23414</a>...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61673"></span>61673</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">...and load into C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61674"></span>61674</td>
<td class="instruction">LD B,32</td>
<td class="comment-11" rowspan="1">Load B with 32 (as Magic Knight is 32 pixels tall)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61676"></span>61676</td>
<td class="instruction">LD IX,(23412)</td>
<td class="comment-11" rowspan="1">Load IX with pointer to entry for pixel row at Magic Knight's current y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="61680"></span>61680</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store BC (B = remaining number of pixel rows to store, C = MK's x-coordinate in characters)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61681"></span>61681</td>
<td class="instruction">LD L,(IX+0)</td>
<td class="comment-11" rowspan="1">Load Display File address of pixel row at IX into HL...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61684"></span>61684</td>
<td class="instruction">INC IX</td>
<td class="comment-11" rowspan="1">...and advance IX to entry for next pixel row down...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61686"></span>61686</td>
<td class="instruction">LD H,(IX+0)</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61689"></span>61689</td>
<td class="instruction">INC IX</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61691"></span>61691</td>
<td class="instruction">LD B,0</td>
<td class="comment-11" rowspan="1">Set B to zero (BC = Magic Knight's current x-coordinate in characters)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61693"></span>61693</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">Add BC to HL as offset</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61694"></span>61694</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Copy three bytes of graphic data from Display File address...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61695"></span>61695</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">...into Table of Background Bitmap Data...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61696"></span>61696</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">...as Magic Knight can only occupy three consecutive character blocks horizontally...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61697"></span>61697</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61698"></span>61698</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61699"></span>61699</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61700"></span>61700</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61701"></span>61701</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61702"></span>61702</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61703"></span>61703</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61704"></span>61704</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61705"></span>61705</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore BC (B = remaining number of pixel rows to store, C = MK's x-coordinate in characters)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61706"></span>61706</td>
<td class="instruction">DJNZ 61680</td>
<td class="comment-11" rowspan="1">Decrease B (remaining number of pixel rows to store) and loop back to <a href="61638.html#61680">61680</a> if non-zero for next pixel row</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61708"></span>61708</td>
<td class="instruction">LD HL,24576</td>
<td class="comment-11" rowspan="1">Copy contents of Table of Bitmap Data for Magic Knight at his Current Location to Table of Background Bitmap Data <a href="24672.html">24672</a>...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61711"></span>61711</td>
<td class="instruction">LD DE,24672</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61714"></span>61714</td>
<td class="instruction">LD BC,96</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61717"></span>61717</td>
<td class="instruction">LDIR</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="61719"></span>61719</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="61625.html">61625</a></span></td>
<td class="up">Up: <a href="../maps/all.html#61638">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="61720.html">61720</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Stormbringer (48k) RAM Disassembly 02/06/2018</div>
<div class="copyright">&#169; 1987 David Jones / Mastertronic (Stormbringer). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.4.</div>
</footer>
</body>
</html>