<!DOCTYPE html>
<html>
<head>
<title>Stormbringer (48k): Routine at 43318</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../stormbringer.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="43302.html">43302</a></span></td>
<td class="up">Up: <a href="../maps/all.html#43318">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="43428.html">43428</a></span></td>
</tr>
</table>
<div class="description">43318: Make Current Character Eat &amp; Drink if Possible</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">

</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="43318"></span>43318</td>
<td class="instruction">CALL <a href="45552.html">45552</a></td>
<td class="comment-11" rowspan="1">Display "[Character] IS ASLEEP" Window and jump to Main Game Loop if Current Character is asleep, else return here and continue</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43321"></span>43321</td>
<td class="instruction">LD A,(41937)</td>
<td class="comment-11" rowspan="1">Load A with index of Current Character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43324"></span>43324</td>
<td class="instruction">LD E,0</td>
<td class="comment-11" rowspan="1">Point HL at character's current strength...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43326"></span>43326</td>
<td class="instruction">CALL <a href="45406.html">45406</a></td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43329"></span>43329</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Transfer address from HL...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43330"></span>43330</td>
<td class="instruction">POP IX</td>
<td class="comment-11" rowspan="1">...into IX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43332"></span>43332</td>
<td class="instruction">LD A,(IX+6)</td>
<td class="comment-11" rowspan="1">Load A with character's food level stripping out Asleep Flag...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43335"></span>43335</td>
<td class="instruction">AND 127</td>
<td class="comment-11" rowspan="1">...and set Zero Flag if food level is zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43337"></span>43337</td>
<td class="instruction">LD HL,52788</td>
<td class="comment-11" rowspan="1">Point HL at "[Current Character's short name] HAS NO FOOD LEFT" text</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43340"></span>43340</td>
<td class="instruction">JP Z,<a href="64313.html">64313</a></td>
<td class="comment-11" rowspan="1">If Zero Flag is set then display "[Character] HAS NO FOOD LEFT" window (29), wait for Fire to be pressed then jump to Main Game Loop</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43343"></span>43343</td>
<td class="instruction">LD A,(IX+2)</td>
<td class="comment-11" rowspan="1">If character's stamina is less than 20...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43346"></span>43346</td>
<td class="instruction">CP 20</td>
<td class="comment-11" rowspan="1">...then set Carry Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43348"></span>43348</td>
<td class="instruction">LD HL,52804</td>
<td class="comment-11" rowspan="1">Point HL at "[Current Character's short name] IS TOO TIRED TO EAT OR DRINK" text</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43351"></span>43351</td>
<td class="instruction">JP C,<a href="64313.html">64313</a></td>
<td class="comment-11" rowspan="1">If Carry Flag is set then display "[Character] IS TOO TIRED TO EAT OR DRINK" window (29), wait for Fire to be pressed then jump to Main Game Loop</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43354"></span>43354</td>
<td class="instruction">LD A,(IX+1)</td>
<td class="comment-11" rowspan="1">If character's happiness is less than 30...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43357"></span>43357</td>
<td class="instruction">CP 30</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43359"></span>43359</td>
<td class="instruction">JP C,<a href="64280.html">64280</a></td>
<td class="comment-11" rowspan="1">...then display "[Character] DOES NOT WANT TO BE COMMANDED BY YOU" Window (29), wait for Fire to be pressed then Jump to Main Game Loop</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43362"></span>43362</td>
<td class="instruction">LD A,(IX+6)</td>
<td class="comment-11" rowspan="1">Load A with character's Asleep Flag...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43365"></span>43365</td>
<td class="instruction">AND 128</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43367"></span>43367</td>
<td class="instruction">LD (43407),A</td>
<td class="comment-11" rowspan="1">...and store in operand of instruction at <a href="43318.html#43406">43406</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43370"></span>43370</td>
<td class="instruction">RES 7,(IX+6)</td>
<td class="comment-11" rowspan="1">Reset character's Asleep Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43374"></span>43374</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-11" rowspan="1">Load A with character's unused flag...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43377"></span>43377</td>
<td class="instruction">AND 128</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43379"></span>43379</td>
<td class="instruction">LD (43415),A</td>
<td class="comment-11" rowspan="1">...and store in operand of instruction at <a href="43318.html#43414">43414</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43382"></span>43382</td>
<td class="instruction">RES 7,(IX+0)</td>
<td class="comment-11" rowspan="1">Reset character's unused flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="43386"></span>43386</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-11" rowspan="1">If character's strength is 100...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43389"></span>43389</td>
<td class="instruction">CP 100</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43391"></span>43391</td>
<td class="instruction">JP Z,43406</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="43318.html#43406">43406</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43394"></span>43394</td>
<td class="instruction">DEC (IX+6)</td>
<td class="comment-11" rowspan="1">Decrease character's food level by one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43397"></span>43397</td>
<td class="instruction">INC (IX+0)</td>
<td class="comment-11" rowspan="1">Increase character's strength by one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43400"></span>43400</td>
<td class="instruction">LD A,(IX+6)</td>
<td class="comment-11" rowspan="1">If character's food level is not zero...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43403"></span>43403</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43404"></span>43404</td>
<td class="instruction">JR NZ,43386</td>
<td class="comment-11" rowspan="1">...then loop back to <a href="43318.html#43386">43386</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="43406"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="43318.html#43406">43406</a> represents the character's Asleep Flag (128 for asleep or 0 for awake). This is modified by the instruction at <a href="43318.html#43367">43367</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="43406"></span>43406</td>
<td class="instruction">LD A,0</td>
<td class="comment-11" rowspan="1">Load A with Asleep Flag value...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43408"></span>43408</td>
<td class="instruction">OR (IX+6)</td>
<td class="comment-11" rowspan="1">...merge with food level...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43411"></span>43411</td>
<td class="instruction">LD (IX+6),A</td>
<td class="comment-11" rowspan="1">...and store</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="43414"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="43318.html#43414">43414</a> represents the character's unused flag (bit 7 of strength). This is modified by the instruction at <a href="43318.html#43379">43379</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43414"></span>43414</td>
<td class="instruction">LD A,0</td>
<td class="comment-11" rowspan="1">Load A with unused flag value...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43416"></span>43416</td>
<td class="instruction">OR (IX+0)</td>
<td class="comment-11" rowspan="1">...merge with strength...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43419"></span>43419</td>
<td class="instruction">LD (IX+0),A</td>
<td class="comment-11" rowspan="1">...and store</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43422"></span>43422</td>
<td class="instruction">LD HL,52817</td>
<td class="comment-11" rowspan="1">Point HL at "[Current Character's short name] HAS TAKEN REFRESHMENT" text</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="43425"></span>43425</td>
<td class="instruction">JP <a href="64313.html">64313</a></td>
<td class="comment-11" rowspan="1">Display "[Character] HAS TAKEN REFRESHMENT" window (29), wait for Fire to be pressed then jump to Main Game Loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="43302.html">43302</a></span></td>
<td class="up">Up: <a href="../maps/all.html#43318">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="43428.html">43428</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Stormbringer (48k) RAM Disassembly 02/06/2018</div>
<div class="copyright">&#169; 1987 David Jones / Mastertronic (Stormbringer). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.4.</div>
</footer>
</body>
</html>