<!DOCTYPE html>
<html>
<head>
<title>Stormbringer (48k): Routine at 41748</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../stormbringer.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="41578.html">41578</a>
</td>
<td class="up">Up: <a href="../maps/all.html#41748">Map</a></td>
<td class="next">
Next: <a href="41915.html">41915</a>
</td>
</tr>
</table>
<div class="description">41748: Process command to drop an object</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="64623.html">64623</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41748"></span>41748</td>
<td class="instruction">CALL <a href="45641.html">45641</a></td>
<td class="comment-1" rowspan="1">Display "YOU ARE NOT CARRYING ANYTHING" window and set zero flag if Magic Knight's inventory (carrying) is empty</td>
</tr>
<tr>
<td class="address-1"><span id="41751"></span>41751</td>
<td class="instruction">JP Z,<a href="41578.html#41742">41742</a></td>
<td class="comment-1" rowspan="1">If Magic Knight's inventory (carrying) is empty then return to game</td>
</tr>
<tr>
<td class="address-1"><span id="41754"></span>41754</td>
<td class="instruction">LD IX,24848</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> at start of Magic Knight's current inventory (carrying)</td>
</tr>
<tr>
<td class="address-1"><span id="41758"></span>41758</td>
<td class="instruction">LD B,5</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 5 (five inventory slots)</td>
</tr>
<tr>
<td class="address-1"><span id="41760"></span>41760</td>
<td class="instruction">LD HL,51920</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "[Current Command] WHICH OBJECT ?" text</td>
</tr>
<tr>
<td class="address-1"><span id="41763"></span>41763</td>
<td class="instruction">LD DE,51928</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at "[Current Command] THE " text</td>
</tr>
<tr>
<td class="address-1"><span id="41766"></span>41766</td>
<td class="instruction">CALL <a href="45809.html">45809</a></td>
<td class="comment-1" rowspan="1">Show list of objects in Magic Knight's inventory (carrying) as a menu and load <span class="register">A</span> with selected item index</td>
</tr>
<tr>
<td class="address-1"><span id="41769"></span>41769</td>
<td class="instruction">LD HL,24848</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of Magic Knight's current inventory (carrying)</td>
</tr>
<tr>
<td class="address-1"><span id="41772"></span>41772</td>
<td class="instruction">CALL <a href="45766.html">45766</a></td>
<td class="comment-1" rowspan="1">Print name of selected object in Magic Knight's current inventory (carrying) in command summary window</td>
</tr>
<tr>
<td class="address-1"><span id="41775"></span>41775</td>
<td class="instruction">CALL <a href="64207.html">64207</a></td>
<td class="comment-1" rowspan="1">Display execute / reject command window and return here if execute chosen, else exit to main game loop</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41778"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="41748.html#41778">41778</a> represents the index of the Current Object used in multiple routines. This is modified by the instructions at <a href="41578.html#41668">41668</a> and <a href="45766.html#45771">45771</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="41778"></span>41778</td>
<td class="instruction">LD A,0</td>
<td class="comment-1" rowspan="1">Load index of Current Object into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="41780"></span>41780</td>
<td class="instruction">LD HL,51933</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "THE [name of Current Object] BLEW UP..." text</td>
</tr>
<tr>
<td class="address-1"><span id="41783"></span>41783</td>
<td class="instruction">CP 5</td>
<td class="comment-1" rowspan="1">If Current Object is 5 (Stick of Dynamite)...</td>
</tr>
<tr>
<td class="address-1"><span id="41785"></span>41785</td>
<td class="instruction">JP Z,<a href="64582.html">64582</a></td>
<td class="comment-1" rowspan="1">...then jump to "game over" window routine and return to control selection menu</td>
</tr>
<tr>
<td class="address-1"><span id="41788"></span>41788</td>
<td class="instruction">CALL <a href="45685.html">45685</a></td>
<td class="comment-1" rowspan="1">If Current Object is 4 (Teddy Bear) then display "THE BEAR SAYS..." message and wait for fire to be pressed</td>
</tr>
<tr>
<td class="address-1"><span id="41791"></span>41791</td>
<td class="instruction">LD E,0</td>
<td class="comment-1" rowspan="1">Load <span class="register">E</span> with 0 (prepare to check drop-status flag)</td>
</tr>
<tr>
<td class="address-1"><span id="41793"></span>41793</td>
<td class="instruction">CALL <a href="45390.html">45390</a></td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> to byte 0 of the <span class="register">A</span>-th record in object properties table</td>
</tr>
<tr>
<td class="address-1"><span id="41796"></span>41796</td>
<td class="instruction">BIT 4,(HL)</td>
<td class="comment-1" rowspan="1">Reset zero flag if object's drop-status flag is set</td>
</tr>
<tr>
<td class="address-1"><span id="41798"></span>41798</td>
<td class="instruction">LD HL,51970</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "YOU CANNOT [Current Command] THE [name of Current Object]" text</td>
</tr>
<tr>
<td class="address-1"><span id="41801"></span>41801</td>
<td class="instruction">JP NZ,<a href="64258.html#64261">64261</a></td>
<td class="comment-1" rowspan="1">...then display "YOU CANNOT [Current Command] THE [object]" window (13) and return to game</td>
</tr>
<tr>
<td class="address-1"><span id="41804"></span>41804</td>
<td class="instruction">LD A,(41779)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with index of Current Object</td>
</tr>
<tr>
<td class="address-1"><span id="41807"></span>41807</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Copy into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="41808"></span>41808</td>
<td class="instruction">LD B,5</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 5 (five inventory slots)</td>
</tr>
<tr>
<td class="address-1"><span id="41810"></span>41810</td>
<td class="instruction">LD HL,24848</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of Magic Knight's current inventory (carrying)</td>
</tr>
<tr>
<td class="address-1"><span id="41813"></span>41813</td>
<td class="instruction">CALL <a href="48341.html">48341</a></td>
<td class="comment-1" rowspan="1">Remove object <span class="register">C</span> from Magic Knight's current inventory (carrying)</td>
</tr>
<tr>
<td class="address-1"><span id="41816"></span>41816</td>
<td class="instruction">LD A,(23702)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current room</td>
</tr>
<tr>
<td class="address-1"><span id="41819"></span>41819</td>
<td class="instruction">CP 2</td>
<td class="comment-1" rowspan="1">If room is not 2 (Outdoors, 1, Bearwoolf's Cave)...</td>
</tr>
<tr>
<td class="address-1"><span id="41821"></span>41821</td>
<td class="instruction">JR NZ,41850</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="41748.html#41850">41850</a></td>
</tr>
<tr>
<td class="address-1"><span id="41823"></span>41823</td>
<td class="instruction">LD A,(41779)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with index of Current Object</td>
</tr>
<tr>
<td class="address-1"><span id="41826"></span>41826</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Multiply object index by 3...</td>
</tr>
<tr>
<td class="address-1"><span id="41827"></span>41827</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41828"></span>41828</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41829"></span>41829</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="41830"></span>41830</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with zero</td>
</tr>
<tr>
<td class="address-1"><span id="41832"></span>41832</td>
<td class="instruction">LD HL,24922</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of objects' current positions table at <a href="24922.html">24922</a></td>
</tr>
<tr>
<td class="address-1"><span id="41835"></span>41835</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add three times Current Object's index as offset to point <span class="register">HL</span> at position data of current object</td>
</tr>
<tr>
<td class="address-1"><span id="41836"></span>41836</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set object's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="41837"></span>41837</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...to be zero (Limbo)</td>
</tr>
<tr>
<td class="address-1"><span id="41838"></span>41838</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to x-coordinate of object...</td>
</tr>
<tr>
<td class="address-1"><span id="41839"></span>41839</td>
<td class="instruction">LD (HL),15</td>
<td class="comment-1" rowspan="1">...and set to 15</td>
</tr>
<tr>
<td class="address-1"><span id="41841"></span>41841</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to y-coordinate of object...</td>
</tr>
<tr>
<td class="address-1"><span id="41842"></span>41842</td>
<td class="instruction">LD (HL),22</td>
<td class="comment-1" rowspan="1">...and set to 22</td>
</tr>
<tr>
<td class="address-1"><span id="41844"></span>41844</td>
<td class="instruction">LD HL,51981</td>
<td class="comment-1" rowspan="1">Display "THE MAD JANITOR..." window (12) and return to game...</td>
</tr>
<tr>
<td class="address-1"><span id="41847"></span>41847</td>
<td class="instruction">JP <a href="64297.html">64297</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="41850"></span>41850</td>
<td class="instruction">LD A,(41779)</td>
<td class="comment-1" rowspan="1">Load <span class="register">C</span> with index of Current Object...</td>
</tr>
<tr>
<td class="address-1"><span id="41853"></span>41853</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41854"></span>41854</td>
<td class="instruction">CP 20</td>
<td class="comment-1" rowspan="1">If Current Object is 20 (Mirror)...</td>
</tr>
<tr>
<td class="address-1"><span id="41856"></span>41856</td>
<td class="instruction">CALL Z,<a href="41915.html">41915</a></td>
<td class="comment-1" rowspan="1">...then load <span class="register">C</span> with 7 (index of Broken Glass)</td>
</tr>
<tr>
<td class="address-1"><span id="41859"></span>41859</td>
<td class="instruction">CP 17</td>
<td class="comment-1" rowspan="1">If Current Object is 17 (Bottle of Liquid)...</td>
</tr>
<tr>
<td class="address-1"><span id="41861"></span>41861</td>
<td class="instruction">CALL Z,<a href="41918.html">41918</a></td>
<td class="comment-1" rowspan="1">...then load <span class="register">C</span> with 8 (index of Broken Glass)</td>
</tr>
<tr>
<td class="address-1"><span id="41864"></span>41864</td>
<td class="instruction">CP 18</td>
<td class="comment-1" rowspan="1">If Current Object is 18 (Bottle of Liquid)...</td>
</tr>
<tr>
<td class="address-1"><span id="41866"></span>41866</td>
<td class="instruction">CALL Z,<a href="41921.html">41921</a></td>
<td class="comment-1" rowspan="1">...then load <span class="register">C</span> with 9 (index of Broken Glass)</td>
</tr>
<tr>
<td class="address-1"><span id="41869"></span>41869</td>
<td class="instruction">CP 28</td>
<td class="comment-1" rowspan="1">If Current Object is 28 (Empty Bottle)...</td>
</tr>
<tr>
<td class="address-1"><span id="41871"></span>41871</td>
<td class="instruction">CALL Z,<a href="41918.html">41918</a></td>
<td class="comment-1" rowspan="1">...then load <span class="register">C</span> with 8 (index of Broken Glass)</td>
</tr>
<tr>
<td class="address-1"><span id="41874"></span>41874</td>
<td class="instruction">CP 29</td>
<td class="comment-1" rowspan="1">If Current Object is 29 (Empty Bottle)...</td>
</tr>
<tr>
<td class="address-1"><span id="41876"></span>41876</td>
<td class="instruction">CALL Z,<a href="41921.html">41921</a></td>
<td class="comment-1" rowspan="1">...then load <span class="register">C</span> with 9 (index of Broken Glass)</td>
</tr>
<tr>
<td class="address-1"><span id="41879"></span>41879</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Load object's index into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="41880"></span>41880</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">Multiply object index by 3...</td>
</tr>
<tr>
<td class="address-1"><span id="41881"></span>41881</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41882"></span>41882</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load back into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="41883"></span>41883</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with zero</td>
</tr>
<tr>
<td class="address-1"><span id="41885"></span>41885</td>
<td class="instruction">LD HL,24922</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of objects' current positions table at <a href="24922.html">24922</a></td>
</tr>
<tr>
<td class="address-1"><span id="41888"></span>41888</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add three times Current Object's index as offset to point <span class="register">HL</span> at position data of current object</td>
</tr>
<tr>
<td class="address-1"><span id="41889"></span>41889</td>
<td class="instruction">LD A,(23702)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current room</td>
</tr>
<tr>
<td class="address-1"><span id="41892"></span>41892</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Set object's current room to be same as Magic Knight's</td>
</tr>
<tr>
<td class="address-1"><span id="41893"></span>41893</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to x-coordinate of object</td>
</tr>
<tr>
<td class="address-1"><span id="41894"></span>41894</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to zero</td>
</tr>
<tr>
<td class="address-1"><span id="41896"></span>41896</td>
<td class="instruction">LD A,(24840)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current x-coordinate (pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="41899"></span>41899</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1">Get x-coordinate in terms of pixels within current character block (i.e. lowest 3 bits of x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="41901"></span>41901</td>
<td class="instruction">JR Z,41904</td>
<td class="comment-1" rowspan="1">If this is zero (i.e. Magic Knight at left-most pixel in character block) then skip ahead to <a href="41748.html#41904">41904</a>...</td>
</tr>
<tr>
<td class="address-1"><span id="41903"></span>41903</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">...else increase <span class="register">B</span></td>
</tr>
<tr>
<td class="address-2"><span id="41904"></span>41904</td>
<td class="instruction">CALL <a href="45584.html">45584</a></td>
<td class="comment-1" rowspan="1">Load Magic Knight's coordinates (in characters) into <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="41907"></span>41907</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="41908"></span>41908</td>
<td class="instruction">ADD A,E</td>
<td class="comment-1" rowspan="1">Add Magic Knight's x-coordinate to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="41909"></span>41909</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Set this as object's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="41910"></span>41910</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to y-coordinate of object</td>
</tr>
<tr>
<td class="address-1"><span id="41911"></span>41911</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-1" rowspan="1">Set this to same as Magic Knight's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="41912"></span>41912</td>
<td class="instruction">JP <a href="41578.html#41727">41727</a></td>
<td class="comment-1" rowspan="1">Show Magic Knight's current inventory and jump back to main game loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="41578.html">41578</a>
</td>
<td class="up">Up: <a href="../maps/all.html#41748">Map</a></td>
<td class="next">
Next: <a href="41915.html">41915</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Stormbringer (48k) RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1987 David Jones / Mastertronic (Stormbringer). &#169; 2014-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>