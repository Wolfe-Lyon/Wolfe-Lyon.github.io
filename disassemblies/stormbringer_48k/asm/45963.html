<!DOCTYPE html>
<html>
<head>
<title>Stormbringer (48k): Routine at 45963</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../stormbringer.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="45809.html">45809</a>
</td>
<td class="up">Up: <a href="../maps/all.html#45963">Map</a></td>
<td class="next">
Next: <a href="46106.html">46106</a>
</td>
</tr>
</table>
<div class="description">45963: Display and process input for character selection menu (current room's characters only)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="41924.html">41924</a>, <a href="42257.html">42257</a>, <a href="42638.html">42638</a>, <a href="43043.html">43043</a>, <a href="43636.html">43636</a> and <a href="44933.html">44933</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Pointer to text to append to menu's title string, after "WHO DO YOU WANT TO "</td>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Command summary text pointer (second row of text in command summary window)</td>
</tr>
</table>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">1 if there is at least one character in the room, zero otherwise</td>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Reset if there is at least one character in the room, set otherwise</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="45963"></span>45963</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span> (pointer to text to append to menu's title string)</td>
</tr>
<tr>
<td class="address-1"><span id="45964"></span>45964</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="45965"></span>45965</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="1">Store <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="45967"></span>45967</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Store <span class="register">DE</span> (command summary text pointer)</td>
</tr>
<tr>
<td class="address-1"><span id="45968"></span>45968</td>
<td class="instruction">CALL <a href="47938.html">47938</a></td>
<td class="comment-1" rowspan="1">Play short downward scale sound</td>
</tr>
<tr>
<td class="address-1"><span id="45971"></span>45971</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore <span class="register">DE</span> (command summary text pointer)</td>
</tr>
<tr>
<td class="address-1"><span id="45972"></span>45972</td>
<td class="instruction">CALL <a href="63388.html">63388</a></td>
<td class="comment-1" rowspan="1">Print text at command summary text pointer (e.g. "COMMAND ") in command summary window</td>
</tr>
<tr>
<td class="address-1"><span id="45975"></span>45975</td>
<td class="instruction">LD A,(23702)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="45978"></span>45978</td>
<td class="instruction">CALL <a href="46408.html">46408</a></td>
<td class="comment-1" rowspan="1">...and create list of characters in this room at <a href="23422.html">23422</a>, loading <span class="register">A</span> with number of characters</td>
</tr>
<tr>
<td class="address-1"><span id="45981"></span>45981</td>
<td class="instruction">JR NZ,46011</td>
<td class="comment-1" rowspan="1">If there are characters in this room then skip ahead to <a href="45963.html#46011">46011</a></td>
</tr>
<tr>
<td class="address-1"><span id="45983"></span>45983</td>
<td class="instruction">LD HL,51381</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "THERE IS NOBODY IN THIS ROOM" text</td>
</tr>
<tr>
<td class="address-1"><span id="45986"></span>45986</td>
<td class="instruction">LD DE,49140</td>
<td class="comment-1" rowspan="1">Adjust height of window 13 to accommodate text...</td>
</tr>
<tr>
<td class="address-1"><span id="45989"></span>45989</td>
<td class="instruction">CALL <a href="45617.html">45617</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="45992"></span>45992</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span> (pointer to start of text to print)</td>
</tr>
<tr>
<td class="address-1"><span id="45993"></span>45993</td>
<td class="instruction">LD A,13</td>
<td class="comment-1" rowspan="1">Draw window 13...</td>
</tr>
<tr>
<td class="address-1"><span id="45995"></span>45995</td>
<td class="instruction">CALL <a href="47193.html">47193</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="45998"></span>45998</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (pointer to start of text to print)</td>
</tr>
<tr>
<td class="address-1"><span id="45999"></span>45999</td>
<td class="instruction">CALL <a href="46902.html">46902</a></td>
<td class="comment-1" rowspan="1">Print text at <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="46002"></span>46002</td>
<td class="instruction">CALL <a href="64230.html">64230</a></td>
<td class="comment-1" rowspan="1">Wait for interrupt then display "PRESS FIRE TO CONTINUE" window and wait for fire to be pressed</td>
</tr>
<tr>
<td class="address-1"><span id="46005"></span>46005</td>
<td class="instruction">POP IX</td>
<td class="comment-1" rowspan="1">Restore <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="46007"></span>46007</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="46008"></span>46008</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (pointer to text to append to menu's title string)</td>
</tr>
<tr>
<td class="address-1"><span id="46009"></span>46009</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero and set zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="46010"></span>46010</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="address-2"><span id="46011"></span>46011</td>
<td class="instruction">ADD A,4</td>
<td class="comment-1" rowspan="1">Add four to number of characters in current room (for menu size padding)...</td>
</tr>
<tr>
<td class="address-1"><span id="46013"></span>46013</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load value into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="46014"></span>46014</td>
<td class="instruction">LD A,(49060)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with window's top y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="46017"></span>46017</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1">Add 4 + number of characters...</td>
</tr>
<tr>
<td class="address-1"><span id="46018"></span>46018</td>
<td class="instruction">LD (49061),A</td>
<td class="comment-1" rowspan="1">...and set window's bottom y-coordinate to this value</td>
</tr>
<tr>
<td class="address-1"><span id="46021"></span>46021</td>
<td class="instruction">POP IX</td>
<td class="comment-1" rowspan="1">Restore <span class="register">IX</span></td>
</tr>
<tr>
<td class="address-1"><span id="46023"></span>46023</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="46024"></span>46024</td>
<td class="instruction">LD A,3</td>
<td class="comment-1" rowspan="1">Draw window 3 as a menu window...</td>
</tr>
<tr>
<td class="address-1"><span id="46026"></span>46026</td>
<td class="instruction">CALL <a href="47185.html">47185</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="46029"></span>46029</td>
<td class="instruction">LD HL,51367</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "WHO DO YOU WANT TO " text...</td>
</tr>
<tr>
<td class="address-1"><span id="46032"></span>46032</td>
<td class="instruction">CALL <a href="46902.html">46902</a></td>
<td class="comment-1" rowspan="1">...and print to screen</td>
</tr>
<tr>
<td class="address-1"><span id="46035"></span>46035</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (pointer to text to append to menu's title string, as at beginning of this routine)</td>
</tr>
<tr>
<td class="address-1"><span id="46036"></span>46036</td>
<td class="instruction">CALL <a href="46902.html">46902</a></td>
<td class="comment-1" rowspan="1">Append this text to menu's title</td>
</tr>
<tr>
<td class="address-1"><span id="46039"></span>46039</td>
<td class="instruction">LD IX,23422</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> at list of characters in room</td>
</tr>
<tr>
<td class="address-1"><span id="46043"></span>46043</td>
<td class="instruction">LD B,8</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 8 (8 characters)</td>
</tr>
<tr>
<td class="address-2"><span id="46045"></span>46045</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (<span class="register">B</span> = remaining characters to process)</td>
</tr>
<tr>
<td class="address-1"><span id="46046"></span>46046</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with index of current character in list...</td>
</tr>
<tr>
<td class="address-1"><span id="46049"></span>46049</td>
<td class="instruction">CP 255</td>
<td class="comment-1" rowspan="1">...and if this is 255 (end marker)...</td>
</tr>
<tr>
<td class="address-1"><span id="46051"></span>46051</td>
<td class="instruction">JP Z,46095</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="45963.html#46095">46095</a></td>
</tr>
<tr>
<td class="address-1"><span id="46054"></span>46054</td>
<td class="instruction">LD HL,50753</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at text printing instructions to move cursor to start of next character row within window, then right by two characters</td>
</tr>
<tr>
<td class="address-1"><span id="46057"></span>46057</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="1">Store <span class="register">IX</span> (current position in list of characters in room)</td>
</tr>
<tr>
<td class="address-1"><span id="46059"></span>46059</td>
<td class="instruction">CALL <a href="46902.html">46902</a></td>
<td class="comment-1" rowspan="1">Print text at <span class="register">HL</span> to screen (i.e. move cursor)</td>
</tr>
<tr>
<td class="address-1"><span id="46062"></span>46062</td>
<td class="instruction">POP IX</td>
<td class="comment-1" rowspan="1">Restore <span class="register">IX</span> (current position in list of characters in room)</td>
</tr>
<tr>
<td class="address-1"><span id="46064"></span>46064</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with index of current character in list...</td>
</tr>
<tr>
<td class="address-1"><span id="46067"></span>46067</td>
<td class="instruction">LD (41937),A</td>
<td class="comment-1" rowspan="1">Set this character as the Current Character</td>
</tr>
<tr>
<td class="address-1"><span id="46070"></span>46070</td>
<td class="instruction">LD HL,45800</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at instruction to print full name of Current Character</td>
</tr>
<tr>
<td class="address-1"><span id="46073"></span>46073</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="1">Store <span class="register">IX</span> (current position in list of characters in room)</td>
</tr>
<tr>
<td class="address-1"><span id="46075"></span>46075</td>
<td class="instruction">CALL <a href="46902.html">46902</a></td>
<td class="comment-1" rowspan="1">Print text to screen</td>
</tr>
<tr>
<td class="address-1"><span id="46078"></span>46078</td>
<td class="instruction">POP IX</td>
<td class="comment-1" rowspan="1">Restore <span class="register">IX</span> (current position in list of characters in room)</td>
</tr>
<tr>
<td class="address-1"><span id="46080"></span>46080</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Advance <span class="register">IX</span> to next character in list</td>
</tr>
<tr>
<td class="address-1"><span id="46082"></span>46082</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (<span class="register">B</span> = remaining characters to process)</td>
</tr>
<tr>
<td class="address-1"><span id="46083"></span>46083</td>
<td class="instruction">DJNZ 46045</td>
<td class="comment-1" rowspan="1">Decrease <span class="register">B</span> and loop back to <a href="45963.html#46045">46045</a></td>
</tr>
<tr>
<td class="address-1"><span id="46085"></span>46085</td>
<td class="instruction">CALL <a href="47502.html">47502</a></td>
<td class="comment-1" rowspan="1">Process keyboard / joystick input on a menu and load <span class="register">A</span> with selected item index</td>
</tr>
<tr>
<td class="address-1"><span id="46088"></span>46088</td>
<td class="instruction">CALL <a href="45781.html">45781</a></td>
<td class="comment-1" rowspan="1">Update Current Character based upon selection made in menu</td>
</tr>
<tr>
<td class="address-1"><span id="46091"></span>46091</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with 1</td>
</tr>
<tr>
<td class="address-1"><span id="46093"></span>46093</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Reset zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="46094"></span>46094</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="address-2"><span id="46095"></span>46095</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (<span class="register">B</span> = remaining characters to process)</td>
</tr>
<tr>
<td class="address-1"><span id="46096"></span>46096</td>
<td class="instruction">CALL <a href="47502.html">47502</a></td>
<td class="comment-1" rowspan="1">Process keyboard / joystick input on a menu and load <span class="register">A</span> with selected item index</td>
</tr>
<tr>
<td class="address-1"><span id="46099"></span>46099</td>
<td class="instruction">CALL <a href="45781.html">45781</a></td>
<td class="comment-1" rowspan="1">Update Current Character based upon selection made in menu</td>
</tr>
<tr>
<td class="address-1"><span id="46102"></span>46102</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with 1</td>
</tr>
<tr>
<td class="address-1"><span id="46104"></span>46104</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">Reset zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="46105"></span>46105</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="45809.html">45809</a>
</td>
<td class="up">Up: <a href="../maps/all.html#45963">Map</a></td>
<td class="next">
Next: <a href="46106.html">46106</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Stormbringer (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1987 David Jones / Mastertronic (Stormbringer). &#169; 2014-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>