<!DOCTYPE html>
<html>
<head>
<title>Through the Trap Door: Routine at 41961</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../through-the-trap-door.css" />
<script type="text/javascript" src="../classDataXML.js"></script>
<script type="text/javascript" src="../classGLDCanvas.js"></script>
<script type="text/javascript" src="../classImageLoader.js"></script>
<script type="text/javascript" src="../classDisplayBuffer.js"></script>
<script type="text/javascript" src="../classBufferPair.js"></script>
<script type="text/javascript" src="../classGLDDrawer.js"></script>
<script type="text/javascript" src="../main.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="41767.html">41767</a></span></td>
<td class="up">Up: <a href="../maps/all.html#41961">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="42064.html">42064</a></span></td>
</tr>
</table>
<div class="description">41961: Update State of Cannon's Projectile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="41767.html">41767</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41961"></span>41961</td>
<td class="instruction">LD IX,45599</td>
<td class="comment-11" rowspan="1">Load IX with address of complex state data for Cannon's Projectile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41965"></span>41965</td>
<td class="instruction">LD A,(IX+1)</td>
<td class="comment-11" rowspan="1">If Projectile's depth is zero...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41968"></span>41968</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41969"></span>41969</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">...then return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41970"></span>41970</td>
<td class="instruction">LD BC,49699</td>
<td class="comment-11" rowspan="1">Set Projectile's graphic layout data address to that of drip stage 8, disconnected and falling (ball)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41973"></span>41973</td>
<td class="instruction">CALL <a href="42512.html">42512</a></td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41976"></span>41976</td>
<td class="instruction">LD A,(IX+9)</td>
<td class="comment-11" rowspan="1">If Projectile's state is zero (fired vertically)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41979"></span>41979</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41980"></span>41980</td>
<td class="instruction">JR Z,42015</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41961.html#42015">42015</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41982"></span>41982</td>
<td class="instruction">CP 8</td>
<td class="comment-11" rowspan="1">If Projectile's state is not 8 (finished)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41984"></span>41984</td>
<td class="instruction">JR NZ,41991</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41961.html#41991">41991</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41986"></span>41986</td>
<td class="instruction">LD (IX+1),0</td>
<td class="comment-11" rowspan="1">Set Projectile's depth to 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41990"></span>41990</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41991"></span>41991</td>
<td class="instruction">CP 2</td>
<td class="comment-11" rowspan="1">If Projectile's state is not 2 (fired right)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41993"></span>41993</td>
<td class="instruction">JR NZ,42006</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41961.html#42006">42006</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="41995"></span>
<div class="comments">
<div class="paragraph">
Projectile flying left
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41995"></span>41995</td>
<td class="instruction">CALL <a href="42381.html#42447">42447</a></td>
<td class="comment-11" rowspan="1">Move entity left two characters...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41998"></span>41998</td>
<td class="instruction">CALL <a href="42381.html#42447">42447</a></td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42001"></span>42001</td>
<td class="instruction">CALL <a href="54348.html">54348</a></td>
<td class="comment-11" rowspan="1">Move entity at IX into room to the left, if appropriate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42004"></span>42004</td>
<td class="instruction">JR 42015</td>
<td class="comment-11" rowspan="1">Skip ahead to <a href="41961.html#42015">42015</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="42006"></span>
<div class="comments">
<div class="paragraph">
Projectile flying right
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="42006"></span>42006</td>
<td class="instruction">CALL <a href="42505.html">42505</a></td>
<td class="comment-11" rowspan="1">Move entity right two characters...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42009"></span>42009</td>
<td class="instruction">CALL <a href="42505.html">42505</a></td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42012"></span>42012</td>
<td class="instruction">CALL <a href="54313.html">54313</a></td>
<td class="comment-11" rowspan="1">Move entity at IX into room to the right, if appropriate</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="42015"></span>
<div class="comments">
<div class="paragraph">
Update Projectile's vertical velocity
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="42015"></span>42015</td>
<td class="instruction">LD A,(IX+12)</td>
<td class="comment-11" rowspan="1">Load Projectile's velocity into A and E...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42018"></span>42018</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42019"></span>42019</td>
<td class="instruction">ADD A,(IX+4)</td>
<td class="comment-11" rowspan="1">Add velocity to y-coordinates of top and bottom of projectile...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42022"></span>42022</td>
<td class="instruction">LD (IX+4),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42025"></span>42025</td>
<td class="instruction">LD (IX+6),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42028"></span>42028</td>
<td class="instruction">INC (IX+12)</td>
<td class="comment-11" rowspan="1">Increase velocity by one (initially negative so will accelerate downwards)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42031"></span>42031</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1">If velocity (before increase) was not 5...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42032"></span>42032</td>
<td class="instruction">CP 5</td>
<td class="comment-11" rowspan="1">...i.e. projectile has not yet fallen back to floor-level...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42034"></span>42034</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">...then return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42035"></span>42035</td>
<td class="instruction">LD (IX+9),8</td>
<td class="comment-11" rowspan="1">Set Projectile's state to 8 (finished)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42039"></span>42039</td>
<td class="instruction">LD BC,51483</td>
<td class="comment-11" rowspan="1">Set Projectile's graphic layout data address to that of explosion (Bubo's Projectile / fallen drips, Level 4)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42042"></span>42042</td>
<td class="instruction">CALL <a href="42512.html">42512</a></td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42045"></span>42045</td>
<td class="instruction">CALL <a href="54768.html">54768</a></td>
<td class="comment-11" rowspan="1">Check entity at IX for collision with another entity at same depth whose Interaction (11,6) Flag is set...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42048"></span>42048</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">...and if no collision occurred, then return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42049"></span>42049</td>
<td class="instruction">CP 36</td>
<td class="comment-11" rowspan="1">If collision was not with entity of class 36 (skeleton, Level 4)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42051"></span>42051</td>
<td class="instruction">JR NZ,42058</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41961.html#42058">42058</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42053"></span>42053</td>
<td class="instruction">LD HL,45413</td>
<td class="comment-11" rowspan="1">Set Skeleton's Is Dying Flag...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42056"></span>42056</td>
<td class="instruction">SET 1,(HL)</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="42058"></span>42058</td>
<td class="instruction">CP 31</td>
<td class="comment-11" rowspan="1">If collision was with entity of class 31 (Berk)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42060"></span>42060</td>
<td class="instruction">CALL Z,<a href="53667.html">53667</a></td>
<td class="comment-11" rowspan="1">...then set "Berk Has Been Killed" Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="42063"></span>42063</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="41767.html">41767</a></span></td>
<td class="up">Up: <a href="../maps/all.html#41961">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="42064.html">42064</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Through the Trap Door RAM Disassembly 23/08/2017</div>
<div class="copyright">&#169; 1987 Don Priestley / Piranha / Alternative Software Ltd (Through the Trap Door). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>