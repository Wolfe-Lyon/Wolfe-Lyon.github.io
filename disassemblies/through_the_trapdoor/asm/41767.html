<!DOCTYPE html>
<html>
<head>
<title>Through the Trap Door: Routine at 41767</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../through_the_trap_door.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/memory_dump.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="41633.html">41633</a>
</td>
<td class="up">Up: <a href="../maps/all.html#41767">Map</a></td>
<td class="next">
Next: <a href="41961.html">41961</a>
</td>
</tr>
</table>
<div class="description">41767: Update state of cannon and projectile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="41211.html">41211</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41767"></span>41767</td>
<td class="instruction">CALL <a href="41961.html">41961</a></td>
<td class="comment-1" rowspan="1">Update state of cannon's projectile</td>
</tr>
<tr>
<td class="address-1"><span id="41770"></span>41770</td>
<td class="instruction">LD IX,45508</td>
<td class="comment-1" rowspan="1">Load <span class="register">IX</span> with address of complex state data for cannon (level 4)</td>
</tr>
<tr>
<td class="address-1"><span id="41774"></span>41774</td>
<td class="instruction">BIT 2,(IX+9)</td>
<td class="comment-1" rowspan="1">If cannon's just-loaded flag is reset...</td>
</tr>
<tr>
<td class="address-1"><span id="41778"></span>41778</td>
<td class="instruction">JR Z,41805</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="41767.html#41805">41805</a></td>
</tr>
<tr>
<td class="address-1"><span id="41780"></span>41780</td>
<td class="instruction">DEC (IX+12)</td>
<td class="comment-1" rowspan="1">Decrease cannon's fire timer...</td>
</tr>
<tr>
<td class="address-1"><span id="41783"></span>41783</td>
<td class="instruction">JR Z,41791</td>
<td class="comment-1" rowspan="1">...and if now zero then skip ahead to <a href="41767.html#41791">41791</a></td>
</tr>
<tr>
<td class="address-1"><span id="41785"></span>41785</td>
<td class="instruction">LD BC,42519</td>
<td class="comment-1" rowspan="1">Set cannon's graphic layout data address to point to graphic layout data for cannon (rocking) and return...</td>
</tr>
<tr>
<td class="address-1"><span id="41788"></span>41788</td>
<td class="instruction">JP <a href="42512.html">42512</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="41791"></span>41791</td>
<td class="instruction">RES 2,(IX+9)</td>
<td class="comment-1" rowspan="1">Reset cannon's just-loaded flag</td>
</tr>
<tr>
<td class="address-1"><span id="41795"></span>41795</td>
<td class="instruction">LD (IX+12),50</td>
<td class="comment-1" rowspan="1">Set cannon's fire timer to 50</td>
</tr>
<tr>
<td class="address-2"><span id="41799"></span>41799</td>
<td class="instruction">LD BC,42530</td>
<td class="comment-1" rowspan="1">Set cannon's graphic layout data address to point to graphic layout data for cannon (dormant) and return...</td>
</tr>
<tr>
<td class="address-1"><span id="41802"></span>41802</td>
<td class="instruction">JP <a href="42512.html">42512</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41805"></span>
<div class="comments">
<div class="paragraph">
Cannon's just-loaded flag is reset, so cannon has finished its rocking phase.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41805"></span>41805</td>
<td class="instruction">LD A,(34209)</td>
<td class="comment-1" rowspan="1">If cannon has no ammunition...</td>
</tr>
<tr>
<td class="address-1"><span id="41808"></span>41808</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41809"></span>41809</td>
<td class="instruction">JR Z,41799</td>
<td class="comment-1" rowspan="1">...then jump to <a href="41767.html#41799">41799</a> (cannon dormant)</td>
</tr>
<tr>
<td class="address-1"><span id="41811"></span>41811</td>
<td class="instruction">BIT 5,(IX+10)</td>
<td class="comment-1" rowspan="1">If cannon has its is-being-carried flag set...</td>
</tr>
<tr>
<td class="address-1"><span id="41815"></span>41815</td>
<td class="instruction">JR NZ,41799</td>
<td class="comment-1" rowspan="1">...then jump to <a href="41767.html#41799">41799</a> (cannon dormant)</td>
</tr>
<tr>
<td class="address-1"><span id="41817"></span>41817</td>
<td class="instruction">LD IY,(34240)</td>
<td class="comment-1" rowspan="1">Load <span class="register">IY</span> with address of current level's complex state data for Berk</td>
</tr>
<tr>
<td class="address-1"><span id="41821"></span>41821</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">If Berk's current room is the same as the cannon's room...</td>
</tr>
<tr>
<td class="address-1"><span id="41824"></span>41824</td>
<td class="instruction">CP (IY+0)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41827"></span>41827</td>
<td class="instruction">JR Z,41833</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="41767.html#41833">41833</a></td>
</tr>
<tr>
<td class="address-1"><span id="41829"></span>41829</td>
<td class="instruction">JR C,41860</td>
<td class="comment-1" rowspan="1">If index of Berk's current room is greater than the index of the cannon's room then skip ahead to <a href="41767.html#41860">41860</a></td>
</tr>
<tr>
<td class="address-1"><span id="41831"></span>41831</td>
<td class="instruction">JR 41871</td>
<td class="comment-1" rowspan="1">Skip ahead to <a href="41767.html#41871">41871</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41833"></span>
<div class="comments">
<div class="paragraph">
Berk and cannon in same room
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41833"></span>41833</td>
<td class="instruction">LD A,(IX+7)</td>
<td class="comment-1" rowspan="1">If x-coordinate of cannon's right side is smaller than x-coordinate of Berk's left side (i.e. cannon is to left of Berk)...</td>
</tr>
<tr>
<td class="address-1"><span id="41836"></span>41836</td>
<td class="instruction">CP (IY+5)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41839"></span>41839</td>
<td class="instruction">JR C,41860</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="41767.html#41860">41860</a></td>
</tr>
<tr>
<td class="address-1"><span id="41841"></span>41841</td>
<td class="instruction">LD A,(IY+7)</td>
<td class="comment-1" rowspan="1">If x-coordinate of Berk's right side is smaller than x-coordinate of cannon's left side (i.e. cannon is to right of Berk)...</td>
</tr>
<tr>
<td class="address-1"><span id="41844"></span>41844</td>
<td class="instruction">CP (IX+5)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41847"></span>41847</td>
<td class="instruction">JR C,41871</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="41767.html#41871">41871</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41849"></span>
<div class="comments">
<div class="paragraph">
Berk and cannon overlapping horizontally
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="41849"></span>41849</td>
<td class="instruction">LD E,1</td>
<td class="comment-1" rowspan="1">Load <span class="register">E</span> with 1 (as projectile will appear one character to the right of the cannon's coordinate position)</td>
</tr>
<tr>
<td class="address-1"><span id="41851"></span>41851</td>
<td class="instruction">LD (IX+9),0</td>
<td class="comment-1" rowspan="1">Prepare to set projectile's state to zero (fired vertically)</td>
</tr>
<tr>
<td class="address-1"><span id="41855"></span>41855</td>
<td class="instruction">LD BC,42530</td>
<td class="comment-1" rowspan="1">Load <span class="register">BC</span> with graphic layout data address for cannon (upright)</td>
</tr>
<tr>
<td class="address-1"><span id="41858"></span>41858</td>
<td class="instruction">JR 41880</td>
<td class="comment-1" rowspan="1">Skip ahead to <a href="41767.html#41880">41880</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41860"></span>
<div class="comments">
<div class="paragraph">
Berk is to the right of the cannon
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41860"></span>41860</td>
<td class="instruction">LD (IX+9),1</td>
<td class="comment-1" rowspan="1">Prepare to set projectile's state to 1 (fired left)</td>
</tr>
<tr>
<td class="address-1"><span id="41864"></span>41864</td>
<td class="instruction">LD E,2</td>
<td class="comment-1" rowspan="1">Load <span class="register">E</span> with 2 (as projectile will appear two characters to the right of the cannon's coordinate position)</td>
</tr>
<tr>
<td class="address-1"><span id="41866"></span>41866</td>
<td class="instruction">LD BC,42556</td>
<td class="comment-1" rowspan="1">Load <span class="register">BC</span> with graphic layout data address for cannon (tilted right)</td>
</tr>
<tr>
<td class="address-1"><span id="41869"></span>41869</td>
<td class="instruction">JR 41880</td>
<td class="comment-1" rowspan="1">Skip ahead to <a href="41767.html#41880">41880</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41871"></span>
<div class="comments">
<div class="paragraph">
Berk is to the left of the cannon
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41871"></span>41871</td>
<td class="instruction">LD (IX+9),2</td>
<td class="comment-1" rowspan="1">Prepare to set projectile's state to 2 (fired right)</td>
</tr>
<tr>
<td class="address-1"><span id="41875"></span>41875</td>
<td class="instruction">LD BC,42594</td>
<td class="comment-1" rowspan="1">Load <span class="register">BC</span> with graphic layout data address for cannon (tilted left)</td>
</tr>
<tr>
<td class="address-1"><span id="41878"></span>41878</td>
<td class="instruction">LD E,0</td>
<td class="comment-1" rowspan="1">Load <span class="register">E</span> with 0 (as projectile will appear at the same x-coordinate as in the cannon's coordinate position)</td>
</tr>
<tr>
<td class="address-2"><span id="41880"></span>41880</td>
<td class="instruction">CALL <a href="42512.html">42512</a></td>
<td class="comment-1" rowspan="1">Set cannon's graphic layout data address to value in <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="41883"></span>41883</td>
<td class="instruction">LD A,(IX+1)</td>
<td class="comment-1" rowspan="1">If cannon's depth is 2...</td>
</tr>
<tr>
<td class="address-1"><span id="41886"></span>41886</td>
<td class="instruction">CP 2</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41888"></span>41888</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return (cannon won't fire if it is placed behind Berk)</td>
</tr>
<tr>
<td class="address-1"><span id="41889"></span>41889</td>
<td class="instruction">LD A,(IX+12)</td>
<td class="comment-1" rowspan="1">If cannon's fire timer is at zero...</td>
</tr>
<tr>
<td class="address-1"><span id="41892"></span>41892</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41893"></span>41893</td>
<td class="instruction">JR Z,41899</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="41767.html#41899">41899</a></td>
</tr>
<tr>
<td class="address-1"><span id="41895"></span>41895</td>
<td class="instruction">DEC (IX+12)</td>
<td class="comment-1" rowspan="1">Decrease cannon's fire timer</td>
</tr>
<tr>
<td class="address-1"><span id="41898"></span>41898</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="41899"></span>
<div class="comments">
<div class="paragraph">
Cannon's fire timer is at zero
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="41899"></span>41899</td>
<td class="instruction">LD HL,34209</td>
<td class="comment-1" rowspan="1">Decrease ammunition level of cannon (level 4) by one...</td>
</tr>
<tr>
<td class="address-1"><span id="41902"></span>41902</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41903"></span>41903</td>
<td class="instruction">LD (IX+12),50</td>
<td class="comment-1" rowspan="1">Set cannon's fire timer to 50</td>
</tr>
<tr>
<td class="address-1"><span id="41907"></span>41907</td>
<td class="instruction">LD IY,45599</td>
<td class="comment-1" rowspan="1">Load <span class="register">IY</span> with address of complex state data for cannon's projectile</td>
</tr>
<tr>
<td class="address-1"><span id="41911"></span>41911</td>
<td class="instruction">LD A,(IX+5)</td>
<td class="comment-1" rowspan="1">Set x-coordinate of projectile's left and right sides to <span class="register">E</span> plus x-coordinate of cannon's left side...</td>
</tr>
<tr>
<td class="address-1"><span id="41914"></span>41914</td>
<td class="instruction">ADD A,E</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41915"></span>41915</td>
<td class="instruction">LD (IY+5),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41918"></span>41918</td>
<td class="instruction">LD (IY+7),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41921"></span>41921</td>
<td class="instruction">LD A,(IX+4)</td>
<td class="comment-1" rowspan="1">Set y-coordinates of top and bottom of projectile to be one less than cannon's top y-coordinate...</td>
</tr>
<tr>
<td class="address-1"><span id="41924"></span>41924</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41925"></span>41925</td>
<td class="instruction">LD (IY+4),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41928"></span>41928</td>
<td class="instruction">LD (IY+6),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41931"></span>41931</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Set projectile's room to same as cannon's room...</td>
</tr>
<tr>
<td class="address-1"><span id="41934"></span>41934</td>
<td class="instruction">LD (IY+0),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41937"></span>41937</td>
<td class="instruction">LD (IY+1),1</td>
<td class="comment-1" rowspan="1">Set projectile's depth to 1</td>
</tr>
<tr>
<td class="address-1"><span id="41941"></span>41941</td>
<td class="instruction">LD A,(IX+9)</td>
<td class="comment-1" rowspan="1">Set projectile's state to value prepared previously...</td>
</tr>
<tr>
<td class="address-1"><span id="41944"></span>41944</td>
<td class="instruction">LD (IY+9),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41947"></span>41947</td>
<td class="instruction">LD (IY+12),251</td>
<td class="comment-1" rowspan="1">Set projectile's y-velocity to -5</td>
</tr>
<tr>
<td class="address-1"><span id="41951"></span>41951</td>
<td class="instruction">LD BC,51483</td>
<td class="comment-1" rowspan="1">Set projectile's graphic layout data address to that for explosion (Bubo's projectile / fallen drips, level 4)...</td>
</tr>
<tr>
<td class="address-1"><span id="41954"></span>41954</td>
<td class="instruction">LD (IY+2),C</td>
<td class="comment-1" rowspan="1">...as projectile is launched from cannon in an explosion...</td>
</tr>
<tr>
<td class="address-1"><span id="41957"></span>41957</td>
<td class="instruction">LD (IY+3),B</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="41960"></span>41960</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="41633.html">41633</a>
</td>
<td class="up">Up: <a href="../maps/all.html#41767">Map</a></td>
<td class="next">
Next: <a href="41961.html">41961</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Through the Trap Door RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1987 Don Priestley / Piranha / Alternative Software Ltd (Through the Trap Door). &#169; 2015-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>