<!DOCTYPE html>
<html>
<head>
<title>Through the Trap Door: Routine at 51779</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../through_the_trap_door.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/memory_dump.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="51765.html">51765</a>
</td>
<td class="up">Up: <a href="../maps/all.html#51779">Map</a></td>
<td class="next">
Next: <a href="51890.html">51890</a>
</td>
</tr>
</table>
<div class="description">51779: Script routine: (43) Select next action for Drutt depending upon control input</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="48096.html">48096</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Address of complex state data (current level) for Drutt</td>
</tr>
</table>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">New address in script data</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="51779"></span>51779</td>
<td class="instruction">CALL <a href="54768.html">54768</a></td>
<td class="comment-1" rowspan="1">Check Drutt for collision with another entity at same depth whose interaction-(11,6) flag is set...</td>
</tr>
<tr>
<td class="address-1"><span id="51782"></span>51782</td>
<td class="instruction">CP 129</td>
<td class="comment-1" rowspan="1">...and if collision was not with entity of class 129 (causes other entities to start falling)...</td>
</tr>
<tr>
<td class="address-1"><span id="51784"></span>51784</td>
<td class="instruction">JR NZ,51792</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="51779.html#51792">51792</a></td>
</tr>
<tr>
<td class="address-1"><span id="51786"></span>51786</td>
<td class="instruction">CALL <a href="55516.html">55516</a></td>
<td class="comment-1" rowspan="1">Set Drutt's can-fall flag and initial velocity factor to 2</td>
</tr>
<tr>
<td class="address-1"><span id="51789"></span>51789</td>
<td class="instruction">JP <a href="52038.html">52038</a></td>
<td class="comment-1" rowspan="1">Move Drutt down one character, advance <span class="register">HL</span> to next script instruction and execute</td>
</tr>
<tr>
<td class="address-2"><span id="51792"></span>51792</td>
<td class="instruction">LD IY,(34244)</td>
<td class="comment-1" rowspan="1">Load <span class="register">IY</span> with address of current level's complex state data for worm</td>
</tr>
<tr>
<td class="address-1"><span id="51796"></span>51796</td>
<td class="instruction">LD A,(34208)</td>
<td class="comment-1" rowspan="1">If Drutt-mode flag is reset...</td>
</tr>
<tr>
<td class="address-1"><span id="51799"></span>51799</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="51801"></span>51801</td>
<td class="instruction">JR Z,51841</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="51779.html#51841">51841</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51803"></span>
<div class="comments">
<div class="paragraph">
Drutt-mode flag is set (i.e. Drutt mode)
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="51803"></span>51803</td>
<td class="instruction">SET 1,(IX+9)</td>
<td class="comment-1" rowspan="1">Set Drutt's under-player-control flag</td>
</tr>
<tr>
<td class="address-1"><span id="51807"></span>51807</td>
<td class="instruction">LD A,(34219)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with control input</td>
</tr>
<tr>
<td class="address-1"><span id="51810"></span>51810</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-1" rowspan="1">If right has been pressed...</td>
</tr>
<tr>
<td class="address-1"><span id="51812"></span>51812</td>
<td class="instruction">JR NZ,<a href="51904.html">51904</a></td>
<td class="comment-1" rowspan="1">...then randomly select script data for rightward hop of size three or four, and execute</td>
</tr>
<tr>
<td class="address-1"><span id="51814"></span>51814</td>
<td class="instruction">BIT 1,A</td>
<td class="comment-1" rowspan="1">If left has been pressed...</td>
</tr>
<tr>
<td class="address-1"><span id="51816"></span>51816</td>
<td class="instruction">JR NZ,<a href="51924.html">51924</a></td>
<td class="comment-1" rowspan="1">...then randomly select script data for leftward hop of size three or four, and execute</td>
</tr>
<tr>
<td class="address-1"><span id="51818"></span>51818</td>
<td class="instruction">BIT 2,A</td>
<td class="comment-1" rowspan="1">If forward has been pressed...</td>
</tr>
<tr>
<td class="address-1"><span id="51820"></span>51820</td>
<td class="instruction">JP NZ,<a href="51954.html">51954</a></td>
<td class="comment-1" rowspan="1">...then point <span class="register">HL</span> at script data for Drutt swapping depth levels and execute</td>
</tr>
<tr>
<td class="address-1"><span id="51823"></span>51823</td>
<td class="instruction">BIT 3,A</td>
<td class="comment-1" rowspan="1">If back has been pressed...</td>
</tr>
<tr>
<td class="address-1"><span id="51825"></span>51825</td>
<td class="instruction">JP NZ,<a href="51944.html">51944</a></td>
<td class="comment-1" rowspan="1">...then jump to <a href="51944.html">51944</a> (start Drutt jumping)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51828"></span>
<div class="comments">
<div class="paragraph">
At this point, no control has been pressed, so Drutt is effectively not under player control
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="51828"></span>51828</td>
<td class="instruction">RES 1,(IX+9)</td>
<td class="comment-1" rowspan="1">Reset Drutt's under-player-control flag</td>
</tr>
<tr>
<td class="address-1"><span id="51832"></span>51832</td>
<td class="instruction">LD A,(IY+1)</td>
<td class="comment-1" rowspan="1">If worm's depth is zero (i.e. not in play area)...</td>
</tr>
<tr>
<td class="address-1"><span id="51835"></span>51835</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="51836"></span>51836</td>
<td class="instruction">JR Z,51875</td>
<td class="comment-1" rowspan="1">...then randomly select an action for Drutt and execute</td>
</tr>
<tr>
<td class="address-1"><span id="51838"></span>51838</td>
<td class="instruction">JP <a href="51960.html">51960</a></td>
<td class="comment-1" rowspan="1">Move Drutt closer to the worm and eat it if close enough</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51841"></span>
<div class="comments">
<div class="paragraph">
Drutt-mode flag is reset (i.e. Berk mode)
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="51841"></span>51841</td>
<td class="instruction">RES 1,(IX+9)</td>
<td class="comment-1" rowspan="1">Reset Drutt's under-player-control flag</td>
</tr>
<tr>
<td class="address-1"><span id="51845"></span>51845</td>
<td class="instruction">LD A,(IY+1)</td>
<td class="comment-1" rowspan="1">If worm's depth is not zero (i.e. is in play area)...</td>
</tr>
<tr>
<td class="address-1"><span id="51848"></span>51848</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="51849"></span>51849</td>
<td class="instruction">JP NZ,<a href="51960.html">51960</a></td>
<td class="comment-1" rowspan="1">...then move Drutt closer to the worm and eat it if close enough</td>
</tr>
<tr>
<td class="address-1"><span id="51852"></span>51852</td>
<td class="instruction">LD IY,(34240)</td>
<td class="comment-1" rowspan="1">Load <span class="register">IY</span> with address of current level's complex state data for Berk</td>
</tr>
<tr>
<td class="address-1"><span id="51856"></span>51856</td>
<td class="instruction">LD A,(IY+0)</td>
<td class="comment-1" rowspan="1">If Drutt is in the same room as Berk...</td>
</tr>
<tr>
<td class="address-1"><span id="51859"></span>51859</td>
<td class="instruction">CP (IX+0)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="51862"></span>51862</td>
<td class="instruction">JR Z,51875</td>
<td class="comment-1" rowspan="1">...then randomly select an action for Drutt and execute</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51864"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="51960.html">51960</a>.
</div>
<div class="paragraph">
The following code will make Drutt move closer to the target (a worm, or Berk if in Berk mode) if the target's room is directly to the left or right of Drutt's room (i.e. no vertical separation). Otherwise, Drutt will perform a random action.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="51864"></span>51864</td>
<td class="instruction">CALL <a href="53194.html">53194</a></td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with value indicating which direction room <span class="register">A</span> lies relative to Drutt's current room</td>
</tr>
<tr>
<td class="address-1"><span id="51867"></span>51867</td>
<td class="instruction">CP 1</td>
<td class="comment-1" rowspan="1">If target room is to the right...</td>
</tr>
<tr>
<td class="address-1"><span id="51869"></span>51869</td>
<td class="instruction">JR Z,<a href="51904.html">51904</a></td>
<td class="comment-1" rowspan="1">...then randomly select script data for rightward hop of size three or four, and execute</td>
</tr>
<tr>
<td class="address-1"><span id="51871"></span>51871</td>
<td class="instruction">CP 2</td>
<td class="comment-1" rowspan="1">If target room is to the left...</td>
</tr>
<tr>
<td class="address-1"><span id="51873"></span>51873</td>
<td class="instruction">JR Z,<a href="51924.html">51924</a></td>
<td class="comment-1" rowspan="1">...then randomly select script data for leftward hop of size three or four, and execute</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="51875"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="51960.html">51960</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="51875"></span>51875</td>
<td class="instruction">LD A,7</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with a random number, 0-6...</td>
</tr>
<tr>
<td class="address-1"><span id="51877"></span>51877</td>
<td class="instruction">CALL <a href="54222.html">54222</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="51880"></span>51880</td>
<td class="instruction">LD DE,51890</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at table of addresses of script data for Drutt's actions...</td>
</tr>
<tr>
<td class="address-1"><span id="51883"></span>51883</td>
<td class="instruction">CALL <a href="53814.html">53814</a></td>
<td class="comment-1" rowspan="1">...and load <span class="register">DE</span> with entry of index <span class="register">A</span> in this table</td>
</tr>
<tr>
<td class="address-1"><span id="51886"></span>51886</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Switch <span class="register">DE</span> and <span class="register">HL</span> (now contains address of randomly selected script data)</td>
</tr>
<tr>
<td class="address-1"><span id="51887"></span>51887</td>
<td class="instruction">JP <a href="48096.html#48098">48098</a></td>
<td class="comment-1" rowspan="1">Execute script data at address in <span class="register">HL</span></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="51765.html">51765</a>
</td>
<td class="up">Up: <a href="../maps/all.html#51779">Map</a></td>
<td class="next">
Next: <a href="51890.html">51890</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Through the Trap Door RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1987 Don Priestley / Piranha / Alternative Software Ltd (Through the Trap Door). &#169; 2015-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>