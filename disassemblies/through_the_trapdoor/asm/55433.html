<!DOCTYPE html>
<html>
<head>
<title>Through the Trap Door: Routine at 55433</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../through-the-trap-door.css" />
<script type="text/javascript" src="../classDataXML.js"></script>
<script type="text/javascript" src="../classGLDCanvas.js"></script>
<script type="text/javascript" src="../classImageLoader.js"></script>
<script type="text/javascript" src="../classDisplayBuffer.js"></script>
<script type="text/javascript" src="../classBufferPair.js"></script>
<script type="text/javascript" src="../classGLDDrawer.js"></script>
<script type="text/javascript" src="../main.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="55421.html">55421</a></span></td>
<td class="up">Up: <a href="../maps/all.html#55433">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="55516.html">55516</a></span></td>
</tr>
</table>
<div class="description">55433: Change Entity's Room Up One if Appropriate</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="36542.html">36542</a>, <a href="48487.html">48487</a> and <a href="55196.html">55196</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Address of complex state data for an entity</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="55433"></span>55433</td>
<td class="instruction">LD A,99</td>
<td class="comment-11" rowspan="1">If y-coordinate of top of entity is larger than 99 (i.e. top of entity is below top of room)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55435"></span>55435</td>
<td class="instruction">CP (IX+4)</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55438"></span>55438</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">...then return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55439"></span>55439</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Store HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55440"></span>55440</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55441"></span>55441</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Store DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55442"></span>55442</td>
<td class="instruction">LD IY,(34254)</td>
<td class="comment-11" rowspan="1">Load start address of current level's Vertical Room Connectivity Data into IY</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55446"></span>55446</td>
<td class="instruction">INC IY</td>
<td class="comment-11" rowspan="1">Advance by one byte to second byte (lower room index) of first entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55448"></span>55448</td>
<td class="instruction">LD D,(IX+0)</td>
<td class="comment-11" rowspan="1">Load current room of entity into D</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="55451"></span>55451</td>
<td class="instruction">LD A,(IY+0)</td>
<td class="comment-11" rowspan="1">Load second byte (lower room index) of current entry into A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55454"></span>55454</td>
<td class="instruction">CP 255</td>
<td class="comment-11" rowspan="1">If byte is 255 (i.e. the End Marker)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55456"></span>55456</td>
<td class="instruction">JR Z,55512</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="55433.html#55512">55512</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55458"></span>55458</td>
<td class="instruction">CP D</td>
<td class="comment-11" rowspan="1">If byte is the same as the entity's current room...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55459"></span>55459</td>
<td class="instruction">JR Z,55467</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="55433.html#55467">55467</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55461"></span>55461</td>
<td class="instruction">INC IY</td>
<td class="comment-11" rowspan="1">Advance by two bytes to the next entry...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55463"></span>55463</td>
<td class="instruction">INC IY</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55465"></span>55465</td>
<td class="instruction">JR 55451</td>
<td class="comment-11" rowspan="1">Loop back to <a href="55433.html#55451">55451</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="55467"></span>55467</td>
<td class="instruction">LD B,(IY-1)</td>
<td class="comment-11" rowspan="1">Load first byte (upper room index) of current entry into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55470"></span>55470</td>
<td class="instruction">LD A,(34231)</td>
<td class="comment-11" rowspan="1">Load position (chars) of left side of current room (old, that entity is leaving) into D...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55473"></span>55473</td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55474"></span>55474</td>
<td class="instruction">CALL <a href="54480.html">54480</a></td>
<td class="comment-11" rowspan="1">Set room of entity to B, store room size data for new room and load E with entity's width minus one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55477"></span>55477</td>
<td class="instruction">LD A,(34231)</td>
<td class="comment-11" rowspan="1">Load position (chars) of left side of current room (new, that entity has entered) into A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55480"></span>55480</td>
<td class="instruction">SUB D</td>
<td class="comment-11" rowspan="1">Subtract x-coordinate of old room's left edge from x-coordinate of new room's left edge...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55481"></span>55481</td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="1">...and place result in D</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55482"></span>55482</td>
<td class="instruction">LD A,(IX+5)</td>
<td class="comment-11" rowspan="1">Load A with x-coordinate of left of entity...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55485"></span>55485</td>
<td class="instruction">SUB D</td>
<td class="comment-11" rowspan="1">...subtract difference in positions of rooms' left edges...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55486"></span>55486</td>
<td class="instruction">LD (IX+5),A</td>
<td class="comment-11" rowspan="1">...and store</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55489"></span>55489</td>
<td class="instruction">ADD A,E</td>
<td class="comment-11" rowspan="1">Update x-coordinate of right of entity by adding entity's (width - 1) value...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55490"></span>55490</td>
<td class="instruction">LD (IX+7),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55493"></span>55493</td>
<td class="instruction">LD A,(IX+4)</td>
<td class="comment-11" rowspan="1">Add 22 to y-coordinate of top of entity...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55496"></span>55496</td>
<td class="instruction">ADD A,22</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55498"></span>55498</td>
<td class="instruction">LD (IX+4),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55501"></span>55501</td>
<td class="instruction">LD A,(IX+6)</td>
<td class="comment-11" rowspan="1">Add 22 to y-coordinate of bottom of entity...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55504"></span>55504</td>
<td class="instruction">ADD A,22</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55506"></span>55506</td>
<td class="instruction">LD (IX+6),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55509"></span>55509</td>
<td class="instruction">CALL <a href="54456.html">54456</a></td>
<td class="comment-11" rowspan="1">Paint red areas outside current character's room if IX points to current character's complex state data</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="55512"></span>55512</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55513"></span>55513</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55514"></span>55514</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="55515"></span>55515</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="55421.html">55421</a></span></td>
<td class="up">Up: <a href="../maps/all.html#55433">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="55516.html">55516</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Through the Trap Door RAM Disassembly 23/08/2017</div>
<div class="copyright">&#169; 1987 Don Priestley / Piranha / Alternative Software Ltd (Through the Trap Door). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>