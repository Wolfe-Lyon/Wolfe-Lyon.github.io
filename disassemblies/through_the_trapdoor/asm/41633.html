<!DOCTYPE html>
<html>
<head>
<title>Through the Trap Door: Routine at 41633</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../through-the-trap-door.css" />
<script type="text/javascript" src="../classDataXML.js"></script>
<script type="text/javascript" src="../classGLDCanvas.js"></script>
<script type="text/javascript" src="../classImageLoader.js"></script>
<script type="text/javascript" src="../classDisplayBuffer.js"></script>
<script type="text/javascript" src="../classBufferPair.js"></script>
<script type="text/javascript" src="../classGLDDrawer.js"></script>
<script type="text/javascript" src="../main.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="41617.html">41617</a></span></td>
<td class="up">Up: <a href="../maps/all.html#41633">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="41767.html">41767</a></span></td>
</tr>
</table>
<div class="description">41633: Update State of Ghost</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="41211.html">41211</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41633"></span>41633</td>
<td class="instruction">LD IX,45794</td>
<td class="comment-11" rowspan="1">Load IX with address of complex state data for Ghost (Level 4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41637"></span>41637</td>
<td class="instruction">CALL <a href="54768.html">54768</a></td>
<td class="comment-11" rowspan="1">Check entity at IX for collision with another entity at same depth whose Interaction (11,6) Flag is set...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41640"></span>41640</td>
<td class="instruction">CP 31</td>
<td class="comment-11" rowspan="1">...and if collision was not with entity of class 31 (Berk)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41642"></span>41642</td>
<td class="instruction">JR NZ,41653</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41633.html#41653">41653</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="41644"></span>
<div class="comments">
<div class="paragraph">
If collision was with Berk, then IY will point to Berk's complex state data
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41644"></span>41644</td>
<td class="instruction">BIT 6,(IY+9)</td>
<td class="comment-11" rowspan="1">If Berk is not flying...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41648"></span>41648</td>
<td class="instruction">JR Z,41653</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41633.html#41653">41653</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41650"></span>41650</td>
<td class="instruction">CALL <a href="53667.html">53667</a></td>
<td class="comment-11" rowspan="1">Set "Berk Has Been Killed" Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41653"></span>41653</td>
<td class="instruction">LD A,(34218)</td>
<td class="comment-11" rowspan="1">Load E with current character's current room index...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41656"></span>41656</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41657"></span>41657</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-11" rowspan="1">Load A with Ghost's current room index</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41660"></span>41660</td>
<td class="instruction">LD C,(IX+4)</td>
<td class="comment-11" rowspan="1">Load C with y-coordinate of Ghost's top edge</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41663"></span>41663</td>
<td class="instruction">LD B,(IX+6)</td>
<td class="comment-11" rowspan="1">Load B with y-coordinate of Ghost's bottom edge</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41666"></span>41666</td>
<td class="instruction">BIT 0,(IX+9)</td>
<td class="comment-11" rowspan="1">If Ghost's Moving Upwards Flag is set...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41670"></span>41670</td>
<td class="instruction">JR NZ,41716</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41633.html#41716">41716</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41672"></span>41672</td>
<td class="instruction">CP 4</td>
<td class="comment-11" rowspan="1">If Ghost's current room is 4 (room above pit)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41674"></span>41674</td>
<td class="instruction">JR Z,41687</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41633.html#41687">41687</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41676"></span>41676</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">If y-coordinate of Ghost's bottom edge...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41677"></span>41677</td>
<td class="instruction">CP 119</td>
<td class="comment-11" rowspan="1">...is not 119...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41679"></span>41679</td>
<td class="instruction">JP NZ,<a href="42266.html#42360">42360</a></td>
<td class="comment-11" rowspan="1">...then move Ghost down one character and return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41682"></span>41682</td>
<td class="instruction">SET 0,(IX+9)</td>
<td class="comment-11" rowspan="1">Set Ghost's Moving Upwards Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41686"></span>41686</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="41687"></span>
<div class="comments">
<div class="paragraph">
Ghost's current room is 4 (room above pit)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41687"></span>41687</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">If current character is in the same room as the Ghost...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41688"></span>41688</td>
<td class="instruction">JR Z,41703</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41633.html#41703">41703</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41690"></span>41690</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">If y-coordinate of Ghost's bottom edge...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41691"></span>41691</td>
<td class="instruction">CP 119</td>
<td class="comment-11" rowspan="1">...is not 119...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41693"></span>41693</td>
<td class="instruction">JP NZ,<a href="42266.html#42360">42360</a></td>
<td class="comment-11" rowspan="1">...then move Ghost down one character and return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41696"></span>41696</td>
<td class="instruction">INC (IX+0)</td>
<td class="comment-11" rowspan="1">Increase index of Ghost's current room (to 5, pit)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41699"></span>41699</td>
<td class="instruction">LD A,94</td>
<td class="comment-11" rowspan="1">Position Ghost such that the y-coordinate of its top edge is 115...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41701"></span>41701</td>
<td class="instruction">JR 41758</td>
<td class="comment-11" rowspan="1">...and return</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="41703"></span>
<div class="comments">
<div class="paragraph">
Current character and Ghost in same room (room above pit)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41703"></span>41703</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">If y-coordinate of Ghost's top edge...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41704"></span>41704</td>
<td class="instruction">CP 121</td>
<td class="comment-11" rowspan="1">...is not 121...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41706"></span>41706</td>
<td class="instruction">JP NZ,<a href="42266.html#42360">42360</a></td>
<td class="comment-11" rowspan="1">...then move Ghost down one character and return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41709"></span>41709</td>
<td class="instruction">INC (IX+0)</td>
<td class="comment-11" rowspan="1">Increase index of Ghost's current room (to 5, pit)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41712"></span>41712</td>
<td class="instruction">LD A,100</td>
<td class="comment-11" rowspan="1">Position Ghost such that the y-coordinate of its top edge is 100...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41714"></span>41714</td>
<td class="instruction">JR 41758</td>
<td class="comment-11" rowspan="1">...and return</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="41716"></span>
<div class="comments">
<div class="paragraph">
Ghost's Moving Upwards Flag is set
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41716"></span>41716</td>
<td class="instruction">CP 5</td>
<td class="comment-11" rowspan="1">If Ghost's current room is 5 (pit)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41718"></span>41718</td>
<td class="instruction">JR Z,41731</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41633.html#41731">41731</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41720"></span>41720</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">If y-coordinate of Ghost's top edge...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41721"></span>41721</td>
<td class="instruction">CP 101</td>
<td class="comment-11" rowspan="1">...is not 101...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41723"></span>41723</td>
<td class="instruction">JP NZ,<a href="42266.html#42374">42374</a></td>
<td class="comment-11" rowspan="1">...then move Ghost up one character and return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41726"></span>41726</td>
<td class="instruction">RES 0,(IX+9)</td>
<td class="comment-11" rowspan="1">Reset Ghost's Moving Upwards Flag (i.e. moving downwards)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41730"></span>41730</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="41731"></span>
<div class="comments">
<div class="paragraph">
Ghost's current room is 5 (pit)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41731"></span>41731</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">If current character is in the same room as the Ghost...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41732"></span>41732</td>
<td class="instruction">JR Z,41747</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="41633.html#41747">41747</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41734"></span>41734</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">If y-coordinate of Ghost's top edge...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41735"></span>41735</td>
<td class="instruction">CP 101</td>
<td class="comment-11" rowspan="1">...is not 101...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41737"></span>41737</td>
<td class="instruction">JP NZ,<a href="42266.html#42374">42374</a></td>
<td class="comment-11" rowspan="1">...then move Ghost up one character and return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41740"></span>41740</td>
<td class="instruction">DEC (IX+0)</td>
<td class="comment-11" rowspan="1">Decrease index of Ghost's current room (to 4, room above pit)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41743"></span>41743</td>
<td class="instruction">LD A,121</td>
<td class="comment-11" rowspan="1">Position Ghost such that the y-coordinate of its top edge is 121...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41745"></span>41745</td>
<td class="instruction">JR 41758</td>
<td class="comment-11" rowspan="1">...and return</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="41747"></span>
<div class="comments">
<div class="paragraph">
Current character and Ghost in same room (pit)
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41747"></span>41747</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">If y-coordinate of Ghost's bottom edge...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41748"></span>41748</td>
<td class="instruction">CP 100</td>
<td class="comment-11" rowspan="1">...is not 100...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41750"></span>41750</td>
<td class="instruction">JP NZ,<a href="42266.html#42374">42374</a></td>
<td class="comment-11" rowspan="1">...then move Ghost up one character and return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41753"></span>41753</td>
<td class="instruction">DEC (IX+0)</td>
<td class="comment-11" rowspan="1">Decrease index of Ghost's current room (to 4, room above pit)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41756"></span>41756</td>
<td class="instruction">LD A,115</td>
<td class="comment-11" rowspan="1">Prepare to set y-coordinate of Ghost's top edge to 115</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="41758"></span>41758</td>
<td class="instruction">LD (IX+4),A</td>
<td class="comment-11" rowspan="1">Set y-coordinate of Ghost's top edge to value in A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41761"></span>41761</td>
<td class="instruction">ADD A,6</td>
<td class="comment-11" rowspan="1">Add 6 to value in A (as Ghost is 6 characters tall)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41763"></span>41763</td>
<td class="instruction">LD (IX+6),A</td>
<td class="comment-11" rowspan="1">...and set y-coordinate of Ghost's bottom edge to value in A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="41766"></span>41766</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="41617.html">41617</a></span></td>
<td class="up">Up: <a href="../maps/all.html#41633">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="41767.html">41767</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Through the Trap Door RAM Disassembly 23/08/2017</div>
<div class="copyright">&#169; 1987 Don Priestley / Piranha / Alternative Software Ltd (Through the Trap Door). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>