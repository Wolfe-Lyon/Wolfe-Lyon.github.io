<!DOCTYPE html>
<html>
<head>
<title>Through the Trap Door: Routine at 45899</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../through_the_trap_door.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/memory_dump.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="45895.html">45895</a>
</td>
<td class="up">Up: <a href="../maps/all.html#45899">Map</a></td>
<td class="next">
Next: <a href="45965.html">45965</a>
</td>
</tr>
</table>
<div class="description">45899: Populate primary display buffer with layout data for current character's current room</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="34438.html">34438</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="45899"></span>45899</td>
<td class="instruction">LD HL,(34279)</td>
<td class="comment-1" rowspan="1">Modify instruction at <a href="45999.html#46045">46045</a> with address of primary display buffer...</td>
</tr>
<tr>
<td class="address-1"><span id="45902"></span>45902</td>
<td class="instruction">LD (46046),HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="45905"></span>45905</td>
<td class="instruction">LD A,(34230)</td>
<td class="comment-1" rowspan="1">Load <span class="register">C</span> with depth of current character's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="45908"></span>45908</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="45909"></span>45909</td>
<td class="instruction">LD A,(34218)</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with index of current character's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="45912"></span>45912</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="45913"></span>45913</td>
<td class="instruction">LD D,0</td>
<td class="comment-1" rowspan="1">Load <span class="register">D</span> with zero</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="45915"></span>
<div class="comments">
<div class="paragraph">
Start drawing simple entities
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="45915"></span>45915</td>
<td class="instruction">LD IX,(34236)</td>
<td class="comment-1" rowspan="1">Load <span class="register">IX</span> with start address of current level's simple state data</td>
</tr>
<tr>
<td class="address-1"><span id="45919"></span>45919</td>
<td class="instruction">LD E,6</td>
<td class="comment-1" rowspan="1">Load <span class="register">DE</span> with 6 (as simple state data entries are 6 bytes wide)</td>
</tr>
<tr>
<td class="address-2"><span id="45921"></span>45921</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Load first byte of current simple state data entry into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="45924"></span>45924</td>
<td class="instruction">CP 255</td>
<td class="comment-1" rowspan="1">If this is 255 (end marker for complex state data)...</td>
</tr>
<tr>
<td class="address-1"><span id="45926"></span>45926</td>
<td class="instruction">JR Z,45961</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="45899.html#45961">45961</a></td>
</tr>
<tr>
<td class="address-1"><span id="45928"></span>45928</td>
<td class="instruction">CP 254</td>
<td class="comment-1" rowspan="1">If it is not 254 (end marker for level's simple state data)...</td>
</tr>
<tr>
<td class="address-1"><span id="45930"></span>45930</td>
<td class="instruction">JR NZ,45939</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="45899.html#45939">45939</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="45932"></span>
<div class="comments">
<div class="paragraph">
At this point, we have passed the end marker for the simple state data block and are now at the start of the complex state data block whose entries are 13 bytes wide.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="45932"></span>45932</td>
<td class="instruction">LD E,13</td>
<td class="comment-1" rowspan="1">Load <span class="register">DE</span> with 13</td>
</tr>
<tr>
<td class="address-1"><span id="45934"></span>45934</td>
<td class="instruction">INC IX</td>
<td class="comment-1" rowspan="1">Advance <span class="register">IX</span> to start of complex state data block</td>
</tr>
<tr>
<td class="address-1"><span id="45936"></span>45936</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with entity's room index</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="45939"></span>
<div class="comments">
<div class="paragraph">
At this point, <span class="register">A</span> holds the index of the room to which the simple or complex entity belongs
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="45939"></span>45939</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">If entity's room is not the same as the current character's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="45940"></span>45940</td>
<td class="instruction">JR NZ,45957</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="45899.html#45957">45957</a></td>
</tr>
<tr>
<td class="address-1"><span id="45942"></span>45942</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">If entity's depth is not the same as current depth in <span class="register">C</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="45943"></span>45943</td>
<td class="instruction">CP (IX+1)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="45946"></span>45946</td>
<td class="instruction">JR NZ,45957</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="45899.html#45957">45957</a></td>
</tr>
<tr>
<td class="address-1"><span id="45948"></span>45948</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Switch registers</td>
</tr>
<tr>
<td class="address-1"><span id="45949"></span>45949</td>
<td class="instruction">PUSH IX</td>
<td class="comment-1" rowspan="1">Store <span class="register">IX</span> (pointer to current entry in simple/complex state data)</td>
</tr>
<tr>
<td class="address-1"><span id="45951"></span>45951</td>
<td class="instruction">CALL <a href="45965.html">45965</a></td>
<td class="comment-1" rowspan="1">Load primary display buffer with graphic layout data for current entity</td>
</tr>
<tr>
<td class="address-1"><span id="45954"></span>45954</td>
<td class="instruction">POP IX</td>
<td class="comment-1" rowspan="1">Restore <span class="register">IX</span> (pointer to current entry in simple/complex state data)</td>
</tr>
<tr>
<td class="address-1"><span id="45956"></span>45956</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Switch registers</td>
</tr>
<tr>
<td class="address-2"><span id="45957"></span>45957</td>
<td class="instruction">ADD IX,DE</td>
<td class="comment-1" rowspan="1">Advance <span class="register">IX</span> to next entity's state data</td>
</tr>
<tr>
<td class="address-1"><span id="45959"></span>45959</td>
<td class="instruction">JR 45921</td>
<td class="comment-1" rowspan="1">Loop back to <a href="45899.html#45921">45921</a></td>
</tr>
<tr>
<td class="address-2"><span id="45961"></span>45961</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Decrease current depth (i.e. closer to screen)</td>
</tr>
<tr>
<td class="address-1"><span id="45962"></span>45962</td>
<td class="instruction">JR NZ,45915</td>
<td class="comment-1" rowspan="1">If depth is not zero (i.e. still depth levels to process) then loop back to <a href="45899.html#45915">45915</a></td>
</tr>
<tr>
<td class="address-1"><span id="45964"></span>45964</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="45895.html">45895</a>
</td>
<td class="up">Up: <a href="../maps/all.html#45899">Map</a></td>
<td class="next">
Next: <a href="45965.html">45965</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Through the Trap Door RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1987 Don Priestley / Piranha / Alternative Software Ltd (Through the Trap Door). &#169; 2015-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>