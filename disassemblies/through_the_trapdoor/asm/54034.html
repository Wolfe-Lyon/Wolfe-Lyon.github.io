<!DOCTYPE html>
<html>
<head>
<title>Through the Trap Door: Routine at 54034</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../through-the-trap-door.css" />
<script type="text/javascript" src="../classDataXML.js"></script>
<script type="text/javascript" src="../classGLDCanvas.js"></script>
<script type="text/javascript" src="../classImageLoader.js"></script>
<script type="text/javascript" src="../classDisplayBuffer.js"></script>
<script type="text/javascript" src="../classBufferPair.js"></script>
<script type="text/javascript" src="../classGLDDrawer.js"></script>
<script type="text/javascript" src="../main.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="54019.html">54019</a></span></td>
<td class="up">Up: <a href="../maps/all.html#54034">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="54144.html">54144</a></span></td>
</tr>
</table>
<div class="description">54034: Draw Contents of Primary Display Buffer to Display</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
If either the graphic index, or the graphic set index for the current entry in the Primary Display Buffer is zero, then only the attribute from that entry is rendered; the currently displayed bitmap data (from the previous frame) is preserved.
</div>
<div class="paragraph">
Used by the routine at <a href="34438.html">34438</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54034"></span>54034</td>
<td class="instruction">LD IX,22528</td>
<td class="comment-11" rowspan="1">Point IX at first byte of Attribute File</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54038"></span>54038</td>
<td class="instruction">LD HL,61312</td>
<td class="comment-11" rowspan="1">Point HL at Display Buffer 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54041"></span>54041</td>
<td class="instruction">LD DE,63424</td>
<td class="comment-11" rowspan="1">Point DE at Display Buffer 2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54044"></span>54044</td>
<td class="instruction">LD A,(34271)</td>
<td class="comment-11" rowspan="1">If "Display Buffer 2 is Primary" Flag is reset...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54047"></span>54047</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">...i.e. Display Buffer 1 is Primary...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54048"></span>54048</td>
<td class="instruction">JP Z,54052</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54052">54052</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54051"></span>54051</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">Switch DE and HL (Display Buffer 1 is Secondary, Display Buffer 2 is Primary)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54052"></span>54052</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Copy address of Secondary Display Buffer into IY...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54053"></span>54053</td>
<td class="instruction">POP IY</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54055"></span>54055</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Read Graphic Set Index from Primary Display Buffer into A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54056"></span>54056</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance HL to next byte (Graphic Index) in Primary Display Buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54057"></span>54057</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">If Graphic Set Index is zero...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54058"></span>54058</td>
<td class="instruction">JP Z,54130</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54130">54130</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54061"></span>54061</td>
<td class="instruction">CP 255</td>
<td class="comment-11" rowspan="1">If Graphic Set Index is 255 (character block outside room's dimensions)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54063"></span>54063</td>
<td class="instruction">JP Z,54140</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54140">54140</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54066"></span>54066</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Transfer Graphic Set Index into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54067"></span>54067</td>
<td class="instruction">LD E,0</td>
<td class="comment-11" rowspan="1">Set E to zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54069"></span>54069</td>
<td class="instruction">CP (IY+0)</td>
<td class="comment-11" rowspan="1">If Graphic Set Index in Primary Display Buffer entry is different to Graphic Set Index in Secondary Display Buffer entry...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54072"></span>54072</td>
<td class="instruction">JP NZ,54076</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54076">54076</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54075"></span>54075</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Increase E</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54076"></span>54076</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Load Graphic Index from Primary Display Buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54077"></span>54077</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">If Graphic Index is zero...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54078"></span>54078</td>
<td class="instruction">JP Z,54130</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54130">54130</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54081"></span>54081</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Transfer Graphic Index into C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54082"></span>54082</td>
<td class="instruction">CP (IY+1)</td>
<td class="comment-11" rowspan="1">If Graphic Index in Primary Display Buffer is different to Graphic Index in Secondary Display Buffer...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54085"></span>54085</td>
<td class="instruction">JP NZ,54089</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54089">54089</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54088"></span>54088</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Increase E</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54089"></span>54089</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance HL to third byte (attribute) in Primary Display Buffer entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54090"></span>54090</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Read attribute from Primary Display Buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54091"></span>54091</td>
<td class="instruction">CP (IY+2)</td>
<td class="comment-11" rowspan="1">If attribute in Display Buffer entry A is different to attribute in Secondary Display Buffer entry...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54094"></span>54094</td>
<td class="instruction">JP NZ,54102</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54102">54102</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54097"></span>54097</td>
<td class="instruction">BIT 1,E</td>
<td class="comment-11" rowspan="1">If E is 2 (i.e. both Graphic Set Index and Graphic Index are the same)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54099"></span>54099</td>
<td class="instruction">JP NZ,54107</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54107">54107</a>, over drawing instructions (no need to redraw what is already there)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54102"></span>54102</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Store HL (pointer to current position in Primary Display Buffer)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54103"></span>54103</td>
<td class="instruction">CALL <a href="54144.html">54144</a></td>
<td class="comment-11" rowspan="1">Draw a graphic character block to display</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54106"></span>54106</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore HL (pointer to current position in Primary Display Buffer)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54107"></span>54107</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance HL to next byte in Primary Display Buffer (start of next entry)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54108"></span>54108</td>
<td class="instruction">INC IX</td>
<td class="comment-11" rowspan="1">Advance IX to next byte in Attribute File</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54110"></span>54110</td>
<td class="instruction">PUSH IX</td>
<td class="comment-11" rowspan="1">Copy current Attribute File address from IX to DE...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54112"></span>54112</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54113"></span>54113</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1">If current Attribute File address is not at the start of the seventh row of a third of the display (i.e. row 7, 15 or 23)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54114"></span>54114</td>
<td class="instruction">CP 192</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54116"></span>54116</td>
<td class="instruction">JR NZ,54122</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="54034.html#54122">54122</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54118"></span>54118</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1">If current Attribute File address is 23232 (256*90 + 192, i.e. at start of second last display character row)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54119"></span>54119</td>
<td class="instruction">CP 90</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54121"></span>54121</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">...then return, as only timer figures appear in last two rows</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54122"></span>54122</td>
<td class="instruction">LD DE,3</td>
<td class="comment-11" rowspan="1">Advance current position in Secondary Display Buffer by 3 bytes...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54125"></span>54125</td>
<td class="instruction">ADD IY,DE</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54127"></span>54127</td>
<td class="instruction">JP 54055</td>
<td class="comment-11" rowspan="1">Loop back to <a href="54034.html#54055">54055</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54130"></span>54130</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance HL to third byte (attribute) in Primary Display Buffer entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54131"></span>54131</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Load attribute into A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54132"></span>54132</td>
<td class="instruction">SET 6,A</td>
<td class="comment-11" rowspan="1">Set BRIGHT flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54134"></span>54134</td>
<td class="instruction">LD (IX+0),A</td>
<td class="comment-11" rowspan="1">Place attribute at current position in Attribute File</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54137"></span>54137</td>
<td class="instruction">JP 54107</td>
<td class="comment-11" rowspan="1">Loop back to <a href="54034.html#54107">54107</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="54140"></span>54140</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Advance HL to third byte (attribute) in Primary Display Buffer entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="54141"></span>54141</td>
<td class="instruction">JP 54107</td>
<td class="comment-11" rowspan="1">Loop back to <a href="54034.html#54107">54107</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="54019.html">54019</a></span></td>
<td class="up">Up: <a href="../maps/all.html#54034">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="54144.html">54144</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Through the Trap Door RAM Disassembly 23/08/2017</div>
<div class="copyright">&#169; 1987 Don Priestley / Piranha / Alternative Software Ltd (Through the Trap Door). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>