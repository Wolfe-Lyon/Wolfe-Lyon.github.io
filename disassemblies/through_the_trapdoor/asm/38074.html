<!DOCTYPE html>
<html>
<head>
<title>Through the Trap Door: Routine at 38074</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../through-the-trap-door.css" />
<script type="text/javascript" src="../classDataXML.js"></script>
<script type="text/javascript" src="../classGLDCanvas.js"></script>
<script type="text/javascript" src="../classImageLoader.js"></script>
<script type="text/javascript" src="../classDisplayBuffer.js"></script>
<script type="text/javascript" src="../classBufferPair.js"></script>
<script type="text/javascript" src="../classGLDDrawer.js"></script>
<script type="text/javascript" src="../main.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="38054.html">38054</a></span></td>
<td class="up">Up: <a href="../maps/all.html#38074">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="38165.html">38165</a></span></td>
</tr>
</table>
<div class="description">38074: Update State of Bubo</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="38054.html">38054</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Address of complex state data for Bubo (Level 2)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="38074"></span>38074</td>
<td class="instruction">BIT 3,(IX+9)</td>
<td class="comment-11" rowspan="1">If Bubo's Harmless Flag is set...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38078"></span>38078</td>
<td class="instruction">JR NZ,38101</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="38074.html#38101">38101</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38080"></span>38080</td>
<td class="instruction">LD A,(34220)</td>
<td class="comment-11" rowspan="1">If Berk's current power is not immunity to Bubo (Level 2)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38083"></span>38083</td>
<td class="instruction">CP 9</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38085"></span>38085</td>
<td class="instruction">JR NZ,38093</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="38074.html#38093">38093</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38087"></span>38087</td>
<td class="instruction">SET 3,(IX+9)</td>
<td class="comment-11" rowspan="1">Set Bubo's Harmless Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38091"></span>38091</td>
<td class="instruction">JR 38101</td>
<td class="comment-11" rowspan="1">Skip ahead to <a href="38074.html#38101">38101</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="38093"></span>38093</td>
<td class="instruction">CALL <a href="54768.html">54768</a></td>
<td class="comment-11" rowspan="1">Check entity at IX for collision with another entity at same depth whose Interaction (11,6) Flag is set...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38096"></span>38096</td>
<td class="instruction">CP 31</td>
<td class="comment-11" rowspan="1">...and if collision was with entity of class 31 (Berk)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38098"></span>38098</td>
<td class="instruction">CALL Z,<a href="53667.html">53667</a></td>
<td class="comment-11" rowspan="1">...then set "Berk Has Been Killed" Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="38101"></span>38101</td>
<td class="instruction">LD IY,44214</td>
<td class="comment-11" rowspan="1">Load IY with address of complex state data for Bubo's Projectile (Level 2)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38105"></span>38105</td>
<td class="instruction">BIT 0,(IX+9)</td>
<td class="comment-11" rowspan="1">If Bubo's Must Process Current Script Data Flag is set (Bubo firing)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38109"></span>38109</td>
<td class="instruction">JP NZ,<a href="48096.html">48096</a></td>
<td class="comment-11" rowspan="1">...then jump to <a href="48096.html">48096</a> (advance HL to next script instruction and execute)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38112"></span>38112</td>
<td class="instruction">BIT 1,(IY+9)</td>
<td class="comment-11" rowspan="1">If Projectile's Fired Flag is set...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38116"></span>38116</td>
<td class="instruction">JP NZ,<a href="48096.html">48096</a></td>
<td class="comment-11" rowspan="1">...then jump to <a href="48096.html">48096</a> (advance HL to next script instruction and execute)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38119"></span>38119</td>
<td class="instruction">BIT 5,(IX+10)</td>
<td class="comment-11" rowspan="1">If Bubo is not being carried...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38123"></span>38123</td>
<td class="instruction">JR Z,38132</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="38074.html#38132">38132</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38125"></span>38125</td>
<td class="instruction">SET 2,(IX+9)</td>
<td class="comment-11" rowspan="1">Set Bubo's Waiting to Fire Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38129"></span>38129</td>
<td class="instruction">JP <a href="48096.html">48096</a></td>
<td class="comment-11" rowspan="1">Advance HL to next script instruction and execute</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="38132"></span>
<div class="comments">
<div class="paragraph">
The code block below is only entered if Bubo's Must Process Current Script Data Flag is reset (i.e. he is not firing), the Projectile's Fired Flag is reset and Bubo is not being carried.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="38132"></span>38132</td>
<td class="instruction">LD A,(IX+1)</td>
<td class="comment-11" rowspan="1">If Bubo has a depth of 2...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38135"></span>38135</td>
<td class="instruction">CP 2</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38137"></span>38137</td>
<td class="instruction">JP Z,<a href="48096.html">48096</a></td>
<td class="comment-11" rowspan="1">...then jump to <a href="48096.html">48096</a> (advance HL to next script instruction and execute)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38140"></span>38140</td>
<td class="instruction">BIT 2,(IX+9)</td>
<td class="comment-11" rowspan="1">If Bubo's Waiting to Fire Flag is set, i.e. he has just been dropped...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38144"></span>38144</td>
<td class="instruction">JR NZ,38155</td>
<td class="comment-11" rowspan="1">...then skip ahead to <a href="38074.html#38155">38155</a> (make Bubo fire)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38146"></span>38146</td>
<td class="instruction">LD A,60</td>
<td class="comment-11" rowspan="1">Load A with a random number, 0-59...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38148"></span>38148</td>
<td class="instruction">CALL <a href="54222.html">54222</a></td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38151"></span>38151</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">...and if this is not zero (59 in 60 chance)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38152"></span>38152</td>
<td class="instruction">JP NZ,<a href="48096.html">48096</a></td>
<td class="comment-11" rowspan="1">...then jump to <a href="48096.html">48096</a> (advance HL to next script instruction and execute)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="38155"></span>38155</td>
<td class="instruction">RES 2,(IX+9)</td>
<td class="comment-11" rowspan="1">Reset Bubo's Waiting to Fire Flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38159"></span>38159</td>
<td class="instruction">LD HL,38032</td>
<td class="comment-11" rowspan="1">Point HL at script data for Bubo firing...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="38162"></span>38162</td>
<td class="instruction">JP <a href="48096.html#48098">48098</a></td>
<td class="comment-11" rowspan="1">...and execute</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="38054.html">38054</a></span></td>
<td class="up">Up: <a href="../maps/all.html#38074">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="38165.html">38165</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Through the Trap Door RAM Disassembly 23/08/2017</div>
<div class="copyright">&#169; 1987 Don Priestley / Piranha / Alternative Software Ltd (Through the Trap Door). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.0.</div>
</footer>
</body>
</html>