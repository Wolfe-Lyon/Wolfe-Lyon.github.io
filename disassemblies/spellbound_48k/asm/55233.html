<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 55233</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="55219.html">55219</a>
</td>
<td class="up">Up: <a href="../maps/all.html#55233">Map</a></td>
<td class="next">
Next: <a href="55349.html">55349</a>
</td>
</tr>
</table>
<div class="description">55233: Interrupt routine: If character is free and awake, then update their current room if possible</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="54996.html">54996</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">23610</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="55233"></span>55233</td>
<td class="instruction">BIT 2,(IY+65)</td>
<td class="comment-1" rowspan="1">If characters-can't-move flag is set...</td>
</tr>
<tr>
<td class="address-1"><span id="55237"></span>55237</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">...then return without moving characters</td>
</tr>
<tr>
<td class="address-1"><span id="55238"></span>55238</td>
<td class="instruction">LD A,(55218)</td>
<td class="comment-1" rowspan="1">Load "character to move" index into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55241"></span>55241</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Increase by one, but cap at 31 and reset to zero if now above this...</td>
</tr>
<tr>
<td class="address-1"><span id="55242"></span>55242</td>
<td class="instruction">AND 31</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55244"></span>55244</td>
<td class="instruction">LD (55218),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55247"></span>55247</td>
<td class="instruction">AND 24</td>
<td class="comment-1" rowspan="1">Return if value is over 7...</td>
</tr>
<tr>
<td class="address-1"><span id="55249"></span>55249</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55250"></span>55250</td>
<td class="instruction">LD A,(55218)</td>
<td class="comment-1" rowspan="1">Load "character to move" index into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55253"></span>55253</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If value is not zero...</td>
</tr>
<tr>
<td class="address-1"><span id="55254"></span>55254</td>
<td class="instruction">JR NZ,55264</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="55233.html#55264">55264</a></td>
</tr>
<tr>
<td class="address-1"><span id="55256"></span>55256</td>
<td class="instruction">LD A,(23468)</td>
<td class="comment-1" rowspan="1">If Gimbal is not free...</td>
</tr>
<tr>
<td class="address-1"><span id="55259"></span>55259</td>
<td class="instruction">AND 1</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55261"></span>55261</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-1"><span id="55262"></span>55262</td>
<td class="instruction">JR 55274</td>
<td class="comment-1" rowspan="1">Skip ahead to <a href="55233.html#55274">55274</a></td>
</tr>
<tr>
<td class="address-2"><span id="55264"></span>55264</td>
<td class="instruction">CP 7</td>
<td class="comment-1" rowspan="1">If value is not 7...</td>
</tr>
<tr>
<td class="address-1"><span id="55266"></span>55266</td>
<td class="instruction">JR NZ,55274</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="55233.html#55274">55274</a></td>
</tr>
<tr>
<td class="address-1"><span id="55268"></span>55268</td>
<td class="instruction">LD A,(23467)</td>
<td class="comment-1" rowspan="1">If Banshee not released...</td>
</tr>
<tr>
<td class="address-1"><span id="55271"></span>55271</td>
<td class="instruction">AND 1</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55273"></span>55273</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-2"><span id="55274"></span>55274</td>
<td class="instruction">LD A,(55218)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with "character to move" index</td>
</tr>
<tr>
<td class="address-1"><span id="55277"></span>55277</td>
<td class="instruction">LD E,6</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at character's asleep flag...</td>
</tr>
<tr>
<td class="address-1"><span id="55279"></span>55279</td>
<td class="instruction">CALL <a href="34174.html">34174</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55282"></span>55282</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">...and if character is asleep...</td>
</tr>
<tr>
<td class="address-1"><span id="55284"></span>55284</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-1"><span id="55285"></span>55285</td>
<td class="instruction">LD A,(55218)</td>
<td class="comment-1" rowspan="1">Load "character to move" index into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55288"></span>55288</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Multiply by three (as data entries are three bytes wide)...</td>
</tr>
<tr>
<td class="address-1"><span id="55289"></span>55289</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55290"></span>55290</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55291"></span>55291</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Load into <span class="register">BC</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="55292"></span>55292</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55294"></span>55294</td>
<td class="instruction">LD HL,25440</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of current character positions table</td>
</tr>
<tr>
<td class="address-1"><span id="55297"></span>55297</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add <span class="register">BC</span> as offset</td>
</tr>
<tr>
<td class="address-1"><span id="55298"></span>55298</td>
<td class="instruction">LD A,(65529)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current room into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55301"></span>55301</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">If Magic Knight and the character are both in the same room...</td>
</tr>
<tr>
<td class="address-1"><span id="55302"></span>55302</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-1"><span id="55303"></span>55303</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy Magic Knight's current room into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="55304"></span>55304</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">If character's current room is not 99...</td>
</tr>
<tr>
<td class="address-1"><span id="55305"></span>55305</td>
<td class="instruction">CP 99</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55307"></span>55307</td>
<td class="instruction">JR NZ,55319</td>
<td class="comment-1" rowspan="1">...then jump to <a href="55233.html#55319">55319</a></td>
</tr>
<tr>
<td class="address-1"><span id="55309"></span>55309</td>
<td class="instruction">CP 100</td>
<td class="comment-1" rowspan="2">If character's current room is 100 (i.e. character has been sent home) then return <a href="../reference/bugs.html#characterroomcheck">bug</a></td>
</tr>
<tr>
<td class="address-1"><span id="55311"></span>55311</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="address-1"><span id="55312"></span>55312</td>
<td class="instruction">LD A,(55218)</td>
<td class="comment-1" rowspan="1">Current room is 99 (character has been commanded to go away), so calculate the index of that character's "go away base room"...</td>
</tr>
<tr>
<td class="address-1"><span id="55315"></span>55315</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...((4 &times; character index) + 5)...</td>
</tr>
<tr>
<td class="address-1"><span id="55316"></span>55316</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55317"></span>55317</td>
<td class="instruction">ADD A,5</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="55319"></span>55319</td>
<td class="instruction">CALL <a href="55404.html">55404</a></td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with new room index for character to move into based upon current room</td>
</tr>
<tr>
<td class="address-1"><span id="55322"></span>55322</td>
<td class="instruction">CP 255</td>
<td class="comment-1" rowspan="1">If new room index is 255...</td>
</tr>
<tr>
<td class="address-1"><span id="55324"></span>55324</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-1"><span id="55325"></span>55325</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">If new room index is same as Magic Knight's current room...</td>
</tr>
<tr>
<td class="address-1"><span id="55326"></span>55326</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-1"><span id="55327"></span>55327</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Store <span class="register">AF</span> (<span class="register">A</span> = new room index)</td>
</tr>
<tr>
<td class="address-1"><span id="55328"></span>55328</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Load new room index into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="55329"></span>55329</td>
<td class="instruction">LD A,(55218)</td>
<td class="comment-1" rowspan="1">Load "character to move" index into <span class="register">B</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="55332"></span>55332</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55333"></span>55333</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span> (pointer to character's current room)</td>
</tr>
<tr>
<td class="address-1"><span id="55334"></span>55334</td>
<td class="instruction">CALL <a href="36327.html">36327</a></td>
<td class="comment-1" rowspan="1">Assign a slot in room <span class="register">C</span> to character <span class="register">B</span> and get x- and y-coordinates in <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="55337"></span>55337</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (pointer to character's current room)</td>
</tr>
<tr>
<td class="address-1"><span id="55338"></span>55338</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore <span class="register">DE</span> (was <span class="register">AF</span>, now <span class="register">D</span> = new room index)</td>
</tr>
<tr>
<td class="address-1"><span id="55339"></span>55339</td>
<td class="instruction">CP 4</td>
<td class="comment-1" rowspan="1">If new room is full...</td>
</tr>
<tr>
<td class="address-1"><span id="55341"></span>55341</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">...then return</td>
</tr>
<tr>
<td class="address-1"><span id="55342"></span>55342</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1">Copy new room index into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55343"></span>55343</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Set character to be at coordinates (<span class="register">C</span>, <span class="register">B</span>) in room <span class="register">A</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="55344"></span>55344</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55345"></span>55345</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55346"></span>55346</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55347"></span>55347</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55348"></span>55348</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="55219.html">55219</a>
</td>
<td class="up">Up: <a href="../maps/all.html#55233">Map</a></td>
<td class="next">
Next: <a href="55349.html">55349</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2010-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>