<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 35993</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="35931.html">35931</a></span></td>
<td class="up">Up: <a href="../maps/all.html#35993">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="36173.html">36173</a></span></td>
</tr>
</table>
<div class="description">35993: Update Position of Odd Ball, Display, and Decrease Magic Knight's Strength if in Contact</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="29776.html">29776</a> and <a href="29874.html">29874</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Ball number (0, 1, 2 or 3)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="35993"></span>35993</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">Multiply value of A by eight...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="35994"></span>35994</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="35995"></span>35995</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="35996"></span>35996</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Store in C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="35997"></span>35997</td>
<td class="instruction">LD B,0</td>
<td class="comment-11" rowspan="1">Set B to zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="35999"></span>35999</td>
<td class="instruction">LD IX,36183</td>
<td class="comment-11" rowspan="1">Set IX to point to data for balls</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36003"></span>36003</td>
<td class="instruction">ADD IX,BC</td>
<td class="comment-11" rowspan="1">Add eight times ball number as offset to IX pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36005"></span>36005</td>
<td class="instruction">LD C,(IX+0)</td>
<td class="comment-11" rowspan="1">Load ball's x-coordinate into C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36008"></span>36008</td>
<td class="instruction">LD B,(IX+1)</td>
<td class="comment-11" rowspan="1">Load ball's y-coordinate into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36011"></span>36011</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36012"></span>36012</td>
<td class="instruction">LD (23677),BC</td>
<td class="comment-11" rowspan="1">Load BC into system variable "COORDS"</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36016"></span>36016</td>
<td class="instruction">LD A,(IX+4)</td>
<td class="comment-11" rowspan="1">Load A with ball's current frame number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36019"></span>36019</td>
<td class="instruction">PUSH IX</td>
<td class="comment-11" rowspan="1">Store IX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36021"></span>36021</td>
<td class="instruction">CALL <a href="39125.html">39125</a></td>
<td class="comment-11" rowspan="1">Draw Odd Ball to screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36024"></span>36024</td>
<td class="instruction">POP IX</td>
<td class="comment-11" rowspan="1">Restore IX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36026"></span>36026</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36027"></span>36027</td>
<td class="instruction">LD A,(IX+2)</td>
<td class="comment-11" rowspan="1">Load x-velocity into A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36030"></span>36030</td>
<td class="instruction">ADD A,C</td>
<td class="comment-11" rowspan="1">Add x-coordinate to A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36031"></span>36031</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Load new x-coordinate back into C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36032"></span>36032</td>
<td class="instruction">LD A,(IX+3)</td>
<td class="comment-11" rowspan="1">Load y-velocity into A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36035"></span>36035</td>
<td class="instruction">ADD A,B</td>
<td class="comment-11" rowspan="1">Add y-coordinate to A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36036"></span>36036</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Load new y-coordinate back into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36037"></span>36037</td>
<td class="instruction">LD (IX+0),C</td>
<td class="comment-11" rowspan="1">Update data with new x-...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36040"></span>36040</td>
<td class="instruction">LD (IX+1),B</td>
<td class="comment-11" rowspan="1">...and y-coordinates</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36043"></span>36043</td>
<td class="instruction">LD (23677),BC</td>
<td class="comment-11" rowspan="1">Update "COORDS" system variable</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36047"></span>36047</td>
<td class="instruction">LD A,(IX+4)</td>
<td class="comment-11" rowspan="1">Load A with Odd Ball frame data</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36050"></span>36050</td>
<td class="instruction">SUB 116</td>
<td class="comment-11" rowspan="1">Subtract 116 (i.e. frame number of first Odd Ball frame) to get "absolute frame number" (<a href="../reference/facts.html#oddballframenumbers">see trivia</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36052"></span>36052</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Advance absolute frame number by one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36053"></span>36053</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="1">Cap absolute frame number to 3, and wrap round from 3 to 0 as there are only four frames</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36055"></span>36055</td>
<td class="instruction">ADD A,116</td>
<td class="comment-11" rowspan="1">Add 116 to absolute frame number to give relative frame number again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36057"></span>36057</td>
<td class="instruction">LD (IX+4),A</td>
<td class="comment-11" rowspan="1">Store new frame number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36060"></span>36060</td>
<td class="instruction">PUSH IX</td>
<td class="comment-11" rowspan="1">Store IX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36062"></span>36062</td>
<td class="instruction">CALL <a href="39125.html">39125</a></td>
<td class="comment-11" rowspan="1">Draw Odd Ball to screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36065"></span>36065</td>
<td class="instruction">POP IX</td>
<td class="comment-11" rowspan="1">Restore IX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36067"></span>36067</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-11" rowspan="1">Load x-coordinate of ball</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36070"></span>36070</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">If x-coordinate is zero...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36071"></span>36071</td>
<td class="instruction">CALL Z,<a href="36173.html">36173</a></td>
<td class="comment-11" rowspan="1">...multiply x "velocity" by minus one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36074"></span>36074</td>
<td class="instruction">CP 244</td>
<td class="comment-11" rowspan="1">If x-coordinate is 244...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36076"></span>36076</td>
<td class="instruction">CALL Z,<a href="36173.html">36173</a></td>
<td class="comment-11" rowspan="1">...multiply x "velocity" by minus one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36079"></span>36079</td>
<td class="instruction">INC IX</td>
<td class="comment-11" rowspan="1">Temporarily advance IX pointer to work with y "velocities"</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36081"></span>36081</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-11" rowspan="1">Load y-coordinate of ball</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36084"></span>36084</td>
<td class="instruction">CP 172</td>
<td class="comment-11" rowspan="1">If y-coordinate is 172...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36086"></span>36086</td>
<td class="instruction">CALL Z,<a href="36173.html">36173</a></td>
<td class="comment-11" rowspan="1">...multiply y "velocity" by minus one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36089"></span>36089</td>
<td class="instruction">CP 40</td>
<td class="comment-11" rowspan="1">If y-coordinate is 40...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36091"></span>36091</td>
<td class="instruction">CALL Z,<a href="36173.html">36173</a></td>
<td class="comment-11" rowspan="1">...multiply y "velocity" by minus one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36094"></span>36094</td>
<td class="instruction">DEC IX</td>
<td class="comment-11" rowspan="1">Move IX back one again (reversing instruction at <a href="35993.html#36079">36079</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36096"></span>36096</td>
<td class="instruction">LD A,(25387)</td>
<td class="comment-11" rowspan="1">Load A with Magic Knight's current x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36099"></span>36099</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36100"></span>36100</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-11" rowspan="1">Load A with x-coordinate of ball</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36103"></span>36103</td>
<td class="instruction">ADD A,6</td>
<td class="comment-11" rowspan="1">Add 6 to x-coordinate of ball</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36105"></span>36105</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1">Subtract B to get x-distance between Magic Knight and the ball, plus 6</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36106"></span>36106</td>
<td class="instruction">CP 21</td>
<td class="comment-11" rowspan="1">If this value is not less than 21 then...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36108"></span>36108</td>
<td class="instruction">JP NC,36172</td>
<td class="comment-11" rowspan="1">...return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36111"></span>36111</td>
<td class="instruction">LD A,(25388)</td>
<td class="comment-11" rowspan="1">Else, load B with Magic Knight's y-coordinate...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36114"></span>36114</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36115"></span>36115</td>
<td class="instruction">LD A,(IX+1)</td>
<td class="comment-11" rowspan="1">Load A with y-coordinate of ball (uses same coordinate system as PLOT command, i.e. y=0 is at bottom of screen)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36118"></span>36118</td>
<td class="instruction">SUB 175</td>
<td class="comment-11" rowspan="1">Subtract y-coordinate from 175 to change y-origin to top of screen...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36120"></span>36120</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="1">...and have y-coordinate increase downwards rather than upwards</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36122"></span>36122</td>
<td class="instruction">ADD A,6</td>
<td class="comment-11" rowspan="1">Add 6 to y-coordinate of ball</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36124"></span>36124</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1">Subtract B to get y-distance between Magic Knight and the ball, plus 6</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36125"></span>36125</td>
<td class="instruction">CP 39</td>
<td class="comment-11" rowspan="1">If this value is not less than 39 then...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36127"></span>36127</td>
<td class="instruction">JP NC,36172</td>
<td class="comment-11" rowspan="1">...return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36130"></span>36130</td>
<td class="instruction">LD A,(25315)</td>
<td class="comment-11" rowspan="1">Else, decrease Magic Knight's current strength by one...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36133"></span>36133</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36134"></span>36134</td>
<td class="instruction">LD (25315),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36137"></span>36137</td>
<td class="instruction">CALL <a href="36215.html">36215</a></td>
<td class="comment-11" rowspan="1">Draw health bar at bottom of screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36140"></span>36140</td>
<td class="instruction">LD A,(25315)</td>
<td class="comment-11" rowspan="1">Load Magic Knight's current strength into A...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36143"></span>36143</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">If Magic Knight's strength is zero...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36144"></span>36144</td>
<td class="instruction">LD HL,43960</td>
<td class="comment-11" rowspan="1">...point HL to "YOU DIED OF EXHAUSTION" text...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36147"></span>36147</td>
<td class="instruction">JP Z,<a href="35101.html">35101</a></td>
<td class="comment-11" rowspan="1">...and jump to "Game over" window routine and exit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36150"></span>36150</td>
<td class="instruction">LD C,32</td>
<td class="comment-11" rowspan="1">Set C to 32 (number of times to repeat loop below)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="36152"></span>36152</td>
<td class="instruction">LD A,16</td>
<td class="comment-11" rowspan="1">Set speaker bit...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36154"></span>36154</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36156"></span>36156</td>
<td class="instruction">LD A,R</td>
<td class="comment-11" rowspan="1">Load A with random number between 0 - 15 (as R register increases with each instruction executed)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36158"></span>36158</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36160"></span>36160</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Load value into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="36161"></span>36161</td>
<td class="instruction">DJNZ 36161</td>
<td class="comment-11" rowspan="1">Pause by repeating this line B times</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36163"></span>36163</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Set A to zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36164"></span>36164</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="1">Reset speaker bit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36166"></span>36166</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1">Decrease C...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36167"></span>36167</td>
<td class="instruction">JR NZ,36152</td>
<td class="comment-11" rowspan="1">...and repeat loop if C is not zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36169"></span>36169</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Reset speaker bit...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="36170"></span>36170</td>
<td class="instruction">OUT (254),A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="36172"></span>36172</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="35931.html">35931</a></span></td>
<td class="up">Up: <a href="../maps/all.html#35993">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="36173.html">36173</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 02/06/2018</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.4.</div>
</footer>
</body>
</html>