<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 35293</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="35141.html">35141</a>
</td>
<td class="up">Up: <a href="../maps/all.html#35293">Map</a></td>
<td class="next">
Next: <a href="35393.html">35393</a>
</td>
</tr>
</table>
<div class="description">35293: Display and process input for character selection menu for "travel to", "summon" or "locate"</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="32035.html">32035</a>, <a href="33036.html">33036</a> and <a href="33312.html">33312</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">(On stack) Pointer to text ("TRAVEL TO", "SUMMON" or "LOCATE") pushed onto stack before call to this routine</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="35293"></span>35293</td>
<td class="instruction">CALL <a href="38116.html">38116</a></td>
<td class="comment-1" rowspan="1">Set parameters for and play short downward scale sound...</td>
</tr>
<tr>
<td class="address-1"><span id="35296"></span>35296</td>
<td class="instruction">CALL <a href="38116.html">38116</a></td>
<td class="comment-1" rowspan="1">...twice</td>
</tr>
<tr>
<td class="address-1"><span id="35299"></span>35299</td>
<td class="instruction">LD A,(23467)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with 1 if Banshee is released, else load with 0...</td>
</tr>
<tr>
<td class="address-1"><span id="35302"></span>35302</td>
<td class="instruction">AND 1</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="35304"></span>35304</td>
<td class="instruction">ADD A,11</td>
<td class="comment-1" rowspan="1">Set height of character selection menu window according to whether or not Banshee is free...</td>
</tr>
<tr>
<td class="address-1"><span id="35306"></span>35306</td>
<td class="instruction">LD (41901),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="35309"></span>35309</td>
<td class="instruction">LD A,3</td>
<td class="comment-1" rowspan="1">Display character selection menu...</td>
</tr>
<tr>
<td class="address-1"><span id="35311"></span>35311</td>
<td class="instruction">CALL <a href="36979.html">36979</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="35314"></span>35314</td>
<td class="instruction">LD HL,44017</td>
<td class="comment-1" rowspan="1">Print "WHO DO YOU WANT TO..." text...</td>
</tr>
<tr>
<td class="address-1"><span id="35317"></span>35317</td>
<td class="instruction">CALL <a href="36725.html">36725</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="35320"></span>35320</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore <span class="register">HL</span> (address to return to upon <span class="instruction">RET</span> instruction)...</td>
</tr>
<tr>
<td class="address-1"><span id="35321"></span>35321</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-1" rowspan="1">...and swap with next value on stack (pointer to text that was PUSHed before this routine was called)</td>
</tr>
<tr>
<td class="address-1"><span id="35322"></span>35322</td>
<td class="instruction">CALL <a href="36725.html">36725</a></td>
<td class="comment-1" rowspan="1">Print the text</td>
</tr>
<tr>
<td class="address-1"><span id="35325"></span>35325</td>
<td class="instruction">LD HL,43221</td>
<td class="comment-1" rowspan="1">Set character at 43221 (letter preceding menu items) to "@" (i.e. the character immediately before "A")...</td>
</tr>
<tr>
<td class="address-1"><span id="35328"></span>35328</td>
<td class="instruction">LD A,64</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="35330"></span>35330</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="35331"></span>35331</td>
<td class="instruction">LD B,7</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 7 as there are initially 7 characters</td>
</tr>
<tr>
<td class="address-1"><span id="35333"></span>35333</td>
<td class="instruction">LD A,(23467)</td>
<td class="comment-1" rowspan="1">If Banshee is not released...</td>
</tr>
<tr>
<td class="address-1"><span id="35336"></span>35336</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="35338"></span>35338</td>
<td class="instruction">JR Z,35341</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="35293.html#35341">35341</a></td>
</tr>
<tr>
<td class="address-1"><span id="35340"></span>35340</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Add one as with Banshee free there are 8 characters</td>
</tr>
<tr>
<td class="address-2"><span id="35341"></span>35341</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Load number of characters into <span class="register">A</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="35342"></span>35342</td>
<td class="instruction">LD (35375),A</td>
<td class="comment-1" rowspan="1">...and use to modify instruction at <a href="35293.html#35374">35374</a></td>
</tr>
<tr>
<td class="address-1"><span id="35345"></span>35345</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="35346"></span>35346</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="35347"></span>35347</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Store <span class="register">AF</span></td>
</tr>
<tr>
<td class="address-1"><span id="35348"></span>35348</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="35349"></span>35349</td>
<td class="instruction">LD (30615),A</td>
<td class="comment-1" rowspan="1">Change Current Character to value in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="35352"></span>35352</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Copy <span class="register">B</span> into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="35353"></span>35353</td>
<td class="instruction">ADD A,65</td>
<td class="comment-1" rowspan="1">Set character at 43221 (letter preceding menu items) to ASCII code of "A", plus index of character...</td>
</tr>
<tr>
<td class="address-1"><span id="35355"></span>35355</td>
<td class="instruction">LD (43221),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="35358"></span>35358</td>
<td class="instruction">LD HL,43220</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at this prefix text...</td>
</tr>
<tr>
<td class="address-1"><span id="35361"></span>35361</td>
<td class="instruction">CALL <a href="36725.html">36725</a></td>
<td class="comment-1" rowspan="1">...and print it</td>
</tr>
<tr>
<td class="address-1"><span id="35364"></span>35364</td>
<td class="instruction">LD HL,34905</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> to code to print full name of Current Character...</td>
</tr>
<tr>
<td class="address-1"><span id="35367"></span>35367</td>
<td class="instruction">CALL <a href="36725.html">36725</a></td>
<td class="comment-1" rowspan="1">...and print it</td>
</tr>
<tr>
<td class="address-1"><span id="35370"></span>35370</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> (<span class="register">B</span>=current character number)</td>
</tr>
<tr>
<td class="address-1"><span id="35371"></span>35371</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Increase <span class="register">B</span> for next character</td>
</tr>
<tr>
<td class="address-1"><span id="35372"></span>35372</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span></td>
</tr>
<tr>
<td class="address-1"><span id="35373"></span>35373</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Increase <span class="register">A</span> to count number characters printed in menu</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="35374"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="35293.html#35374">35374</a> represents the number of currently active characters in the game (excluding Magic Knight). This is modified by the instruction at <a href="35293.html#35342">35342</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="35374"></span>35374</td>
<td class="instruction">CP 7</td>
<td class="comment-1" rowspan="1">If number of characters printed is not equal to number of characters to print...</td>
</tr>
<tr>
<td class="address-1"><span id="35376"></span>35376</td>
<td class="instruction">JR NZ,35347</td>
<td class="comment-1" rowspan="1">...then loop back to <a href="35293.html#35347">35347</a> for next character</td>
</tr>
<tr>
<td class="address-1"><span id="35378"></span>35378</td>
<td class="instruction">CALL <a href="37333.html">37333</a></td>
<td class="comment-1" rowspan="1">Process input for menu, and load ASCII code of shortcut for selected (i.e. SPACE or fire pressed) item into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="35381"></span>35381</td>
<td class="instruction">SUB 65</td>
<td class="comment-1" rowspan="1">Subtract ASCII code of "A" from letter of character chosen to get index of selected character in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="35383"></span>35383</td>
<td class="instruction">LD (30615),A</td>
<td class="comment-1" rowspan="1">Set this to be the Current Character</td>
</tr>
<tr>
<td class="address-1"><span id="35386"></span>35386</td>
<td class="instruction">CALL <a href="34883.html#34896">34896</a></td>
<td class="comment-1" rowspan="1">Print short name of Current Character in command summary window at bottom of screen</td>
</tr>
<tr>
<td class="address-1"><span id="35389"></span>35389</td>
<td class="instruction">CALL <a href="35393.html">35393</a></td>
<td class="comment-1" rowspan="1">Display warning and abort if command is not safe while Gimbal whited-out</td>
</tr>
<tr>
<td class="address-1"><span id="35392"></span>35392</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="35141.html">35141</a>
</td>
<td class="up">Up: <a href="../maps/all.html#35293">Map</a></td>
<td class="next">
Next: <a href="35393.html">35393</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2010-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>