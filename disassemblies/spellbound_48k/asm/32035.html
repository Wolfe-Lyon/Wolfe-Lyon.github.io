<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 32035</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="32027.html">32027</a>
</td>
<td class="up">Up: <a href="../maps/all.html#32035">Map</a></td>
<td class="next">
Next: <a href="32194.html">32194</a>
</td>
</tr>
</table>
<div class="description">32035: Process and execute command to locate a character</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="27176.html">27176</a> and <a href="31153.html">31153</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="32035"></span>32035</td>
<td class="instruction">LD A,(65532)</td>
<td class="comment-1" rowspan="1">If locate-enabled flag is not set...</td>
</tr>
<tr>
<td class="address-1"><span id="32038"></span>32038</td>
<td class="instruction">BIT 1,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="32040"></span>32040</td>
<td class="instruction">JP Z,<a href="27176.html#27189">27189</a></td>
<td class="comment-1" rowspan="1">...then jump into main game loop (process keyboard input and move Magic Knight, enter menus or execute other command)</td>
</tr>
<tr>
<td class="address-1"><span id="32043"></span>32043</td>
<td class="instruction">CALL <a href="38075.html">38075</a></td>
<td class="comment-1" rowspan="1">Play upward scale sound</td>
</tr>
<tr>
<td class="address-1"><span id="32046"></span>32046</td>
<td class="instruction">CALL <a href="37654.html">37654</a></td>
<td class="comment-1" rowspan="1">Display / update command summary window at bottom of screen</td>
</tr>
<tr>
<td class="address-1"><span id="32049"></span>32049</td>
<td class="instruction">LD DE,46807</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at "LOCATE" text...</td>
</tr>
<tr>
<td class="address-1"><span id="32052"></span>32052</td>
<td class="instruction">CALL <a href="38693.html">38693</a></td>
<td class="comment-1" rowspan="1">...and print in command summary window at bottom of screen</td>
</tr>
<tr>
<td class="address-1"><span id="32055"></span>32055</td>
<td class="instruction">LD HL,44078</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "LOCATE ?" text</td>
</tr>
<tr>
<td class="address-1"><span id="32058"></span>32058</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="32059"></span>32059</td>
<td class="instruction">CALL <a href="35293.html">35293</a></td>
<td class="comment-1" rowspan="1">Display and handle full character selection menu</td>
</tr>
<tr>
<td class="address-1"><span id="32062"></span>32062</td>
<td class="instruction">CALL <a href="38725.html">38725</a></td>
<td class="comment-1" rowspan="1">Display execute / reject command window and return if execute chosen, else exit</td>
</tr>
<tr>
<td class="address-1"><span id="32065"></span>32065</td>
<td class="instruction">LD A,22</td>
<td class="comment-1" rowspan="1">Draw window 22...</td>
</tr>
<tr>
<td class="address-1"><span id="32067"></span>32067</td>
<td class="instruction">CALL <a href="36987.html">36987</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="32070"></span>32070</td>
<td class="instruction">LD A,(23493)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with x-coordinate of left-hand edge of window...</td>
</tr>
<tr>
<td class="address-1"><span id="32073"></span>32073</td>
<td class="instruction">ADD A,2</td>
<td class="comment-1" rowspan="1">...add 2...</td>
</tr>
<tr>
<td class="address-1"><span id="32075"></span>32075</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="32076"></span>32076</td>
<td class="instruction">LD A,(23494)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with y-coordinate of top edge of window...</td>
</tr>
<tr>
<td class="address-1"><span id="32079"></span>32079</td>
<td class="instruction">ADD A,3</td>
<td class="comment-1" rowspan="1">...add 3...</td>
</tr>
<tr>
<td class="address-1"><span id="32081"></span>32081</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="32082"></span>32082</td>
<td class="instruction">LD A,71</td>
<td class="comment-1" rowspan="1">Store 71 (white INK, black PAPER, BRIGHT) at <a href="23695.html">23695</a>...</td>
</tr>
<tr>
<td class="address-1"><span id="32084"></span>32084</td>
<td class="instruction">LD (23695),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="32087"></span>32087</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="1">Draw "Locate a Character" compass...</td>
</tr>
<tr>
<td class="address-1"><span id="32089"></span>32089</td>
<td class="instruction">CALL <a href="29960.html">29960</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="32092"></span>32092</td>
<td class="instruction">LD HL,46810</td>
<td class="comment-1" rowspan="1">Print "LOCATED [CHARACTER]" text...</td>
</tr>
<tr>
<td class="address-1"><span id="32095"></span>32095</td>
<td class="instruction">CALL <a href="36725.html">36725</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="32098"></span>32098</td>
<td class="instruction">CALL <a href="34402.html">34402</a></td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at current position data for Current Character</td>
</tr>
<tr>
<td class="address-1"><span id="32101"></span>32101</td>
<td class="instruction">LD DE,0</td>
<td class="comment-1" rowspan="1">Set <span class="register">DE</span> to zero so command summary window is not updated with additional text</td>
</tr>
<tr>
<td class="address-1"><span id="32104"></span>32104</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load room of Current Character</td>
</tr>
<tr>
<td class="address-1"><span id="32105"></span>32105</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If room is zero (i.e. character is in the lift)...</td>
</tr>
<tr>
<td class="address-1"><span id="32106"></span>32106</td>
<td class="instruction">JP Z,32183</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="32035.html#32183">32183</a></td>
</tr>
<tr>
<td class="address-1"><span id="32109"></span>32109</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="3">Discard floor information and set <span class="register">A</span> to represent room number 0-7 (starting at zero for room next to lift), i.e. room's x-coordinate and load into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="32110"></span>32110</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="32112"></span>32112</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="32113"></span>32113</td>
<td class="instruction">LD A,(65529)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current room into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="32116"></span>32116</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="2">Discard floor information and set <span class="register">A</span> to represent room number 0-7 (starting at zero for room next to lift), i.e. room's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="32117"></span>32117</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="32119"></span>32119</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">Compare character's room x-coordinate to Magic Knight's</td>
</tr>
<tr>
<td class="address-1"><span id="32120"></span>32120</td>
<td class="instruction">JR Z,32131</td>
<td class="comment-1" rowspan="1">If character's room and Magic Knight's room are at the same x-coordinate, then skip ahead to <a href="32035.html#32131">32131</a></td>
</tr>
<tr>
<td class="address-1"><span id="32122"></span>32122</td>
<td class="instruction">JP M,32129</td>
<td class="comment-1" rowspan="1">If character's room is to the right of Magic Knight's, then skip ahead to <a href="32035.html#32129">32129</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32125"></span>
<div class="comments">
<div class="paragraph">
Character's room is to the left of Magic Knight's
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="32125"></span>32125</td>
<td class="instruction">LD E,254</td>
<td class="comment-1" rowspan="1">Load <span class="register">E</span> with 254 (-2)</td>
</tr>
<tr>
<td class="address-1"><span id="32127"></span>32127</td>
<td class="instruction">JR 32131</td>
<td class="comment-1" rowspan="1">Skip ahead to <a href="32035.html#32131">32131</a></td>
</tr>
<tr>
<td class="address-2"><span id="32129"></span>32129</td>
<td class="instruction">LD E,2</td>
<td class="comment-1" rowspan="1">Load <span class="register">E</span> with 2</td>
</tr>
<tr>
<td class="address-2"><span id="32131"></span>32131</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with character's current room</td>
</tr>
<tr>
<td class="address-1"><span id="32132"></span>32132</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrease by one</td>
</tr>
<tr>
<td class="address-1"><span id="32133"></span>32133</td>
<td class="instruction">AND 248</td>
<td class="comment-1" rowspan="1">Clear all but floor information (i.e. y-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="32135"></span>32135</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Load into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="32136"></span>32136</td>
<td class="instruction">LD A,(65529)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current room into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="32139"></span>32139</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrease by one</td>
</tr>
<tr>
<td class="address-1"><span id="32140"></span>32140</td>
<td class="instruction">AND 248</td>
<td class="comment-1" rowspan="1">Clear all but floor information (i.e. y-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="32142"></span>32142</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">Compare character's room y-coordinate to Magic Knight's</td>
</tr>
<tr>
<td class="address-1"><span id="32143"></span>32143</td>
<td class="instruction">JR Z,32154</td>
<td class="comment-1" rowspan="1">If character's room and Magic Knight's room are at the same y-coordinate, then skip ahead to <a href="32035.html#32154">32154</a></td>
</tr>
<tr>
<td class="address-1"><span id="32145"></span>32145</td>
<td class="instruction">JP M,32152</td>
<td class="comment-1" rowspan="1">If character's room is below Magic Knight's, then skip ahead to <a href="32035.html#32152">32152</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="32148"></span>
<div class="comments">
<div class="paragraph">
Character's room is above Magic Knight's
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="32148"></span>32148</td>
<td class="instruction">LD D,254</td>
<td class="comment-1" rowspan="1">Load <span class="register">D</span> with 254 (-2)</td>
</tr>
<tr>
<td class="address-1"><span id="32150"></span>32150</td>
<td class="instruction">JR 32154</td>
<td class="comment-1" rowspan="1">Skip ahead to <a href="32035.html#32154">32154</a></td>
</tr>
<tr>
<td class="address-2"><span id="32152"></span>32152</td>
<td class="instruction">LD D,2</td>
<td class="comment-1" rowspan="1">Load <span class="register">D</span> with 2</td>
</tr>
<tr>
<td class="address-2"><span id="32154"></span>32154</td>
<td class="instruction">LD A,(23494)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with y-coordinate of top edge of current window to draw (characters) (typically 1)</td>
</tr>
<tr>
<td class="address-1"><span id="32157"></span>32157</td>
<td class="instruction">ADD A,5</td>
<td class="comment-1" rowspan="1">Add 5 to y-coordinate (now pointing at top row of middle "origin" square of "locate compass")</td>
</tr>
<tr>
<td class="address-1"><span id="32159"></span>32159</td>
<td class="instruction">ADD A,D</td>
<td class="comment-1" rowspan="1">Add <span class="register">D</span> (which is either +/-2 to point to top half or bottom half of "locate compass")</td>
</tr>
<tr>
<td class="address-1"><span id="32160"></span>32160</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1">Load this y-coordinate into <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="32161"></span>32161</td>
<td class="instruction">LD A,(23493)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with x-coordinate of left edge of current window (typically 1)</td>
</tr>
<tr>
<td class="address-1"><span id="32164"></span>32164</td>
<td class="instruction">ADD A,4</td>
<td class="comment-1" rowspan="1">Add 4 to y-coordinate (now pointing at left column of middle "origin" square of "locate compass")</td>
</tr>
<tr>
<td class="address-1"><span id="32166"></span>32166</td>
<td class="instruction">ADD A,E</td>
<td class="comment-1" rowspan="1">Add <span class="register">E</span> (which is either +/-2 to point to left half or right half of "locate compass")</td>
</tr>
<tr>
<td class="address-1"><span id="32167"></span>32167</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Load x-coordinate into <span class="register">L</span></td>
</tr>
<tr>
<td class="address-2"><span id="32168"></span>32168</td>
<td class="instruction">LD (23462),HL</td>
<td class="comment-1" rowspan="1">Store <span class="register">HL</span> at 23462</td>
</tr>
<tr>
<td class="address-1"><span id="32171"></span>32171</td>
<td class="instruction">CALL <a href="38749.html">38749</a></td>
<td class="comment-1" rowspan="1">Display "PRESS SPACE OR FIRE TO CONTINUE" window and wait for space / fire</td>
</tr>
<tr>
<td class="address-1"><span id="32174"></span>32174</td>
<td class="instruction">LD HL,0</td>
<td class="comment-1" rowspan="1">Set word at 23462 to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="32177"></span>32177</td>
<td class="instruction">LD (23462),HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="32180"></span>32180</td>
<td class="instruction">JP <a href="30222.html#30428">30428</a></td>
<td class="comment-1" rowspan="1">Reset Gimbal-white-out-safe flag, redraw current room and return to main game loop</td>
</tr>
<tr>
<td class="address-2"><span id="32183"></span>32183</td>
<td class="instruction">LD HL,46815</td>
<td class="comment-1" rowspan="1">Print "IN THE LIFT" text...</td>
</tr>
<tr>
<td class="address-1"><span id="32186"></span>32186</td>
<td class="instruction">CALL <a href="36725.html">36725</a></td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="32189"></span>32189</td>
<td class="instruction">LD HL,1539</td>
<td class="comment-1" rowspan="1">Set <span class="register">H</span> to 6 and <span class="register">L</span> to 3 (as lift is always left of Magic Knight's current room when he's not in the lift!)</td>
</tr>
<tr>
<td class="address-1"><span id="32192"></span>32192</td>
<td class="instruction">JR 32168</td>
<td class="comment-1" rowspan="1">Skip back to display the compass</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="32027.html">32027</a>
</td>
<td class="up">Up: <a href="../maps/all.html#32035">Map</a></td>
<td class="next">
Next: <a href="32194.html">32194</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2010-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>