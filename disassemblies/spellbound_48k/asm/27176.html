<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 27176</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27168.html">27168</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27176">Map</a></td>
<td class="next">
Next: <a href="27490.html">27490</a>
</td>
</tr>
</table>
<div class="description">27176: Main game loop: Process keyboard input and move Magic Knight, enter menus or execute other command</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27176"></span>27176</td>
<td class="instruction">CALL <a href="34821.html">34821</a></td>
<td class="comment-1" rowspan="1">Update Magic Knight's current frame based on x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="27179"></span>27179</td>
<td class="instruction">LD (65528),A</td>
<td class="comment-1" rowspan="1">Store frame number at 65528...</td>
</tr>
<tr>
<td class="address-1"><span id="27182"></span>27182</td>
<td class="instruction">LD (25390),A</td>
<td class="comment-1" rowspan="1">...and in Magic Knight's current data</td>
</tr>
<tr>
<td class="address-1"><span id="27185"></span>27185</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero (Magic Knight) and...</td>
</tr>
<tr>
<td class="address-1"><span id="27186"></span>27186</td>
<td class="instruction">CALL <a href="39224.html">39224</a></td>
<td class="comment-1" rowspan="1">...draw Magic Knight (erase old frame and draw new frame)</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27189"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="26906.html">26906</a>, <a href="27168.html">27168</a>, <a href="31636.html">31636</a>, <a href="32035.html">32035</a>, <a href="32194.html">32194</a>, <a href="32258.html">32258</a>, <a href="32390.html">32390</a>, <a href="32655.html">32655</a>, <a href="33312.html">33312</a>, <a href="33593.html">33593</a> and <a href="33663.html">33663</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27189"></span>27189</td>
<td class="instruction">CALL <a href="29763.html">29763</a></td>
<td class="comment-1" rowspan="1">Run checks and updates (Magic Knight's current room and room-specific routines)</td>
</tr>
<tr>
<td class="address-1"><span id="27192"></span>27192</td>
<td class="instruction">CALL <a href="27495.html">27495</a></td>
<td class="comment-1" rowspan="1">Handle Magic Knight's fall</td>
</tr>
<tr>
<td class="address-1"><span id="27195"></span>27195</td>
<td class="instruction">LD A,127</td>
<td class="comment-1" rowspan="1">Reset bit 7 in <span class="register">A</span> to select the keyboard half-row SPACE - B</td>
</tr>
<tr>
<td class="address-1"><span id="27197"></span>27197</td>
<td class="instruction">IN A,(254)</td>
<td class="comment-1" rowspan="1">Read the keyboard</td>
</tr>
<tr>
<td class="address-1"><span id="27199"></span>27199</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Reset carry flag if SPACE pressed, else set it</td>
</tr>
<tr>
<td class="address-1"><span id="27200"></span>27200</td>
<td class="instruction">JR C,27213</td>
<td class="comment-1" rowspan="1">SPACE was not pressed, so skip ahead to <a href="27176.html#27213">27213</a></td>
</tr>
<tr>
<td class="address-1"><span id="27202"></span>27202</td>
<td class="instruction">LD A,254</td>
<td class="comment-1" rowspan="1">Reset bit 0 in <span class="register">A</span> to select the keyboard half-row SHIFT - V</td>
</tr>
<tr>
<td class="address-1"><span id="27204"></span>27204</td>
<td class="instruction">IN A,(254)</td>
<td class="comment-1" rowspan="1">Read the keyboard</td>
</tr>
<tr>
<td class="address-1"><span id="27206"></span>27206</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1">Reset carry flag if SHIFT pressed, else set it</td>
</tr>
<tr>
<td class="address-1"><span id="27207"></span>27207</td>
<td class="instruction">LD HL,43450</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at "BREAK KEY PRESSED" text</td>
</tr>
<tr>
<td class="address-1"><span id="27210"></span>27210</td>
<td class="instruction">JP NC,<a href="35101.html">35101</a></td>
<td class="comment-1" rowspan="1">If SHIFT was pressed (i.e. SHIFT-SPACE, or BREAK) jump to "game over" window routine and exit</td>
</tr>
<tr>
<td class="address-2"><span id="27213"></span>27213</td>
<td class="instruction">CALL <a href="27666.html">27666</a></td>
<td class="comment-1" rowspan="1">Kill Magic Knight's x-velocity if he cannot horizontally pass through a block beside him</td>
</tr>
<tr>
<td class="address-1"><span id="27216"></span>27216</td>
<td class="instruction">CALL <a href="37876.html">37876</a></td>
<td class="comment-1" rowspan="1">Capture keyboard/joystick input into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27219"></span>27219</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-1" rowspan="1">If "left" pressed then...</td>
</tr>
<tr>
<td class="address-1"><span id="27221"></span>27221</td>
<td class="instruction">JP NZ,27307</td>
<td class="comment-1" rowspan="1">Skip ahead to move left subroutine</td>
</tr>
<tr>
<td class="address-1"><span id="27224"></span>27224</td>
<td class="instruction">BIT 1,A</td>
<td class="comment-1" rowspan="1">If "right" pressed then...</td>
</tr>
<tr>
<td class="address-1"><span id="27226"></span>27226</td>
<td class="instruction">JP NZ,27358</td>
<td class="comment-1" rowspan="1">Skip ahead to move right subroutine</td>
</tr>
<tr>
<td class="address-1"><span id="27229"></span>27229</td>
<td class="instruction">BIT 2,A</td>
<td class="comment-1" rowspan="1">If "up" pressed then...</td>
</tr>
<tr>
<td class="address-1"><span id="27231"></span>27231</td>
<td class="instruction">JP NZ,27374</td>
<td class="comment-1" rowspan="1">Skip ahead to jump subroutine</td>
</tr>
<tr>
<td class="address-1"><span id="27234"></span>27234</td>
<td class="instruction">BIT 3,A</td>
<td class="comment-1" rowspan="1">Check for "down" pressed</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27236"></span>
<div class="comments">
<div class="paragraph">
The following three bytes are set to zero (<span class="instruction">NOP</span>) by the instructions between <a href="../initialisation/26627.html#26633">26633</a> and <a href="../initialisation/26627.html#26640">26640</a>. This disables the <a href="../initialisation/27236.html">conditional jump</a> to the cheat / debug routine at <a href="35420.html">35420</a> (<a href="../reference/facts.html#cheat_mode">see trivia</a>).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27236"></span>27236</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27237"></span>27237</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27238"></span>27238</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="27239"></span>27239</td>
<td class="instruction">BIT 4,A</td>
<td class="comment-1" rowspan="1">If "fire" pressed then...</td>
</tr>
<tr>
<td class="address-1"><span id="27241"></span>27241</td>
<td class="instruction">JP NZ,27301</td>
<td class="comment-1" rowspan="1">Skip ahead to <a href="27176.html#27301">27301</a></td>
</tr>
<tr>
<td class="address-1"><span id="27244"></span>27244</td>
<td class="instruction">LD A,(65528)</td>
<td class="comment-1" rowspan="1">Set Magic Knight's current frame to stored value...</td>
</tr>
<tr>
<td class="address-1"><span id="27247"></span>27247</td>
<td class="instruction">LD (25390),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27250"></span>27250</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero (Magic Knight) and...</td>
</tr>
<tr>
<td class="address-1"><span id="27251"></span>27251</td>
<td class="instruction">CALL <a href="39224.html">39224</a></td>
<td class="comment-1" rowspan="1">...draw Magic Knight (erase old frame and draw new frame)</td>
</tr>
<tr>
<td class="address-2"><span id="27254"></span>27254</td>
<td class="instruction">LD A,(23560)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with last pressed key (<a href="23552.html#23560">LAST K system variable</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="27257"></span>27257</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If last key pressed is null (i.e. key NOT pressed)...</td>
</tr>
<tr>
<td class="address-1"><span id="27258"></span>27258</td>
<td class="instruction">JP Z,27189</td>
<td class="comment-1" rowspan="1">...then jump into main game loop (process keyboard input and move Magic Knight, enter menus or execute other command)</td>
</tr>
<tr>
<td class="address-1"><span id="27261"></span>27261</td>
<td class="instruction">LD HL,41811</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at string of keyboard shortcuts for commands</td>
</tr>
<tr>
<td class="address-1"><span id="27264"></span>27264</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Load index of key pressed into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="27265"></span>27265</td>
<td class="instruction">LD C,0</td>
<td class="comment-1" rowspan="1">Set <span class="register">C</span> (index of command shortcut) to zero initially</td>
</tr>
<tr>
<td class="address-2"><span id="27267"></span>27267</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load command shortcut from table at 41811 into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27268"></span>27268</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If <span class="register">A</span> is zero (i.e. we have reached the last command shortcut in the table)...</td>
</tr>
<tr>
<td class="address-1"><span id="27269"></span>27269</td>
<td class="instruction">JP Z,27189</td>
<td class="comment-1" rowspan="1">...then jump into main game loop (process keyboard input and move Magic Knight, enter menus or execute other command)</td>
</tr>
<tr>
<td class="address-1"><span id="27272"></span>27272</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">If key pressed matches current command shortcut...</td>
</tr>
<tr>
<td class="address-1"><span id="27273"></span>27273</td>
<td class="instruction">JP Z,27280</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27176.html#27280">27280</a></td>
</tr>
<tr>
<td class="address-1"><span id="27276"></span>27276</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Increase <span class="register">C</span> to advance to next command shortcut to test</td>
</tr>
<tr>
<td class="address-1"><span id="27277"></span>27277</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance pointer to next shortcut</td>
</tr>
<tr>
<td class="address-1"><span id="27278"></span>27278</td>
<td class="instruction">JR 27267</td>
<td class="comment-1" rowspan="1">Loop back to <a href="27176.html#27267">27267</a> for next shortcut</td>
</tr>
<tr>
<td class="address-2"><span id="27280"></span>27280</td>
<td class="instruction">CALL <a href="37472.html">37472</a></td>
<td class="comment-1" rowspan="1">Wait for keyboard to be released</td>
</tr>
<tr>
<td class="address-1"><span id="27283"></span>27283</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Load double the index of command shortcut chosen into <span class="register">BC</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27284"></span>27284</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27285"></span>27285</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27287"></span>27287</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27288"></span>27288</td>
<td class="instruction">LD HL,41827</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at table of routine start addresses for Magic Knight's main menu commands</td>
</tr>
<tr>
<td class="address-1"><span id="27291"></span>27291</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add double index of this command's entry as offset, so <span class="register">HL</span> now points at address in table of chosen command</td>
</tr>
<tr>
<td class="address-1"><span id="27292"></span>27292</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load address into <span class="register">HL</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27293"></span>27293</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27294"></span>27294</td>
<td class="instruction">LD H,(HL)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27295"></span>27295</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27296"></span>27296</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Clear last pressed key (<a href="23552.html#23560">LAST K system variable</a>)...</td>
</tr>
<tr>
<td class="address-1"><span id="27297"></span>27297</td>
<td class="instruction">LD (23560),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27300"></span>27300</td>
<td class="instruction">JP (HL)</td>
<td class="comment-1" rowspan="1">Execute the command, then return to game</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27301"></span>
<div class="comments">
<div class="paragraph">
Fire pressed
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27301"></span>27301</td>
<td class="instruction">CALL <a href="37486.html">37486</a></td>
<td class="comment-1" rowspan="1">Wait for fire button / key to be released</td>
</tr>
<tr>
<td class="address-1"><span id="27304"></span>27304</td>
<td class="instruction">JP <a href="31153.html">31153</a></td>
<td class="comment-1" rowspan="1">Display and handle main in-game menu, execute selected command and return to game</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27307"></span>
<div class="comments">
<div class="paragraph">
Left pressed
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27307"></span>27307</td>
<td class="instruction">LD HL,23470</td>
<td class="comment-1" rowspan="1">If Magic-Knight-can't-move-left flag is set...</td>
</tr>
<tr>
<td class="address-1"><span id="27310"></span>27310</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27312"></span>27312</td>
<td class="instruction">JP NZ,27254</td>
<td class="comment-1" rowspan="1">...then loop back to start of keyboard check routine</td>
</tr>
<tr>
<td class="address-1"><span id="27315"></span>27315</td>
<td class="instruction">LD HL,34824</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with 34824 (left-facing version of update Magic Knight's current frame routine)</td>
</tr>
<tr>
<td class="address-1"><span id="27318"></span>27318</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Switch <span class="register">AF</span> and <span class="register">AF'</span></td>
</tr>
<tr>
<td class="address-1"><span id="27319"></span>27319</td>
<td class="instruction">LD A,254</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x-velocity to minus 2...</td>
</tr>
<tr>
<td class="address-2"><span id="27321"></span>27321</td>
<td class="instruction">LD (25391),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27324"></span>27324</td>
<td class="instruction">LD (27405),A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to minus 2</td>
</tr>
<tr>
<td class="address-1"><span id="27327"></span>27327</td>
<td class="instruction">LD (34822),HL</td>
<td class="comment-1" rowspan="1">Set instruction at 34821 to jump to 34824 (left-facing version of update Magic Knight's current frame routine)</td>
</tr>
<tr>
<td class="address-1"><span id="27330"></span>27330</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Switch <span class="register">AF</span> and <span class="register">AF'</span> (<span class="register">A</span> now holds pressed controls bitmap)</td>
</tr>
<tr>
<td class="address-1"><span id="27331"></span>27331</td>
<td class="instruction">BIT 2,A</td>
<td class="comment-1" rowspan="1">If "up" was also pressed...</td>
</tr>
<tr>
<td class="address-1"><span id="27333"></span>27333</td>
<td class="instruction">JR NZ,27378</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27176.html#27378">27378</a> (jumping subroutine)</td>
</tr>
<tr>
<td class="address-1"><span id="27335"></span>27335</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set Magic Knight's current y-velocity to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27336"></span>27336</td>
<td class="instruction">LD (25392),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27339"></span>27339</td>
<td class="instruction">CALL <a href="34821.html">34821</a></td>
<td class="comment-1" rowspan="1">Update Magic Knight's current frame based on x-coordinate...</td>
</tr>
<tr>
<td class="address-1"><span id="27342"></span>27342</td>
<td class="instruction">LD (25390),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27345"></span>27345</td>
<td class="instruction">LD (65528),A</td>
<td class="comment-1" rowspan="1">Store frame number at 65528</td>
</tr>
<tr>
<td class="address-1"><span id="27348"></span>27348</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero (Magic Knight) and...</td>
</tr>
<tr>
<td class="address-1"><span id="27349"></span>27349</td>
<td class="instruction">CALL <a href="39224.html">39224</a></td>
<td class="comment-1" rowspan="1">...draw Magic Knight (erase old frame and draw new frame)</td>
</tr>
<tr>
<td class="address-1"><span id="27352"></span>27352</td>
<td class="instruction">CALL <a href="27495.html">27495</a></td>
<td class="comment-1" rowspan="1">Handle Magic Knight's fall</td>
</tr>
<tr>
<td class="address-1"><span id="27355"></span>27355</td>
<td class="instruction">JP 27254</td>
<td class="comment-1" rowspan="1">Loop back for next key / control press</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27358"></span>
<div class="comments">
<div class="paragraph">
Right pressed
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27358"></span>27358</td>
<td class="instruction">LD HL,23470</td>
<td class="comment-1" rowspan="1">If Magic-Knight-can't-move-right flag is set...</td>
</tr>
<tr>
<td class="address-1"><span id="27361"></span>27361</td>
<td class="instruction">BIT 1,(HL)</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27363"></span>27363</td>
<td class="instruction">JP NZ,27254</td>
<td class="comment-1" rowspan="1">...then loop back to start of keyboard check routine</td>
</tr>
<tr>
<td class="address-1"><span id="27366"></span>27366</td>
<td class="instruction">LD HL,34838</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with 34838 (right-facing version of update Magic Knight's current frame routine)</td>
</tr>
<tr>
<td class="address-1"><span id="27369"></span>27369</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-1" rowspan="1">Switch <span class="register">AF</span> and <span class="register">AF'</span></td>
</tr>
<tr>
<td class="address-1"><span id="27370"></span>27370</td>
<td class="instruction">LD A,2</td>
<td class="comment-1" rowspan="1">Jump to <a href="27176.html#27321">27321</a>, setting Magic Knight's x-velocity to 2...</td>
</tr>
<tr>
<td class="address-1"><span id="27372"></span>27372</td>
<td class="instruction">JR 27321</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27374"></span>
<div class="comments">
<div class="paragraph">
Up pressed
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27374"></span>27374</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27375"></span>27375</td>
<td class="instruction">LD (27405),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="27378"></span>27378</td>
<td class="instruction">LD HL,41859</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at start of Magic Knight's y-velocities sequence table</td>
</tr>
<tr>
<td class="address-2"><span id="27381"></span>27381</td>
<td class="instruction">LD (41857),HL</td>
<td class="comment-1" rowspan="1">Store current position in Magic Knight's y-velocities sequence table at 41857</td>
</tr>
<tr>
<td class="address-1"><span id="27384"></span>27384</td>
<td class="instruction">LD A,(25388)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current y-coordinate into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27387"></span>27387</td>
<td class="instruction">CP 8</td>
<td class="comment-1" rowspan="1">If y-coordinate is less than 8...</td>
</tr>
<tr>
<td class="address-1"><span id="27389"></span>27389</td>
<td class="instruction">JP C,27468</td>
<td class="comment-1" rowspan="1">...then jump to <a href="27176.html#27468">27468</a> (exit loop as Magic Knight can't get any higher!)</td>
</tr>
<tr>
<td class="address-1"><span id="27392"></span>27392</td>
<td class="instruction">LD HL,(41857)</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with current position in Magic Knight's y-velocities sequence table</td>
</tr>
<tr>
<td class="address-1"><span id="27395"></span>27395</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load the current y-velocity in the sequence into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27396"></span>27396</td>
<td class="instruction">NEG</td>
<td class="comment-1" rowspan="1">Negate (as Magic Knight is jumping upwards)</td>
</tr>
<tr>
<td class="address-1"><span id="27398"></span>27398</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If <span class="register">A</span> is zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27399"></span>27399</td>
<td class="instruction">JR Z,27468</td>
<td class="comment-1" rowspan="1">...jump to <a href="27176.html#27468">27468</a> (exit loop as we have reached the end of the sequence)</td>
</tr>
<tr>
<td class="address-1"><span id="27401"></span>27401</td>
<td class="instruction">LD (25392),A</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> into Magic Knight's y-velocity</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27404"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="27176.html#27404">27404</a> represents the x-velocity value stored previously. This is modified by the instruction at <a href="27176.html#27375">27375</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27404"></span>27404</td>
<td class="instruction">LD A,0</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x-velocity...</td>
</tr>
<tr>
<td class="address-1"><span id="27406"></span>27406</td>
<td class="instruction">LD (25391),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27409"></span>27409</td>
<td class="instruction">CALL <a href="27666.html">27666</a></td>
<td class="comment-1" rowspan="1">Kill Magic Knight's x-velocity if he cannot horizontally pass through a block beside him</td>
</tr>
<tr>
<td class="address-1"><span id="27412"></span>27412</td>
<td class="instruction">LD A,(25391)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's x-velocity into <span class="register">B</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27415"></span>27415</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27416"></span>27416</td>
<td class="instruction">LD A,(23470)</td>
<td class="comment-1" rowspan="1">Load Magic Knight movement flags into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27419"></span>27419</td>
<td class="instruction">XOR B</td>
<td class="comment-1" rowspan="1">Check:</td>
</tr>
<tr>
<td class="address-1"><span id="27420"></span>27420</td>
<td class="instruction">CP 255</td>
<td class="comment-1" rowspan="1">If x-velocity is -2 (left), and Magic Knight can't move left...</td>
</tr>
<tr>
<td class="address-1"><span id="27422"></span>27422</td>
<td class="instruction">JP Z,27480</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27176.html#27480">27480</a></td>
</tr>
<tr>
<td class="address-1"><span id="27425"></span>27425</td>
<td class="instruction">CP 253</td>
<td class="comment-1" rowspan="1">If x-velocity is -2 (left), and Magic Knight can't move left or right...</td>
</tr>
<tr>
<td class="address-1"><span id="27427"></span>27427</td>
<td class="instruction">JP Z,27480</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27176.html#27480">27480</a></td>
</tr>
<tr>
<td class="address-1"><span id="27430"></span>27430</td>
<td class="instruction">CP 1</td>
<td class="comment-1" rowspan="1">If x-velocity is +2 (right), and Magic Knight can't move left or right...</td>
</tr>
<tr>
<td class="address-1"><span id="27432"></span>27432</td>
<td class="instruction">JP Z,27480</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27176.html#27480">27480</a></td>
</tr>
<tr>
<td class="address-1"><span id="27435"></span>27435</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If x-velocity is +2 (right), and Magic Knight can't move right...</td>
</tr>
<tr>
<td class="address-1"><span id="27436"></span>27436</td>
<td class="instruction">JP Z,27480</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27176.html#27480">27480</a></td>
</tr>
<tr>
<td class="address-2"><span id="27439"></span>27439</td>
<td class="instruction">CALL <a href="34821.html">34821</a></td>
<td class="comment-1" rowspan="1">Update Magic Knight's current frame based on x-coordinate...</td>
</tr>
<tr>
<td class="address-1"><span id="27442"></span>27442</td>
<td class="instruction">LD (25390),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27445"></span>27445</td>
<td class="instruction">LD (65528),A</td>
<td class="comment-1" rowspan="1">Store frame number at 65528</td>
</tr>
<tr>
<td class="address-1"><span id="27448"></span>27448</td>
<td class="instruction">CALL <a href="27809.html">27809</a></td>
<td class="comment-1" rowspan="1">Kill Magic Knight's jump if he cannot vertically pass through a block above him</td>
</tr>
<tr>
<td class="address-1"><span id="27451"></span>27451</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Store <span class="register">AF</span></td>
</tr>
<tr>
<td class="address-1"><span id="27452"></span>27452</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero (Magic Knight) and...</td>
</tr>
<tr>
<td class="address-1"><span id="27453"></span>27453</td>
<td class="instruction">CALL <a href="39224.html">39224</a></td>
<td class="comment-1" rowspan="1">...draw Magic Knight (erase old frame and draw new frame)</td>
</tr>
<tr>
<td class="address-1"><span id="27456"></span>27456</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span></td>
</tr>
<tr>
<td class="address-1"><span id="27457"></span>27457</td>
<td class="instruction">JR NZ,27468</td>
<td class="comment-1" rowspan="1">If Magic Knight's jump was impeded by a block above him then jump to <a href="27176.html#27468">27468</a></td>
</tr>
<tr>
<td class="address-1"><span id="27459"></span>27459</td>
<td class="instruction">CALL <a href="29763.html">29763</a></td>
<td class="comment-1" rowspan="1">Run checks and updates (Magic Knight's current room and room-specific routines)</td>
</tr>
<tr>
<td class="address-1"><span id="27462"></span>27462</td>
<td class="instruction">LD HL,(41857)</td>
<td class="comment-1" rowspan="1">Load <span class="register">HL</span> with current position in Magic Knight's y-velocities sequence table at <a href="41857.html">41857</a></td>
</tr>
<tr>
<td class="address-1"><span id="27465"></span>27465</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance to next y-velocity in the sequence</td>
</tr>
<tr>
<td class="address-1"><span id="27466"></span>27466</td>
<td class="instruction">JR 27381</td>
<td class="comment-1" rowspan="1">Loop back to <a href="27176.html#27381">27381</a></td>
</tr>
<tr>
<td class="address-2"><span id="27468"></span>27468</td>
<td class="instruction">CALL <a href="34821.html">34821</a></td>
<td class="comment-1" rowspan="1">Update Magic Knight's current frame based on x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="27471"></span>27471</td>
<td class="instruction">LD (65528),A</td>
<td class="comment-1" rowspan="1">Store frame number at <a href="65528.html">65528</a></td>
</tr>
<tr>
<td class="address-1"><span id="27474"></span>27474</td>
<td class="instruction">CALL <a href="27490.html">27490</a></td>
<td class="comment-1" rowspan="1">Handle Magic Knight's fall, preserving x-velocity</td>
</tr>
<tr>
<td class="address-1"><span id="27477"></span>27477</td>
<td class="instruction">JP 27254</td>
<td class="comment-1" rowspan="1">Loop back to start of keyboard check routine</td>
</tr>
<tr>
<td class="address-2"><span id="27480"></span>27480</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x-velocity to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27481"></span>27481</td>
<td class="instruction">LD (25391),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27484"></span>27484</td>
<td class="instruction">LD (27405),A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to zero</td>
</tr>
<tr>
<td class="address-1"><span id="27487"></span>27487</td>
<td class="instruction">JP 27439</td>
<td class="comment-1" rowspan="1">Jump back to <a href="27176.html#27439">27439</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27168.html">27168</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27176">Map</a></td>
<td class="next">
Next: <a href="27490.html">27490</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2010-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>