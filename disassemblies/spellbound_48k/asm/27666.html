<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 27666</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27495.html">27495</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27666">Map</a></td>
<td class="next">
Next: <a href="27809.html">27809</a>
</td>
</tr>
</table>
<div class="description">27666: Kill Magic Knight's x-velocity if he cannot horizontally pass through a block beside him</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="27176.html">27176</a> and <a href="27495.html">27495</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27666"></span>27666</td>
<td class="instruction">LD A,(23410)</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with Magic Knight's "temporary store" movement flags...</td>
</tr>
<tr>
<td class="address-1"><span id="27669"></span>27669</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27670"></span>27670</td>
<td class="instruction">LD A,(25387)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's x-coordinate into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27673"></span>27673</td>
<td class="instruction">CP 5</td>
<td class="comment-1" rowspan="1">If x-coordinate is less than 5...</td>
</tr>
<tr>
<td class="address-1"><span id="27675"></span>27675</td>
<td class="instruction">JP C,27685</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27666.html#27685">27685</a></td>
</tr>
<tr>
<td class="address-1"><span id="27678"></span>27678</td>
<td class="instruction">CP 229</td>
<td class="comment-1" rowspan="1">If x-coordinate is greater than 229...</td>
</tr>
<tr>
<td class="address-1"><span id="27680"></span>27680</td>
<td class="instruction">JP NC,27685</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27666.html#27685">27685</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27683"></span>
<div class="comments">
<div class="paragraph">
Magic Knight is not at the outer edges of his current room, so can move both left and right
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27683"></span>27683</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> (Magic Knight's temporary store movement flags) to zero</td>
</tr>
<tr>
<td class="address-2"><span id="27685"></span>27685</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Load Magic Knight's temporary store movement flags into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27686"></span>27686</td>
<td class="instruction">LD (23470),A</td>
<td class="comment-1" rowspan="1">Set Magic Knight's movement flags</td>
</tr>
<tr>
<td class="address-1"><span id="27689"></span>27689</td>
<td class="instruction">LD A,(25388)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's y-coordinate into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="27692"></span>27692</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27693"></span>27693</td>
<td class="instruction">LD A,(25392)</td>
<td class="comment-1" rowspan="1">Add Magic Knight's y-velocity to y-coordinate in <span class="register">A</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27696"></span>27696</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27697"></span>27697</td>
<td class="instruction">LD (23479),A</td>
<td class="comment-1" rowspan="1">Store this new (predicted) y-coordinate at 23479</td>
</tr>
<tr>
<td class="address-1"><span id="27700"></span>27700</td>
<td class="instruction">LD C,4</td>
<td class="comment-1" rowspan="1">Set <span class="register">C</span> to 4 (as Magic Knight is normally four characters tall)</td>
</tr>
<tr>
<td class="address-1"><span id="27702"></span>27702</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1">If predicted y-coordinate is divisible by eight...</td>
</tr>
<tr>
<td class="address-1"><span id="27704"></span>27704</td>
<td class="instruction">JR Z,27707</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27666.html#27707">27707</a>...</td>
</tr>
<tr>
<td class="address-1"><span id="27706"></span>27706</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">...else Magic Knight must be airborne and at non-integer y-coordinate, and so spans five character blocks rather than four</td>
</tr>
<tr>
<td class="address-2"><span id="27707"></span>27707</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with number of vertical characters spanned by Magic Knight...</td>
</tr>
<tr>
<td class="address-1"><span id="27708"></span>27708</td>
<td class="instruction">LD (27740),A</td>
<td class="comment-1" rowspan="1">...and update instructions at 27739...</td>
</tr>
<tr>
<td class="address-1"><span id="27711"></span>27711</td>
<td class="instruction">LD (27781),A</td>
<td class="comment-1" rowspan="1">...and 27780 with this value</td>
</tr>
<tr>
<td class="address-1"><span id="27714"></span>27714</td>
<td class="instruction">LD A,(25387)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current x-coordinate into <span class="register">C</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27717"></span>27717</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27718"></span>27718</td>
<td class="instruction">LD A,(25391)</td>
<td class="comment-1" rowspan="1">Add Magic Knight's x-velocity to x-coordinate in <span class="register">A</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27721"></span>27721</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27722"></span>27722</td>
<td class="instruction">LD (23478),A</td>
<td class="comment-1" rowspan="1">Store this new (predicted) x-coordinate at 23478</td>
</tr>
<tr>
<td class="address-1"><span id="27725"></span>27725</td>
<td class="instruction">CALL <a href="30123.html">30123</a></td>
<td class="comment-1" rowspan="1">Divide predicted x-coordinate by eight, rounding down to nearest integer...</td>
</tr>
<tr>
<td class="address-1"><span id="27728"></span>27728</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="27729"></span>27729</td>
<td class="instruction">LD A,(23479)</td>
<td class="comment-1" rowspan="1">Load predicted y-coordinate into <span class="register">A</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27732"></span>27732</td>
<td class="instruction">CALL <a href="30123.html">30123</a></td>
<td class="comment-1" rowspan="1">...divide it by eight, rounding down to nearest integer...</td>
</tr>
<tr>
<td class="address-1"><span id="27735"></span>27735</td>
<td class="instruction">LD (23479),A</td>
<td class="comment-1" rowspan="1">...store back at 23479...</td>
</tr>
<tr>
<td class="address-1"><span id="27738"></span>27738</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">B</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27739"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="27666.html#27739">27739</a> represents the number of character blocks to check. This is modified by the instruction at <a href="27666.html#27708">27708</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27739"></span>27739</td>
<td class="instruction">LD A,0</td>
<td class="comment-1" rowspan="1">Load number of characters (vertically) to check for impassibility</td>
</tr>
<tr>
<td class="address-2"><span id="27741"></span>27741</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Store remaining number of character blocks spanned by Magic Knight vertically to check</td>
</tr>
<tr>
<td class="address-1"><span id="27742"></span>27742</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store predicted x- and y-coordinates (characters)</td>
</tr>
<tr>
<td class="address-1"><span id="27743"></span>27743</td>
<td class="instruction">CALL <a href="36586.html">36586</a></td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at terrain interaction data for character coordinates x=<span class="register">C</span>, y=<span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="27746"></span>27746</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore predicted x- and y-coordinates (characters)</td>
</tr>
<tr>
<td class="address-1"><span id="27747"></span>27747</td>
<td class="instruction">BIT 5,(HL)</td>
<td class="comment-1" rowspan="1">If bit 5 of terrain data is set (i.e. Magic Knight cannot pass block horizontally)...</td>
</tr>
<tr>
<td class="address-1"><span id="27749"></span>27749</td>
<td class="instruction">JR NZ,27758</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27666.html#27758">27758</a></td>
</tr>
<tr>
<td class="address-1"><span id="27751"></span>27751</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Advance check to next character down</td>
</tr>
<tr>
<td class="address-1"><span id="27752"></span>27752</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore remaining number of character blocks spanned by Magic Knight vertically to check</td>
</tr>
<tr>
<td class="address-1"><span id="27753"></span>27753</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrease count of remaining character blocks by one</td>
</tr>
<tr>
<td class="address-1"><span id="27754"></span>27754</td>
<td class="instruction">JR NZ,27741</td>
<td class="comment-1" rowspan="1">Loop back to 27741 to check next block down</td>
</tr>
<tr>
<td class="address-1"><span id="27756"></span>27756</td>
<td class="instruction">JR 27767</td>
<td class="comment-1" rowspan="1">Skip over setting Magic Knight's can't-move-left flag as there are no obstructions to the left</td>
</tr>
<tr>
<td class="address-2"><span id="27758"></span>27758</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span></td>
</tr>
<tr>
<td class="address-1"><span id="27759"></span>27759</td>
<td class="instruction">LD A,(23470)</td>
<td class="comment-1" rowspan="1">Set Magic-Knight-can't-move-left flag...</td>
</tr>
<tr>
<td class="address-1"><span id="27762"></span>27762</td>
<td class="instruction">OR 1</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27764"></span>27764</td>
<td class="instruction">LD (23470),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="27767"></span>27767</td>
<td class="instruction">LD A,(23478)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's predicted x-coordinate (pixels) into <span class="register">A</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27770"></span>27770</td>
<td class="instruction">ADD A,15</td>
<td class="comment-1" rowspan="1">...and add 15</td>
</tr>
<tr>
<td class="address-1"><span id="27772"></span>27772</td>
<td class="instruction">CALL <a href="30123.html">30123</a></td>
<td class="comment-1" rowspan="1">Divide <span class="register">A</span> by eight, rounding down to nearest integer...</td>
</tr>
<tr>
<td class="address-1"><span id="27775"></span>27775</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">...and load into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="27776"></span>27776</td>
<td class="instruction">LD A,(23479)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's predicted y-coordinate (characters) into <span class="register">B</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27779"></span>27779</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27780"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="27666.html#27780">27780</a> represents the number of character blocks to check. This is modified by the instruction at <a href="27666.html#27711">27711</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27780"></span>27780</td>
<td class="instruction">LD A,0</td>
<td class="comment-1" rowspan="1">Load number of characters (vertically) to check for impassibility</td>
</tr>
<tr>
<td class="address-2"><span id="27782"></span>27782</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Store <span class="register">AF</span> (remaining number of vertical characters to check for impassibility)</td>
</tr>
<tr>
<td class="address-1"><span id="27783"></span>27783</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Store <span class="register">BC</span> (predicted y- and x-coordinates in characters)</td>
</tr>
<tr>
<td class="address-1"><span id="27784"></span>27784</td>
<td class="instruction">CALL <a href="36586.html">36586</a></td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at terrain interaction data for character coordinates x=<span class="register">C</span>, y=<span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="27787"></span>27787</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore predicted coordinates</td>
</tr>
<tr>
<td class="address-1"><span id="27788"></span>27788</td>
<td class="instruction">BIT 5,(HL)</td>
<td class="comment-1" rowspan="1">If bit 5 is set (i.e. Magic Knight cannot pass block horizontally)...</td>
</tr>
<tr>
<td class="address-1"><span id="27790"></span>27790</td>
<td class="instruction">JR NZ,27799</td>
<td class="comment-1" rowspan="1">...jump ahead to <a href="27666.html#27799">27799</a></td>
</tr>
<tr>
<td class="address-1"><span id="27792"></span>27792</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Increase y-coordinate by one character</td>
</tr>
<tr>
<td class="address-1"><span id="27793"></span>27793</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span></td>
</tr>
<tr>
<td class="address-1"><span id="27794"></span>27794</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrease number of remaining blocks to check</td>
</tr>
<tr>
<td class="address-1"><span id="27795"></span>27795</td>
<td class="instruction">JR NZ,27782</td>
<td class="comment-1" rowspan="1">If number of remaining blocks to check is not zero then loop back to <a href="27666.html#27782">27782</a></td>
</tr>
<tr>
<td class="address-1"><span id="27797"></span>27797</td>
<td class="instruction">JR 27808</td>
<td class="comment-1" rowspan="1">Exit routine</td>
</tr>
<tr>
<td class="address-2"><span id="27799"></span>27799</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore <span class="register">AF</span></td>
</tr>
<tr>
<td class="address-1"><span id="27800"></span>27800</td>
<td class="instruction">LD A,(23470)</td>
<td class="comment-1" rowspan="1">Set Magic-Knight-can't-move-right flag...</td>
</tr>
<tr>
<td class="address-1"><span id="27803"></span>27803</td>
<td class="instruction">OR 2</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27805"></span>27805</td>
<td class="instruction">LD (23470),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="27808"></span>27808</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27495.html">27495</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27666">Map</a></td>
<td class="next">
Next: <a href="27809.html">27809</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 08/05/2021</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2010-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>