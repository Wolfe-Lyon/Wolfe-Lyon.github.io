<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 55077</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54996.html">54996</a>
</td>
<td class="up">Up: <a href="../maps/all.html#55077">Map</a></td>
<td class="next">
Next: <a href="55218.html">55218</a>
</td>
</tr>
</table>
<div class="description">55077: Update all characters' stats (deteriorate or regenerate) and wake up / send to sleep if required</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="54996.html">54996</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="55077"></span>55077</td>
<td class="instruction">LD DE,8</td>
<td class="comment-1" rowspan="1">Load <span class="register">DE</span> with 8 (as data is 8 bytes long)</td>
</tr>
<tr>
<td class="address-1"><span id="55080"></span>55080</td>
<td class="instruction">LD HL,55490</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at Gimbal's stat regeneration data</td>
</tr>
<tr>
<td class="address-1"><span id="55083"></span>55083</td>
<td class="instruction">LD IX,25323</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> to Gimbal's current stats</td>
</tr>
<tr>
<td class="address-1"><span id="55087"></span>55087</td>
<td class="instruction">LD B,7</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 7 (as there are 7 characters to which this routine applies - Banshee is excluded)</td>
</tr>
<tr>
<td class="address-1"><span id="55089"></span>55089</td>
<td class="instruction">LD A,(23468)</td>
<td class="comment-1" rowspan="1">If Gimbal-is-free flag is set...</td>
</tr>
<tr>
<td class="address-1"><span id="55092"></span>55092</td>
<td class="instruction">AND 1</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55094"></span>55094</td>
<td class="instruction">JR NZ,55104</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="55077.html#55104">55104</a></td>
</tr>
<tr>
<td class="address-1"><span id="55096"></span>55096</td>
<td class="instruction">LD HL,55498</td>
<td class="comment-1" rowspan="1">Else point <span class="register">HL</span> at Thor's stat regeneration data</td>
</tr>
<tr>
<td class="address-1"><span id="55099"></span>55099</td>
<td class="instruction">LD IX,25331</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> to Thor's current stats</td>
</tr>
<tr>
<td class="address-1"><span id="55103"></span>55103</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="1">Decrease <span class="register">B</span> to 6 as, since Gimbal is not free, he is not included in this routine's function</td>
</tr>
<tr>
<td class="address-2"><span id="55104"></span>55104</td>
<td class="instruction">BIT 7,(IX+6)</td>
<td class="comment-1" rowspan="1">If current character is awake...</td>
</tr>
<tr>
<td class="address-1"><span id="55108"></span>55108</td>
<td class="instruction">JR Z,55114</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="55077.html#55114">55114</a></td>
</tr>
<tr>
<td class="address-1"><span id="55110"></span>55110</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> by four bytes to stat deterioration data...</td>
</tr>
<tr>
<td class="address-1"><span id="55111"></span>55111</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55112"></span>55112</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55113"></span>55113</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="55114"></span>55114</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Load stat change value into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="55115"></span>55115</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Load current character's strength into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55118"></span>55118</td>
<td class="instruction">CALL <a href="55219.html">55219</a></td>
<td class="comment-1" rowspan="1">Update character's strength as they tire (awake) or regenerate (asleep)...</td>
</tr>
<tr>
<td class="address-1"><span id="55121"></span>55121</td>
<td class="instruction">LD (IX+0),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55124"></span>55124</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to next (happiness) data</td>
</tr>
<tr>
<td class="address-1"><span id="55125"></span>55125</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Load stat change value into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="55126"></span>55126</td>
<td class="instruction">LD A,(IX+1)</td>
<td class="comment-1" rowspan="1">Load current character's happiness into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55129"></span>55129</td>
<td class="instruction">CALL <a href="55219.html">55219</a></td>
<td class="comment-1" rowspan="1">Update character's happiness as they tire (awake) or regenerate (asleep)...</td>
</tr>
<tr>
<td class="address-1"><span id="55132"></span>55132</td>
<td class="instruction">LD (IX+1),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55135"></span>55135</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to next (stamina) data</td>
</tr>
<tr>
<td class="address-1"><span id="55136"></span>55136</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Load stat change value into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="55137"></span>55137</td>
<td class="instruction">LD A,(IX+2)</td>
<td class="comment-1" rowspan="1">Load current character's stamina into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55140"></span>55140</td>
<td class="instruction">CALL <a href="55219.html">55219</a></td>
<td class="comment-1" rowspan="1">Update character's stamina as they tire (awake) or regenerate (asleep)...</td>
</tr>
<tr>
<td class="address-1"><span id="55143"></span>55143</td>
<td class="instruction">LD (IX+2),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55146"></span>55146</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to next (spell power) data</td>
</tr>
<tr>
<td class="address-1"><span id="55147"></span>55147</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1">Load stat change value into <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="55148"></span>55148</td>
<td class="instruction">LD A,(IX+3)</td>
<td class="comment-1" rowspan="1">Load current character's spell power into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55151"></span>55151</td>
<td class="instruction">CALL <a href="55219.html">55219</a></td>
<td class="comment-1" rowspan="1">Update character's spell power as they tire (awake) or regenerate (asleep)...</td>
</tr>
<tr>
<td class="address-1"><span id="55154"></span>55154</td>
<td class="instruction">LD (IX+3),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55157"></span>55157</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span> to next block of data</td>
</tr>
<tr>
<td class="address-1"><span id="55158"></span>55158</td>
<td class="instruction">BIT 7,(IX+6)</td>
<td class="comment-1" rowspan="1">If current character is asleep...</td>
</tr>
<tr>
<td class="address-1"><span id="55162"></span>55162</td>
<td class="instruction">JR NZ,55168</td>
<td class="comment-1" rowspan="1">...then we have already moved into data for next character, so skip ahead to <a href="55077.html#55168">55168</a></td>
</tr>
<tr>
<td class="address-1"><span id="55164"></span>55164</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Else, we are now in same character's "asleep" data, so need to advance <span class="register">HL</span> by four bytes to get to next character's data...</td>
</tr>
<tr>
<td class="address-1"><span id="55165"></span>55165</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55166"></span>55166</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="55167"></span>55167</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="55168"></span>55168</td>
<td class="instruction">ADD IX,DE</td>
<td class="comment-1" rowspan="1">Advance <span class="register">IX</span> by eight bytes to next character's stats</td>
</tr>
<tr>
<td class="address-1"><span id="55170"></span>55170</td>
<td class="instruction">DJNZ 55104</td>
<td class="comment-1" rowspan="1">Loop back to 55104</td>
</tr>
<tr>
<td class="address-1"><span id="55172"></span>55172</td>
<td class="instruction">LD DE,8</td>
<td class="comment-1" rowspan="1">Load <span class="register">DE</span> with 8</td>
</tr>
<tr>
<td class="address-1"><span id="55175"></span>55175</td>
<td class="instruction">LD IX,25323</td>
<td class="comment-1" rowspan="1">Point <span class="register">IX</span> to Gimbal's current stats</td>
</tr>
<tr>
<td class="address-1"><span id="55179"></span>55179</td>
<td class="instruction">LD B,7</td>
<td class="comment-1" rowspan="1">Load <span class="register">B</span> with 7 (as there are 7 characters to which this routine applies - Banshee is excluded)</td>
</tr>
<tr>
<td class="address-1"><span id="55181"></span>55181</td>
<td class="instruction">LD C,0</td>
<td class="comment-1" rowspan="1">Load <span class="register">C</span> with zero (to denote first character, Gimbal)</td>
</tr>
<tr>
<td class="address-2"><span id="55183"></span>55183</td>
<td class="instruction">LD A,(IX+2)</td>
<td class="comment-1" rowspan="1">Load current character's stamina into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55186"></span>55186</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If stamina is not zero...</td>
</tr>
<tr>
<td class="address-1"><span id="55187"></span>55187</td>
<td class="instruction">JP NZ,55196</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="55077.html#55196">55196</a></td>
</tr>
<tr>
<td class="address-1"><span id="55190"></span>55190</td>
<td class="instruction">SET 7,(IX+6)</td>
<td class="comment-1" rowspan="1">Else send character to sleep</td>
</tr>
<tr>
<td class="address-1"><span id="55194"></span>55194</td>
<td class="instruction">JR 55205</td>
<td class="comment-1" rowspan="1">Skip ahead to <a href="55077.html#55205">55205</a></td>
</tr>
<tr>
<td class="address-2"><span id="55196"></span>55196</td>
<td class="instruction">CP 100</td>
<td class="comment-1" rowspan="1">If stamina is not 100...</td>
</tr>
<tr>
<td class="address-1"><span id="55198"></span>55198</td>
<td class="instruction">JP NZ,55205</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="55077.html#55205">55205</a></td>
</tr>
<tr>
<td class="address-1"><span id="55201"></span>55201</td>
<td class="instruction">RES 7,(IX+6)</td>
<td class="comment-1" rowspan="1">Else wake character up</td>
</tr>
<tr>
<td class="address-2"><span id="55205"></span>55205</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Load character's strength into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="55208"></span>55208</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If strength is zero...</td>
</tr>
<tr>
<td class="address-1"><span id="55209"></span>55209</td>
<td class="instruction">JP Z,<a href="55461.html">55461</a></td>
<td class="comment-1" rowspan="1">...then the character has starved to death, so jump to <a href="55461.html">55461</a></td>
</tr>
<tr>
<td class="address-1"><span id="55212"></span>55212</td>
<td class="instruction">ADD IX,DE</td>
<td class="comment-1" rowspan="1">Advance <span class="register">IX</span> to next character's stats</td>
</tr>
<tr>
<td class="address-1"><span id="55214"></span>55214</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Increase <span class="register">C</span> for next character</td>
</tr>
<tr>
<td class="address-1"><span id="55215"></span>55215</td>
<td class="instruction">DJNZ 55183</td>
<td class="comment-1" rowspan="1">Loop back to 55183 for next character</td>
</tr>
<tr>
<td class="address-1"><span id="55217"></span>55217</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="54996.html">54996</a>
</td>
<td class="up">Up: <a href="../maps/all.html#55077">Map</a></td>
<td class="next">
Next: <a href="55218.html">55218</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2010-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>