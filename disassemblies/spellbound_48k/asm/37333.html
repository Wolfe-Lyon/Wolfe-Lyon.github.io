<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 37333</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="37147.html">37147</a></span></td>
<td class="up">Up: <a href="../maps/all.html#37333">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="37472.html">37472</a></span></td>
</tr>
</table>
<div class="description">37333: Process Keyboard / Joystick Input on a Menu</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="26673.html">26673</a>, <a href="31153.html">31153</a>, <a href="31370.html">31370</a>, <a href="31636.html">31636</a>, <a href="32655.html">32655</a>, <a href="33663.html">33663</a>, <a href="34914.html">34914</a>, <a href="35141.html">35141</a>, <a href="35293.html">35293</a> and <a href="38725.html">38725</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-1">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">ASCII code of letter shortcut that has been selected on menu</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="37333"></span>37333</td>
<td class="instruction">LD A,(37084)</td>
<td class="comment-11" rowspan="1">Check whether to draw hand cursor on menu...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37336"></span>37336</td>
<td class="instruction">CP 105</td>
<td class="comment-11" rowspan="1">...and if not...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37338"></span>37338</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">...return</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37339"></span>37339</td>
<td class="instruction">LD A,(23493)</td>
<td class="comment-11" rowspan="1">Load x-coordinate of current window's top-left corner into A</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37342"></span>37342</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Increase by one character...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37343"></span>37343</td>
<td class="instruction">LD (23490),A</td>
<td class="comment-11" rowspan="1">...and store for later use</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37346"></span>37346</td>
<td class="instruction">LD A,(23489)</td>
<td class="comment-11" rowspan="1">Load starting y-coordinate of hand cursor into A...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37349"></span>37349</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">and copy into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37350"></span>37350</td>
<td class="instruction">LD A,(23494)</td>
<td class="comment-11" rowspan="1">Load y-coordinate of current window's top-left corner into A...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37353"></span>37353</td>
<td class="instruction">ADD A,B</td>
<td class="comment-11" rowspan="1">...add to B...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37354"></span>37354</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...and multiply by 8 to get y-coordinate of top of hand cursor in pixels...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37355"></span>37355</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37356"></span>37356</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37357"></span>37357</td>
<td class="instruction">LD (23491),A</td>
<td class="comment-11" rowspan="1">Then store for later use</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37360"></span>37360</td>
<td class="instruction">LD A,(23496)</td>
<td class="comment-11" rowspan="1">Load y-coordinate of current window's bottom edge into A...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37363"></span>37363</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...multiply by eight...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37364"></span>37364</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37365"></span>37365</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37366"></span>37366</td>
<td class="instruction">ADD A,7</td>
<td class="comment-11" rowspan="1">...then add 7 to get y-coordinate of absolute bottom of window in pixels</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37368"></span>37368</td>
<td class="instruction">LD (23492),A</td>
<td class="comment-11" rowspan="1">...and store for later</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37371"></span>37371</td>
<td class="instruction">LD A,(23494)</td>
<td class="comment-11" rowspan="1">Load y-coordinate of current window's top-left corner into A...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37374"></span>37374</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">...and copy into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37375"></span>37375</td>
<td class="instruction">LD A,(23496)</td>
<td class="comment-11" rowspan="1">Load y-coordinate of current window's bottom-right corner into A...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37378"></span>37378</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1">...subtract B...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37379"></span>37379</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">...then subtract one to get height of window, not including frame</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37380"></span>37380</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy this into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37381"></span>37381</td>
<td class="instruction">LD A,(23489)</td>
<td class="comment-11" rowspan="1">Load A with initial y-coordinate of hand cursor relative to current window...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37384"></span>37384</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1">...subtract B...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37385"></span>37385</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="1">...and negate to give vertical distance available to hand cursor to move</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37387"></span>37387</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">Multiply this by eight to convert from chars to pixels...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37388"></span>37388</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37389"></span>37389</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="1">...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37390"></span>37390</td>
<td class="instruction">LD (23471),A</td>
<td class="comment-11" rowspan="1">...and store at 23471</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37393"></span>37393</td>
<td class="instruction">CALL <a href="37571.html">37571</a></td>
<td class="comment-11" rowspan="1">Apply FLASH attribute to menu letter shortcut next to hand menu cursor</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="37396"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="37497.html">37497</a> and <a href="37523.html">37523</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="37396"></span>37396</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Set A to zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37397"></span>37397</td>
<td class="instruction">LD (23560),A</td>
<td class="comment-11" rowspan="1">Clear last pressed key</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37400"></span>37400</td>
<td class="instruction">HALT</td>
<td class="comment-11" rowspan="1">Wait for interrupt / reset</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37401"></span>37401</td>
<td class="instruction">CALL <a href="37876.html">37876</a></td>
<td class="comment-11" rowspan="1">Capture keyboard input, or jump to joystick reading routine</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37404"></span>37404</td>
<td class="instruction">BIT 2,A</td>
<td class="comment-11" rowspan="1">If "up" pressed then...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37406"></span>37406</td>
<td class="instruction">JP NZ,<a href="37497.html">37497</a></td>
<td class="comment-11" rowspan="1">...jump to routine to move Hand Cursor up and update flashing menu shortcut</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37409"></span>37409</td>
<td class="instruction">BIT 3,A</td>
<td class="comment-11" rowspan="1">If "down" pressed then...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37411"></span>37411</td>
<td class="instruction">JP NZ,<a href="37523.html">37523</a></td>
<td class="comment-11" rowspan="1">...jump to routine to move Hand Cursor down and update flashing menu shortcut</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37414"></span>37414</td>
<td class="instruction">BIT 4,A</td>
<td class="comment-11" rowspan="1">If "fire" pressed then...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37416"></span>37416</td>
<td class="instruction">JP NZ,<a href="37552.html">37552</a></td>
<td class="comment-11" rowspan="1">...jump to routine to load A with ASCII code of shortcut for selected item in menu</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37419"></span>37419</td>
<td class="instruction">LD A,(23560)</td>
<td class="comment-11" rowspan="1">Load last pressed key (system variable) into A...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37422"></span>37422</td>
<td class="instruction">OR A</td>
<td class="comment-11" rowspan="1">...and if this is zero (i.e. no key pressed)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37423"></span>37423</td>
<td class="instruction">JR Z,37396</td>
<td class="comment-11" rowspan="1">...loop back to <a href="37333.html#37396">37396</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37425"></span>37425</td>
<td class="instruction">LD (37457),A</td>
<td class="comment-11" rowspan="1">Store pressed key further on in this routine</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37428"></span>37428</td>
<td class="instruction">LD A,(23491)</td>
<td class="comment-11" rowspan="1">Load A with y-coordinate of top of hand cursor (pixels)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37431"></span>37431</td>
<td class="instruction">CALL <a href="30123.html">30123</a></td>
<td class="comment-11" rowspan="1">...and divide by eight to get top of cursor in characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37434"></span>37434</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Add one to this</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37435"></span>37435</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy into B</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37436"></span>37436</td>
<td class="instruction">LD A,(23493)</td>
<td class="comment-11" rowspan="1">Load A with x-coordinate of left edge of current window (characters)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37439"></span>37439</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Copy into C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37440"></span>37440</td>
<td class="instruction">LD A,(23492)</td>
<td class="comment-11" rowspan="1">Load A with y-coordinate of bottom of window (including frame) (pixels)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37443"></span>37443</td>
<td class="instruction">CALL <a href="30123.html">30123</a></td>
<td class="comment-11" rowspan="1">Divide by eight to get coordinate in characters...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37446"></span>37446</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">...and add one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="37447"></span>37447</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Switch A register</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37448"></span>37448</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Store B and C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37449"></span>37449</td>
<td class="instruction">CALL <a href="36551.html">36551</a></td>
<td class="comment-11" rowspan="1">Move Virtual Bitmap Cursor to Display File address for coordinates (C,B)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37452"></span>37452</td>
<td class="instruction">CALL <a href="37613.html">37613</a></td>
<td class="comment-11" rowspan="1">Load ASCII code of character in Display File address stored at 36488 into A (i.e. letter shortcut for command at current y-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37455"></span>37455</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore coordinates to BC</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="37456"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="37333.html#37456">37456</a> represents the index of the key that was pressed. This is modified by the instruction at <a href="37333.html#37425">37425</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37456"></span>37456</td>
<td class="instruction">CP 0</td>
<td class="comment-11" rowspan="1">If last-pressed key matches this letter shortcut...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37458"></span>37458</td>
<td class="instruction">JR Z,37468</td>
<td class="comment-11" rowspan="1">...then jump to end of routine</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37460"></span>37460</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">...else increase y-coordinate by one (i.e. move onto next row of menu)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37461"></span>37461</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">Switch A register...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37462"></span>37462</td>
<td class="instruction">CP B</td>
<td class="comment-11" rowspan="1">...and if current y-coordinate is less than this (i.e. we haven't yet reached the last command in this window)...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37463"></span>37463</td>
<td class="instruction">JR NZ,37447</td>
<td class="comment-11" rowspan="1">...then loop back to <a href="37333.html#37447">37447</a> for next row of text in window</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37465"></span>37465</td>
<td class="instruction">JP 37396</td>
<td class="comment-11" rowspan="1">Repeat process for next key-press</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="37468"></span>37468</td>
<td class="instruction">CALL <a href="37472.html">37472</a></td>
<td class="comment-11" rowspan="1">Wait for keyboard to be released</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="37471"></span>37471</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="37147.html">37147</a></span></td>
<td class="up">Up: <a href="../maps/all.html#37333">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="37472.html">37472</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 02/06/2018</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2017 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 6.4.</div>
</footer>
</body>
</html>