<!DOCTYPE html>
<html>
<head>
<title>Spellbound (48k): Routine at 27495</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../common.css" />
<link rel="stylesheet" type="text/css" href="../spectrum.css" />
<link rel="stylesheet" type="text/css" href="../spellbound.css" />
<script type="text/javascript" src="../js/require.js"></script>
<script type="text/javascript" src="../js/main.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27490.html">27490</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27495">Map</a></td>
<td class="next">
Next: <a href="27666.html">27666</a>
</td>
</tr>
</table>
<div class="description">27495: Handle Magic Knight's falls</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="27176.html">27176</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27495"></span>27495</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27496"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="27490.html">27490</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="27496"></span>27496</td>
<td class="instruction">LD (27531),A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27499"></span>27499</td>
<td class="instruction">LD HL,41872</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at end of table of y-velocities sequence for jumping and falling</td>
</tr>
<tr>
<td class="address-1"><span id="27502"></span>27502</td>
<td class="instruction">LD (41857),HL</td>
<td class="comment-1" rowspan="1">Store current position at 41857</td>
</tr>
<tr>
<td class="address-2"><span id="27505"></span>27505</td>
<td class="instruction">LD A,(23470)</td>
<td class="comment-1" rowspan="1">If Magic Knight's movement flags are unset...</td>
</tr>
<tr>
<td class="address-1"><span id="27508"></span>27508</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27509"></span>27509</td>
<td class="instruction">JR Z,27515</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27495.html#27515">27515</a></td>
</tr>
<tr>
<td class="address-1"><span id="27511"></span>27511</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27512"></span>27512</td>
<td class="instruction">LD (27531),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-2"><span id="27515"></span>27515</td>
<td class="instruction">LD HL,(41857)</td>
<td class="comment-1" rowspan="1">Load current position in y-velocities table into <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="27518"></span>27518</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Load current y-velocity from table into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27519"></span>27519</td>
<td class="instruction">CP 7</td>
<td class="comment-1" rowspan="1">If velocity is 7...</td>
</tr>
<tr>
<td class="address-1"><span id="27521"></span>27521</td>
<td class="instruction">JR Z,27527</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="28510.html#28527">28527</a></td>
</tr>
<tr>
<td class="address-1"><span id="27523"></span>27523</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Step pointer back one byte in y-velocities table</td>
</tr>
<tr>
<td class="address-1"><span id="27524"></span>27524</td>
<td class="instruction">LD (41857),HL</td>
<td class="comment-1" rowspan="1">Store pointer</td>
</tr>
<tr>
<td class="address-2"><span id="27527"></span>27527</td>
<td class="instruction">LD (25392),A</td>
<td class="comment-1" rowspan="1">Load last y-velocity read from table into Magic Knight's y-velocity</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27530"></span>
<div class="comments">
<div class="paragraph">
The operand of the instruction at <a href="27495.html#27530">27530</a> represents the x-velocity value stored previously. This is modified by the instructions at <a href="27495.html#27496">27496</a>, <a href="27495.html#27512">27512</a> and <a href="27495.html#27660">27660</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27530"></span>27530</td>
<td class="instruction">LD A,0</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x-velocity...</td>
</tr>
<tr>
<td class="address-1"><span id="27532"></span>27532</td>
<td class="instruction">LD (25391),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27535"></span>27535</td>
<td class="instruction">LD A,(25387)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current x-coordinate into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27538"></span>27538</td>
<td class="instruction">ADD A,4</td>
<td class="comment-1" rowspan="1">Add 4 to x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="27540"></span>27540</td>
<td class="instruction">CALL <a href="30123.html">30123</a></td>
<td class="comment-1" rowspan="1">Divide x-coordinate by eight, rounding down to nearest integer</td>
</tr>
<tr>
<td class="address-1"><span id="27543"></span>27543</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Load result (Magic Knight's x-coordinate in characters) into <span class="register">C</span>, setting <span class="register">B</span> to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27544"></span>27544</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27546"></span>27546</td>
<td class="instruction">LD A,(25388)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current y-coordinate into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27549"></span>27549</td>
<td class="instruction">AND 7</td>
<td class="comment-1" rowspan="1">If y-coordinate is a multiple of eight...</td>
</tr>
<tr>
<td class="address-1"><span id="27551"></span>27551</td>
<td class="instruction">JR Z,27555</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27495.html#27555">27555</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="27553"></span>
<div class="comments">
<div class="paragraph">
y-coordinate is not a multiple of eight
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="27553"></span>27553</td>
<td class="instruction">LD B,8</td>
<td class="comment-1" rowspan="1">Set <span class="register">B</span> to 8, as we need to look one character block lower due to Magic Knight spanning five, rather than four, characters</td>
</tr>
<tr>
<td class="address-2"><span id="27555"></span>27555</td>
<td class="instruction">LD A,(25388)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current y-coordinate into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27558"></span>27558</td>
<td class="instruction">ADD A,B</td>
<td class="comment-1" rowspan="1">Add <span class="register">B</span> to current y-coordinate (i.e. y-coordinate of highest full character block spanned by Magic Knight)</td>
</tr>
<tr>
<td class="address-1"><span id="27559"></span>27559</td>
<td class="instruction">ADD A,32</td>
<td class="comment-1" rowspan="1">Add 32 (as Magic Knight is 32 pixels high, so now y-coordinate of highest full character block not occupied by Magic Knight)</td>
</tr>
<tr>
<td class="address-1"><span id="27561"></span>27561</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">Divide result by 8, removing remainder...</td>
</tr>
<tr>
<td class="address-1"><span id="27562"></span>27562</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27563"></span>27563</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27564"></span>27564</td>
<td class="instruction">AND 31</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27566"></span>27566</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Load result (y-coordinate in characters) into <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="27567"></span>27567</td>
<td class="instruction">CALL <a href="36586.html">36586</a></td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at terrain interaction data for character coordinates x=<span class="register">C</span>, y=<span class="register">B</span> (block that Magic Knight is "falling through")</td>
</tr>
<tr>
<td class="address-1"><span id="27570"></span>27570</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">If block cannot be passed vertically (i.e. Magic Knight has landed)...</td>
</tr>
<tr>
<td class="address-1"><span id="27572"></span>27572</td>
<td class="instruction">JP NZ,27627</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27495.html#27627">27627</a></td>
</tr>
<tr>
<td class="address-1"><span id="27575"></span>27575</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance to next block right (as Magic Knight is two character blocks wide) in terrain interaction table</td>
</tr>
<tr>
<td class="address-1"><span id="27576"></span>27576</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">If block cannot be passed vertically (i.e. Magic Knight has landed)...</td>
</tr>
<tr>
<td class="address-1"><span id="27578"></span>27578</td>
<td class="instruction">JP NZ,27627</td>
<td class="comment-1" rowspan="1">...then skip ahead to <a href="27495.html#27627">27627</a></td>
</tr>
<tr>
<td class="address-1"><span id="27581"></span>27581</td>
<td class="instruction">CALL <a href="27666.html">27666</a></td>
<td class="comment-1" rowspan="1">Kill Magic Knight's x-velocity if he cannot horizontally pass through a block beside him</td>
</tr>
<tr>
<td class="address-1"><span id="27584"></span>27584</td>
<td class="instruction">LD A,(25391)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's x-velocity into <span class="register">B</span>...</td>
</tr>
<tr>
<td class="address-1"><span id="27587"></span>27587</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27588"></span>27588</td>
<td class="instruction">LD A,(23470)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's movement flags into <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="27591"></span>27591</td>
<td class="instruction">XOR B</td>
<td class="comment-1" rowspan="1">Check:</td>
</tr>
<tr>
<td class="address-1"><span id="27592"></span>27592</td>
<td class="instruction">CP 255</td>
<td class="comment-1" rowspan="1">If x-velocity is -2 (left), and Magic Knight can't move left...</td>
</tr>
<tr>
<td class="address-1"><span id="27594"></span>27594</td>
<td class="instruction">JP Z,27656</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27495.html#27656">27656</a></td>
</tr>
<tr>
<td class="address-1"><span id="27597"></span>27597</td>
<td class="instruction">CP 253</td>
<td class="comment-1" rowspan="1">If x-velocity is -2 (left), and Magic Knight can't move left or right...</td>
</tr>
<tr>
<td class="address-1"><span id="27599"></span>27599</td>
<td class="instruction">JP Z,27656</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27495.html#27656">27656</a></td>
</tr>
<tr>
<td class="address-1"><span id="27602"></span>27602</td>
<td class="instruction">CP 1</td>
<td class="comment-1" rowspan="1">If x-velocity is +2 (right), and Magic Knight can't move left or right...</td>
</tr>
<tr>
<td class="address-1"><span id="27604"></span>27604</td>
<td class="instruction">JP Z,27656</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27495.html#27656">27656</a></td>
</tr>
<tr>
<td class="address-1"><span id="27607"></span>27607</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="1">If x-velocity is +2 (right), and Magic Knight can't move right...</td>
</tr>
<tr>
<td class="address-1"><span id="27608"></span>27608</td>
<td class="instruction">JP Z,27656</td>
<td class="comment-1" rowspan="1">...then jump ahead to <a href="27495.html#27656">27656</a></td>
</tr>
<tr>
<td class="address-2"><span id="27611"></span>27611</td>
<td class="instruction">CALL <a href="34821.html">34821</a></td>
<td class="comment-1" rowspan="1">Update Magic Knight's current frame based on x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="27614"></span>27614</td>
<td class="instruction">LD (65528),A</td>
<td class="comment-1" rowspan="1">Store frame number at 65528</td>
</tr>
<tr>
<td class="address-1"><span id="27617"></span>27617</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero (index for Magic Knight) and...</td>
</tr>
<tr>
<td class="address-1"><span id="27618"></span>27618</td>
<td class="instruction">CALL <a href="39224.html">39224</a></td>
<td class="comment-1" rowspan="1">...draw Magic Knight (erase old frame and draw new frame)</td>
</tr>
<tr>
<td class="address-1"><span id="27621"></span>27621</td>
<td class="instruction">CALL <a href="29763.html">29763</a></td>
<td class="comment-1" rowspan="1">Run checks and updates (Magic Knight's current room and room-specific routines)</td>
</tr>
<tr>
<td class="address-1"><span id="27624"></span>27624</td>
<td class="instruction">JP 27505</td>
<td class="comment-1" rowspan="1">Loop back to <a href="27495.html#27505">27505</a></td>
</tr>
<tr>
<td class="address-2"><span id="27627"></span>27627</td>
<td class="instruction">LD A,(25388)</td>
<td class="comment-1" rowspan="1">Load Magic Knight's current y-coordinate into <span class="register">A</span> (e.g. 105)</td>
</tr>
<tr>
<td class="address-1"><span id="27630"></span>27630</td>
<td class="instruction">AND 15</td>
<td class="comment-1" rowspan="1">Retain only pixel-within-two-characters component (e.g. 9 pixels down the pair of character blocks)</td>
</tr>
<tr>
<td class="address-1"><span id="27632"></span>27632</td>
<td class="instruction">NEG</td>
<td class="comment-1" rowspan="1">Negate (i.e. -9 pixels)</td>
</tr>
<tr>
<td class="address-1"><span id="27634"></span>27634</td>
<td class="instruction">AND 15</td>
<td class="comment-1" rowspan="1">Retain only pixel-within-two-characters component (e.g. 7 pixels up the pair of character blocks, or 7 pixels down to the ground)</td>
</tr>
<tr>
<td class="address-1"><span id="27636"></span>27636</td>
<td class="instruction">LD (25392),A</td>
<td class="comment-1" rowspan="1">Set Magic Knight's y-velocity so that it will take his feet to the ground</td>
</tr>
<tr>
<td class="address-1"><span id="27639"></span>27639</td>
<td class="instruction">LD A,(65528)</td>
<td class="comment-1" rowspan="1">Set Magic Knight's frame number to match stored value...</td>
</tr>
<tr>
<td class="address-1"><span id="27642"></span>27642</td>
<td class="instruction">LD (25390),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27645"></span>27645</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set <span class="register">A</span> to zero (Magic Knight) and...</td>
</tr>
<tr>
<td class="address-1"><span id="27646"></span>27646</td>
<td class="instruction">CALL <a href="39224.html">39224</a></td>
<td class="comment-1" rowspan="1">...draw Magic Knight (erase old frame and draw new frame)</td>
</tr>
<tr>
<td class="address-1"><span id="27649"></span>27649</td>
<td class="instruction">LD HL,0</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x- and y-velocities to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27652"></span>27652</td>
<td class="instruction">LD (25391),HL</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27655"></span>27655</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return (Magic Knight has landed)</td>
</tr>
<tr>
<td class="address-2"><span id="27656"></span>27656</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set Magic Knight's x-velocity to zero...</td>
</tr>
<tr>
<td class="address-1"><span id="27657"></span>27657</td>
<td class="instruction">LD (25391),A</td>
<td class="comment-1" rowspan="1">...</td>
</tr>
<tr>
<td class="address-1"><span id="27660"></span>27660</td>
<td class="instruction">LD (27531),A</td>
<td class="comment-1" rowspan="1">Prepare to set Magic Knight's x-velocity to zero</td>
</tr>
<tr>
<td class="address-1"><span id="27663"></span>27663</td>
<td class="instruction">JP 27611</td>
<td class="comment-1" rowspan="1">Jump back to <a href="27495.html#27611">27611</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="27490.html">27490</a>
</td>
<td class="up">Up: <a href="../maps/all.html#27495">Map</a></td>
<td class="next">
Next: <a href="27666.html">27666</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spellbound (48k) RAM Disassembly 10/04/2021</div>
<div class="copyright">&#169; 1985 David Jones / Mastertronic (Spellbound). &#169; 2010-2021 Philip M. Anderson (this disassembly). Contact: weyoun47-AT-gmail.com.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 8.4.</div>
</footer>
</body>
</html>